<!DOCTYPE html>
<html lang="de">
	<head lang="de">
		<link rel="SHORTCUT ICON" href="favicon.ico">
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>EvAB</title>
		<link rel="stylesheet" href="style/jquery.mobile.css">
		<link rel="stylesheet" href="style/themes/gruen.min.css">
		<link rel="stylesheet" href="style/evab.css">
		<link rel="stylesheet" href="style/jquery.mobile.datebox.css">
		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
		<script>window.jQuery || document.write('<script src="src/jquery.js" type="text/javascript"><\/script>');</script>
		<script>
			$(document).on("mobileinit", function () {
				$.mobile.page.prototype.options.degradeInputs.date = 'text';
				$.mobile.page.prototype.options.degradeInputs.time = 'text';
				$.mobile.selectmenu.prototype.options.nativeMenu = false;
				$.event.special.swipe.horizontalDistanceThreshold = 250;
				$.mobile.buttonMarkup.hoverDelay = 0;
			});
		</script>
		<script src="vendor/couchapp/jquery.mobile.js"></script>
	</head>
	<body>
	  	<div data-role="page" id="SignupPage">
			<div data-role="header" data-position="fixed" data-tap-toggle="false">
				<a href="index.html" class="ui-btn ui-btn-inline ui-btn-icon-left ui-corner-all ui-icon-arrow-l ui-btn-icon-notext">zurück</a>
				<h1>Konto erstellen</h1>
			</div>
			<div data-role="content">
				<form id="SignupForm" action="#" method="get" autocomplete="off">
					<div data-role="fieldcontain">
						<label for="su_Email">Email:</label>
						<input id="su_Email" name="Email" type="text" placeholder="(erforderlich)" autofocus required>
					</div>
					<div data-role="fieldcontain">
						<label for="su_Passwort">Passwort:</label>
						<input id="su_Passwort" name="Passwort" type="password" placeholder="(erforderlich)" required>
					</div>
					<div data-role="fieldcontain">
						<label for="Passwort2">Passwort bestätigen:</label>
						<input id="Passwort2" name="Passwort2" type="password" placeholder="(erforderlich)" required>
					</div>
					<p>Vorsicht: Benutzername und Passwort können später nicht mehr geändert werden!</p>
					<p>Es wird eine verschlüsselte Version des Passworts gespeichert. Das Original kennt ausser Ihnen niemand.</p>
					<hr >
					<div data-role="fieldcontain">
						<label for="Autor">Autor:</label>
						<input id="Autor" name="Autor" type="text" placeholder="(erforderlich)" required>
						<p>Beschreiben Sie den Autor so, wie er in den Beobachtungen erscheinen soll. Beispiel: Fritz Muster, Zürich.</p>
					</div>
					<hr >
					<div data-role="fieldcontain">
						<fieldset data-role="controlgroup">
							<legend>Meine Beobachtungen dürfen verwendet werden:</legend>
								<input type="radio" name="Datenverwendung" id="JaAber" value="JaAber" checked="checked">
								<label for="JaAber">ja, nur für Naturschutzzwecke (Standard)*</label>
								<input type="radio" name="Datenverwendung" id="Ja" value="Ja"  >
								<label for="Ja">ja, ohne Einschränkung</label>
								<input type="radio" name="Datenverwendung" id="Nein" value="Nein">
								<label for="Nein">nein</label>
						</fieldset>
					</div>
					<p>* Bei dieser Option werden die <a href="//crsf.ch/documents/download/d/Deontologie_2008_de.pdf" target="_blank">Datenschutzrichtlinien der Schweizerischen Nationalen Datenzentren für Fauna und Flora</a> eingehalten.<br >Die zuständigen Naturschutzstellen von Bund, Kanton und Gemeinden verwenden die Informationen nur für Naturschutzzwecke. Die Daten nicht besonders empfindlicher Arten können in grober räumlicher Auflösung publiziert werden.</p>
				</form>
			</div>
			<div data-role="footer" id="SignupFooter" data-position="fixed" data-tap-toggle="false">
				<div data-role="navbar">
					<ul>
						<li><a href="#" id="SubmitButton" data-icon="check">Konto erstellen</a></li>
					</ul>
				</div><!-- /navbar -->
			</div><!-- /footer -->

			<script src="vendor/couchapp/jquery.mobile.datebox.js"></script>
			<script src="vendor/couchapp/jquery.couch.js"></script>
			<script src="vendor/couchapp/jquery.form.js"></script>
			<script src="vendor/couchapp/evab.js"></script>
			<script src="vendor/couchapp/sha1.js"></script>
			<script src="https://maps.google.com/maps/api/js?sensor=false"></script>
			<script src="vendor/couchapp/markerclusterer.js"></script>
			<script src="vendor/couchapp/markerwithlabel.js"></script>

			<script charset="utf-8">

				$("#SignupPage").on("pageshow", function () {
					// sicherstellen, dass nichts vom letzten User übrig bleibt
					window.em.leereAlleVariabeln();
					// Datenverwendung managen: Wenn der User nichts angibt, jaAber setzen
					localStorage.Datenverwendung = "JaAber";
				});

				$(":jqmData(role='page')").on("pageinit", function () {

					$("#SignupFooter").on("click", "#SubmitButton", function (event) {
						event.preventDefault();
						if (validiereUserSignup()) {
							erstelleKonto();
						}
					});

					$("#SignupForm").on("change", "[name='Datenverwendung']", function () {
						localStorage.Datenverwendung = $(this).attr("id");
					});
				});

				// kontrollierren, ob die erforderlichen Felder etwas enthalten
				// wenn ja wird true retourniert, sonst false
				function validiereUserSignup() {
					var Email, Passwort, Passwort2, Autor;
					Email = $("#su_Email").val();
					Passwort = $("#su_Passwort").val();
					Passwort2 = $("#Passwort2").val();
					Autor = $("#Autor").val();
					if (!Email) {
						window.em.melde("Bitte Email eingeben");
						setTimeout(function() {
							$("#su_Email").focus();
						}, 50);  // need to use a timer so that .blur() can finish before you do .focus()
						return false;
					} else if (!window.em.validateEmail(Email)) {
						window.em.melde("Bitte gültige Email-Adresse eingeben");
						setTimeout(function() {
							$("#su_Email").focus();
						}, 50);  // need to use a timer so that .blur() can finish before you do .focus()
						return false;
					} else if (!Passwort) {
						window.em.melde("Bitte Passwort eingeben");
						setTimeout(function() {
							$("#su_Passwort").focus();
						}, 50);  // need to use a timer so that .blur() can finish before you do .focus()
						return false;
					} else if (!Passwort2) {
						window.em.melde("Bitte Passwort bestätigen");
						setTimeout(function() {
							$("#Passwort2").focus();
						}, 50);  // need to use a timer so that .blur() can finish before you do .focus()
						return false;
					} else if (Passwort !== Passwort2) {
						window.em.melde("Passwort ist falsch bestätigt");
						setTimeout(function() {
							$("#Passwort2").focus();
						}, 50);  // need to use a timer so that .blur() can finish before you do .focus()
						return false;
					} else if (!Autor) {
						window.em.melde("Bitte Autor eingeben");
						setTimeout(function() {
							$("#Autor").focus();
						}, 50);  // need to use a timer so that .blur() can finish before you do .focus()
						return false;
					}
					return true;
				}

				function erstelleKonto() {
					// User in _user eintragen
					$.couch.signup({
							name: $('#su_Email').val()
						}, $('#su_Passwort').val(), {
						success : function (r) {
							localStorage.Email = r.name;
							// Informationen zum User in doc vom typ User eintragen
							window.em.speichereUserInEvab();
						},
						error : function () {
							window.em.melde("Fehler: Das Konto wurde nicht erstellt");
						}
					});
				}
			</script>
		</div>
	</body>
</html>