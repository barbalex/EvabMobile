<!DOCTYPE html>
<html lang="de">
	<head lang="de">
		<link rel="SHORTCUT ICON" href="Bilder/favicon.ico">
		<meta charset=UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>EvAB</title>
		<link rel="stylesheet" href="style/jquery.mobile.css">
		<link rel="stylesheet" href="style/evab.css">
		<style>.ui-icon-evab-location {background-image:url('Bilder/evab-location.png');}</style>
		<link rel="stylesheet" href="style/jquery.mobile.datebox.css">
		<link rel="stylesheet" href="style/jquery.mobile.simpledialog.css">
		<script src="vendor/couchapp/jquery.js"></script>
		<script>
			$(document).on("mobileinit", function () {
				$.mobile.page.prototype.options.degradeInputs.date = 'text';
				$.mobile.page.prototype.options.degradeInputs.time = 'text';
				$.mobile.selectmenu.prototype.options.nativeMenu = false;
				$.event.special.swipe.horizontalDistanceThreshold = 250;
				$.mobile.buttonMarkup.hoverDelay = 0;
			});
		</script>
		<script src="vendor/couchapp/jquery.couch.js"></script>
		<script src="vendor/couchapp/jquery.form.js"></script>
		<script src="vendor/couchapp/jquery.mobile.js"></script>
		<script src="vendor/couchapp/phonegap.js"></script>
		<script src="vendor/couchapp/jquery.mobile.datebox.js"></script>
		<script src="vendor/couchapp/jquery.mobile.simpledialog2.js"></script>
		<script src="vendor/couchapp/evab.js"></script>
		<script src="vendor/couchapp/sha1.js"></script>
		<script src="https://maps.google.com/maps/api/js?sensor=false"></script>
		<script src="vendor/couchapp/markerclusterer.js"></script>
		<script src="vendor/couchapp/markerwithlabel.js"></script>
	</head>
	<body>
	  	<div data-role="page" id="SignupPage">
			<div data-role="header" data-position="fixed" data-tap-toggle="false">
				<a href="index.html" data-role="button" data-icon="arrow-l" data-iconpos="notext">zurück</a>
				<h1>Konto erstellen</h1>
			</div>
			<div data-role="content">
				<form id="SignupForm" action="#" method="get" autocomplete="off">
					<div data-role="fieldcontain">
						<label for="UserName">Benutzername:</label>
						<input id="UserName" name="UserName" type="text" placeholder="(erforderlich)" autofocus required>
					</div>
					<div data-role="fieldcontain">
						<label for="Passwort">Passwort:</label>
						<input id="Passwort" name="Passwort" type="password" placeholder="(erforderlich)" required>
					</div>
					<div data-role="fieldcontain">
						<label for="Passwort2">Passwort bestätigen:</label>
						<input id="Passwort2" name="Passwort2" type="password" placeholder="(erforderlich)" required>
					</div>
					<p>Vorsicht: Benutzername und Passwort können später nicht mehr geändert werden!</p>
					<p>Es wird eine verschlüsselte Version des Passworts gespeichert. Das Original kennt ausser Ihnen niemand.</p>
					<hr >
					<div data-role="fieldcontain">
						<label for="Autor">Autor:</label>
						<input id="Autor" name="Autor" type="text" placeholder="(erforderlich)" required>
						<p>Beschreiben Sie den Autor so, wie er in den Beobachtungen erscheinen soll. Beispiel: Fritz Muster, Zürich.</p>
					</div>
					<hr >
					<div data-role="fieldcontain">
						<label for="Email">email-Adresse:</label>
						<input id="Email" name="Email" type="email" placeholder="(erforderlich)" required>
						<hr >
					<div data-role="fieldcontain">
						<fieldset data-role="controlgroup">
							<legend>Meine Beobachtungen dürfen verwendet werden:</legend>
								<input type="radio" name="Datenverwendung" id="JaAber" value="JaAber" checked="checked">
								<label for="JaAber">ja, nur für Naturschutzzwecke (Standard)*</label>
								<input type="radio" name="Datenverwendung" id="Ja" value="Ja"  >
								<label for="Ja">ja, ohne Einschränkung</label>
								<input type="radio" name="Datenverwendung" id="Nein" value="Nein">
								<label for="Nein">nein</label>
						</fieldset>
					</div>
					<p>* Bei dieser Option werden die <a href="http://www.crsf.ch/documents/download/d/Deontologie_2008_de.pdf" target="_blank">Datenschutzrichtlinien der Schweizerischen Nationalen Datenzentren für Fauna und Flora</a> eingehalten.<br >Die zuständigen Naturschutzstellen von Bund, Kanton und Gemeinden verwenden die Informationen nur für Naturschutzzwecke. Die Daten nicht besonders empfindlicher Arten können in grober räumlicher Auflösung publiziert werden.</p>
					</div>
				</form>
			</div>
			<div data-role="footer" id="SignupFooter" data-position="fixed" data-tap-toggle="false">
				<div data-role="navbar">
					<ul>
						<li><a href="#" id="SubmitButton" class="ui-btn-active" data-icon="check">Konto erstellen</a></li>
					</ul>
				</div><!-- /navbar -->
			</div><!-- /footer -->
			<script charset="utf-8">
				$("#SignupPage").on("pageshow", function () {
					//Datenverwendung managen: Wenn der User nichts angibt, jaAber setzen
					window.Datenverwendung = "JaAber";
					//sicherstellen, dass nichts vom letzten User übrig bleibt
					leereAlleVariabeln();
				});
				$(":jqmData(role='page')").on("pageinit", function () {
					$("#SignupFooter").on("click", "#SubmitButton", function (event) {
						event.preventDefault();
						if (validiereUserSignup()) {
							erstelleKonto();
						}
					});

					//kontrollierren, ob die erforderlichen Felder etwas enthalten
					//wenn ja wird true retourniert, sonst false
					function validiereUserSignup() {
						var UserName, Passwort, Passwort2, Autor, Email;
						UserName = $("#UserName").val();
						Passwort = $("#Passwort").val();
						Passwort2 = $("#Passwort2").val();
						Autor = $("#Autor").val();
						Email = $("#Email").val();
						if (!UserName) {
							melde("Bitte Benutzernamen eingeben");
							setTimeout(function() {
								$("#UserName").focus();
							}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
							return false;
						} else if (!Passwort) {
							melde("Bitte Passwort eingeben");
							setTimeout(function() {
								$("#Passwort").focus();
							}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
							return false;
						} else if (!Passwort2) {
							melde("Bitte Passwort bestätigen");
							setTimeout(function() {
								$("#Passwort2").focus();
							}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
							return false;
						} else if (Passwort !== Passwort2) {
							melde("Passwort ist falsch bestätigt");
							setTimeout(function() {
								$("#Passwort2").focus();
							}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
							return false;
						} else if (!Autor) {
							melde("Bitte Autor eingeben");
							setTimeout(function() {
								$("#Autor").focus();
							}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
							return false;
						} else if (!Email) {
							melde("Bitte Email eingeben");
							setTimeout(function() {
								$("#Email").focus();
							}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
							return false;
						}
						return true;
					}

					$("#SignupForm").on("change", "[name='Datenverwendung']", function () {
						window.Datenverwendung = $(this).attr("id");
					});

					function erstelleKonto() {
						//User in _user eintragen
						$.couch.signup({
								name: $('#UserName').val(), Autor: $("#Autor").val(), email: $("#Email").val()
							}, $('#Passwort').val(), {
							success : function (r) {
								localStorage.Username = r["name"];
								//Informationen zum User in doc vom typ User eintragen
								speichereUserInEvab();
							},
							error : function () {
								melde("Fehler: Das Konto wurde nicht erstellt");
							}
						});
					}

					//Schreibt die Informationen des users in ein doc vom Typ User
					//erstellt die sichtbaren Felder
					function speichereUserInEvab() {
						var doc;
						doc = {};
						doc.Typ = "User";
						doc.UserName = $('#UserName').val();
						doc.Datenverwendung = window.Datenverwendung;
						doc.ArtenSprache = "Lateinisch";
						doc.Email = $("#Email").val();
						$db = $.couch.db("evab");
						$db.saveDoc(doc, {
							success: function (data) {
								//localStorage gründen
								localStorage.Username = $('#UserName').val();
								localStorage.UserId = data.id;
								localStorage.Autor = $("#Autor").val();
								localStorage.ArtenSprache = "Lateinisch";
								//Autor speichern
								$db.openDoc("f19cd49bd7b7a150c895041a5d02acb0", {
									success: function (Feld) {
										//Autor speichern
										//Falls Standardwert noch nicht existiert, 
										//muss zuerst das Objekt geschaffen werden
										if (!Feld.Standardwert) {
											Feld.Standardwert = {};
										}
										Feld.Standardwert[localStorage.Username] = $("#Autor").val();
										$db.saveDoc(Feld, {
											success: function () {
												//Felder sictbar schalten
												erstelleSichtbareFelder();
												$.mobile.changePage("BeobListe.html");
											},
											error: function () {
												erstelleSichtbareFelder();
												melde("Konto erfolgreich erstellt\nAnmeldung gescheitert\nBitte melden Sie sich neu an");
											}
										});
									},
									error: function () {
										erstelleSichtbareFelder();
										melde("Konto erfolgreich erstellt\nAnmeldung gescheitert\nBitte melden Sie sich neu an");
									}
								});
							},
							error: function () {
								melde("Oh je, Ihr User konnte nicht erstellt werden, der Name ist jetzt aber belegt\nVersuchen Sie es mit einem anderen Benutzernamen\noder bitten Sie alex@barbalex.ch, den Namen wieder freizugeben");
							}
						});
					}

					//setzt alle Felder im Modus Hierarchisch sichtbar
					//Erwartet den UserNamen
					//Modus einfach wird hier nicht eingestellt: Die minimalen Felder sind fix programmiert
					function erstelleSichtbareFelder() {
						var viewname, Username;
						Username = $('#UserName').val();
						$db = $.couch.db("evab");
						viewname = 'evab/FeldListeFeldName';
						$db.view(viewname, {
							success: function (data) {
								var i, Feld;
								for (i in data.rows) {
									if (typeof i !== "function") {
										Feld = data.rows[i].value;
										//Nur ausgewählte offizielle Felder berücksichtigen
										//if (Feld.User === "ZentrenBdKt") {
										if (["pBemerkungen", "rBemerkungen", "oLatitudeDecDeg", "oLongitudeDecDeg", "oHöhe", "oHöheGenauigkeit", "oBemerkungen", "zBemerkungen", "aArtNameUnsicher", "aArtNameEigener", "aArtNameBemerkungen", "aMenge", "aBemerkungen"].indexOf(Feld.FeldName) > -1) {
											$db.openDoc(Feld._id, {
												success: function (Feld) {
													Feld.SichtbarImModusHierarchisch.push(Username);
													$db.saveDoc(Feld);
												}
											});
										}
									}
								}
							}
						});
					}
				});
			</script>
		</div>
	</body>
</html>