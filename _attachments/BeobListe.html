<!DOCTYPE html>
<html>
  <head>
  	<meta http-equiv=Content-Type content="text/html; charset=UTF-8"/>
  	<meta name="viewport" content="width=device-width, initial-scale=1"/>
  	<title>EvAB</title>
  	<link rel="stylesheet" href="style/jquery.mobile.css" type="text/css"/>
  	<link rel="stylesheet" href="style/evab.css" type="text/css"/>
   	<link rel="stylesheet" href="style/evab_theme.css" type="text/css"/>
  	<link rel="stylesheet" href="style/jquery.mobile.simpledialog.css" type="text/css"/>
  	<link rel="SHORTCUT ICON" href="Bilder/favicon.ico">
  	<script type="text/javascript" src="vendor/couchapp/jquery.js"></script>
	<script type="text/javascript">			
		$(document).bind("mobileinit", function(){
			$.mobile.loadingMessage = 'chrampfe!'; 
			$.mobile.defaultPageTransition  = 'none';
			$.mobile.touchOverflowEnabled = 'true';
		});
    </script>
	<script type="text/javascript" src="vendor/couchapp/jquery.couch.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.couch.app.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.couch.app.util.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.mobile.js"></script>
	<script type="text/javascript" src="vendor/couchapp/phonegap.js"></script>
	<script type="text/javascript" src="vendor/couchapp/evab.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.mobile.simpledialog.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" src="vendor/couchapp/markerclusterer.js"></script>
	<script type="text/javascript" src="vendor/couchapp/markerwithlabel.js"></script>
	<style type="text/css">
  		/*workaround against bad scrolling
  		https://forum.jquery.com/topic/why-jqm-touchscreen-list-scrolling-performance-stinks-and-what-to-do-about-it*/
  		*.ui-listview *.ui-btn-up-c,
		*.ui-listview *.ui-btn-down-c,
		*.ui-listview *.ui-btn-hover-c
		  {
		  border:1px solid  #ccc  ;background:#e6edde ;font-weight:bold;color: #2F3E46  ;text-shadow: 0    1px    1px    #f6f6f6  ;background-image:-webkit-gradient(linear,left top,left bottom,from( #dce6d1 ),to( #c1d3b1 )); background-image:-webkit-linear-gradient(top,#dce6d1,#c1d3b1 ); background-image:   -moz-linear-gradient(top,#dce6d1,#c1d3b1 ); background-image:    -ms-linear-gradient(top,#dce6d1,#c1d3b1 ); background-image:     -o-linear-gradient(top,#dce6d1,#c1d3b1 ); background-image:        linear-gradient(top,#dce6d1,#c1d3b1 );
		  }
  	</style>
  </head>
  <body>
  	<div data-role="page" id="BeobListePage">
  		<div id="BeobListePageHeader" data-role="header" data-position="fixed" data-backbtn="false">
  			<h2 class="BeobListePageTitel">Beobachtungen</h2>
  			<a href='#' id='Menu' name='Menu' data-role='button' data-icon="gear" data-iconpos="notext" class="r ui-btn-right">Menu</a>
  		</div>
		<div data-role="content">
			<ul id="beobachtungen" data-role="listview" data-filter="true" data-filter-placeholder="Filter setzen...">
			</ul>
		</div>
		<div data-role="footer" data-position="fixed">
			<div data-role="navbar">
				<ul>
					<li><a id="NeueBeobLink" href="BeobNeu.html" data-transition="slideup" data-icon="plus" rel="external" class="ui-btn-active" >neue Beobachtung</a></li>
					<li><a href="#" id="BeobListeMapÖffnen" data-icon="star">Karte</a></li>
				</ul>
			</div>
		</div>
	</div>

	<div data-role="page" id="BeobListeMap" style="width:100%; height:100%;">
		<div data-role="header" data-position="fixed">
			<a href="#BeobListePage" data-role="button" data-icon="arrow-l" data-iconpos="notext" data-direction="reverse">abbrechen</a>
			<h1>Karte</h1>
			<a href='#' id='Menu2' name='Menu' data-role='button' data-icon="gear" data-iconpos="notext" class="r ui-btn-right">Menu</a>
		</div>
		<div data-role="content" style="width:100%; height:100%; padding:0;"> 
			<div id="map_canvas" style="width:100%; height:100%;"></div>
		</div>
	</div>

  </body>
  <script type="text/javascript" charset="utf-8">
	function handleDocumentReady() {
		$db = $.couch.db("evab");
		
		var Pfad = "";
		User = "";
		
		prüfeAnmeldung(Pfad);
		
		aktualisiereBeobListe(Pfad, User);

		speichereLetzteUrl(User);

		$(".beob").live("swipeleft", function() {
			var BeobId = $(this).attr('id');
			window.open("_show/BeobEdit/" + BeobId, target="_self");
		});

		$("#BeobListeMapÖffnen").tap(function(event) {                        //ToDo: Prüfen, ob Beobachtungen mit LatLng vorliegen
			$.mobile.changePage("#BeobListeMap", "slide", false, true);
		});

		$('#BeobListeMap').live("pagecreate", function() {
			/*
			zuerst Koordinaten holen, Karte darum zentrieren
			dann in schleife alle marker setzen
			listener schaffen
			*/
			if (navigator.geolocation) { 
	        	navigator.geolocation.getCurrentPosition ( 
	            function(position) {
	            	lat = position.coords.latitude;
	            	lng = position.coords.longitude;
	            	var latlng = new google.maps.LatLng(lat, lng);
					var options = {
					    zoom: 15,
					    center: latlng,
					    streetViewControl: false,
					    mapTypeId: google.maps.MapTypeId.HYBRID
					};
					var map = new google.maps.Map(document.getElementById("map_canvas"),options);
					google.maps.event.trigger(map,'resize'); 
					//jetzt werden für alle Beobachtungen marker erstellt
					$db.view('evab/BeobListeLatLng?startkey=["' + User + '"]&endkey=["' + User + '",{}]', {
						success: function(data) {
							var i;
							var anzBeob = 0;
							var beob;
							var key;
							var image;
							var infowindow = new google.maps.InfoWindow();
							for(i in data.rows) {                    //Beobachtungen zählen. Wenn noch keine: darauf hinweisen
								anzBeob += 1;
							}
							if (anzBeob == 0) {
								melde("Es wurden noch keine Beobachtungen mit Koordinaten erfasst");
							} else {
								var markers = [];
								for(i in data.rows) {                //Liste aufbauen
									beob = data.rows[i].value;
									key = data.rows[i].key;
									if (key[0] == User) {                   //nur eigene Beobachtungen anzeigen!
										var BeobId = beob._id;
										var Datum = beob.zDatum;
										var Zeit = beob.zUhrzeit;
										var ArtGruppe = beob.aArtGruppe;
										var image = "Artgruppenbilder/" + ArtGruppe + ".png";
										var ArtName = beob.aArtName;
										var Autor = beob.aAutor;
										var lat2 = beob.oLatitudeDecDeg;
										var lng2 = beob.oLongitudeDecDeg;
										var externalPage = "_show/BeobEdit/" + BeobId;
										var latlng2 = new google.maps.LatLng(lat2, lng2);
										var marker = new MarkerWithLabel({ 
											map: map,
											position: latlng2,  
										    title: ArtName,
										    icon: image,
										    labelContent: ArtName,
										    labelAnchor: new google.maps.Point(22, 0),
										    labelClass: "MapLabel", // the CSS class for the label
											labelStyle: {opacity: 0.75}
										});
										markers.push(marker);
										var contentString = '<div id="content">'+
										    '<div id="siteNotice">'+
										    '</div>'+
										    '<h4 id="firstHeading" class="GmInfowindow">' + ArtName + '</h4>'+
										    '<div id="bodyContent" class="GmInfowindow">'+
										    '<p>Art-Gruppe: ' + ArtGruppe + '</p>'+
										    '<p>Autor: ' + Autor + '</p>'+
										    '<p>Datum: ' + Datum + '</p>'+
										    '<p>Zeit: ' + Zeit + '</p>'+
										    "<p><a href=\"" + externalPage + "\" rel=\"external\">bearbeiten<\/a></p>"+
										    '</div>'+
										    '</div>';
										makeListener(map, marker, contentString);
									}
								}
								var mcOptions = {maxZoom: 17};
								var markerCluster = new MarkerClusterer(map, markers, mcOptions);
							}
							function makeListener(map, marker, contentString){
								google.maps.event.addListener(marker, 'click', function() {
									infowindow.setContent(contentString);
									infowindow.open(map,marker);
								});
							}
						}
					}); 
	            }); 
	        } else {
	        	var lat = 47.383333;
				var lng = 8.533333;
				var latlng = new google.maps.LatLng(lat, lng);
				var options = {
				    zoom: 15,
				    center: latlng,
				    streetViewControl: false,
				    mapTypeId: google.maps.MapTypeId.HYBRID
				};
				var map = new google.maps.Map(document.getElementById("map_canvas"),options);
				google.maps.event.trigger(map,'resize');
				//jetzt werden für alle Beobachtungen marker erstellt
				$db.view('evab/BeobListeLatLng?startkey=["' + User + '"]&endkey=["' + User + '",{}]', {
					success: function(data) {
						var i;
						var anzBeob = 0;
						var beob;
						var key;
						var image;
						var infowindow = new google.maps.InfoWindow();
						for(i in data.rows) {                    //Beobachtungen zählen. Wenn noch keine: darauf hinweisen
							anzBeob += 1;
						}
						if (anzBeob == 0) {
							melde("Es wurden noch keine Beobachtungen mit Koordinaten erfasst");
						} else {
							var markers = [];
							for(i in data.rows) {                //Liste aufbauen
								beob = data.rows[i].value;
								key = data.rows[i].key;
								if (key[0] == User) {                   //nur eigene Beobachtungen anzeigen!
									var BeobId = beob._id;
									var Datum = beob.zDatum;
									var Zeit = beob.zUhrzeit;
									var ArtGruppe = beob.aArtGruppe;
									var image = "Artgruppenbilder/" + ArtGruppe + ".png";
									var ArtName = beob.aArtName;
									var Autor = beob.aAutor;
									var lat2 = beob.oLatitudeDecDeg;
									var lng2 = beob.oLongitudeDecDeg;
									var externalPage = "_show/BeobEdit/" + BeobId;
									var latlng2 = new google.maps.LatLng(lat2, lng2);
									var marker = new MarkerWithLabel({ 
										map: map,
										position: latlng2,  
									    title: ArtName,
									    icon: image,
									    labelContent: ArtName,
									    labelAnchor: new google.maps.Point(22, 0),
									    labelClass: "MapLabel", // the CSS class for the label
										labelStyle: {opacity: 0.75}
									});
									markers.push(marker);
									var contentString = '<div id="content">'+
									    '<div id="siteNotice">'+
									    '</div>'+
									    '<h4 id="firstHeading" class="GmInfowindow">' + ArtName + '</h4>'+
									    '<div id="bodyContent" class="GmInfowindow">'+
									    '<p>Art-Gruppe: ' + ArtGruppe + '</p>'+
									    '<p>Autor: ' + Autor + '</p>'+
									    '<p>Datum: ' + Datum + '</p>'+
									    '<p>Zeit: ' + Zeit + '</p>'+
									    "<p><a href=\"" + externalPage + "\" rel=\"external\">bearbeiten<\/a></p>"+
									    '</div>'+
									    '</div>';
									makeListener(map, marker, contentString);
								}
							}
							var mcOptions = {maxZoom: 17};
							var markerCluster = new MarkerClusterer(map, markers, mcOptions);
						}
						function makeListener(map, marker, contentString){
							google.maps.event.addListener(marker, 'click', function() {
								infowindow.setContent(contentString);
								infowindow.open(map,marker);
							});
						}
					}
				});
	        }
		});
	
		//UserId ermitteln, um Link zum UserEdit im Menü zu setzen
		UserId = holeUserId(User);

		//Menu aufbauen
		$("[name='Menu']").live('click', function(){
			var zurueck = "BeobListe.html";
			erstelleMenu(zurueck, this, User, UserId, Pfad);
		});

		//Seitenhöhe korrigieren, weil sonst GoogleMap weiss bleibt
		contentHeight = $(window).height() - 43;
		$("#map_canvas").css("height", contentHeight + "px");

		//Neue Beobachtung managen
		$("#NeueBeobLink").live("click", function(event){
			event.preventDefault();
			erstelleNeueBeob_1_Artgruppenliste();
		});	
	}
	
	$(document).ready(handleDocumentReady);
	//eigene Funktion, weil auch die Beobliste darauf verweist, wenn noch keine Art erfasst wurde
	function erstelleNeueBeob_1_Artgruppenliste() {
		window.open("Artgruppenliste.html?Status=Neu&Von=BeobListe", target="_self");
	}
	function prüfeAnmeldung(Pfad) {		
		//User Anmeldung überprüfen
		//Wenn angemeldet, globale Variable User aktualisieren
		//Wenn nicht angemeldet, Anmeldedialog öffnen
		$.ajax({
		    url: '/_session?callback=',
		    dataType: 'json',
		    async: false,
		    success: function(session) {
		    	if(User != undefined || null) {
		        	User = session.userCtx.name;
		        } else {
					window.open(Pfad + "index.html", target="_self");
				}
		    }
		});
	}
  </script>
</html>
