<!DOCTYPE html>
<html>
	<head>
		<link rel="SHORTCUT ICON" href="Bilder/favicon.ico">
		<meta http-equiv=Content-Type content="text/html; charset=UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<title>EvAB</title>
		<link rel="stylesheet" href="style/jquery.mobile.css" type="text/css"/>
		<link rel="stylesheet" href="style/evab.css" type="text/css"/>
		<link rel="stylesheet" href="style/jquery.mobile.datebox.css" type="text/css"/>
		<link rel="stylesheet" href="style/jquery.mobile.simpledialog.css" type="text/css"/>
		<script type="text/javascript" src="vendor/couchapp/jquery.js"></script>
		<script type="text/javascript">
			$(document).on("mobileinit", function () {
				$.mobile.page.prototype.options.degradeInputs.date = 'text';
				$.mobile.page.prototype.options.degradeInputs.time = 'text';
				$.mobile.selectmenu.prototype.options.nativeMenu = false;
				$.event.special.swipe.horizontalDistanceThreshold = 250;
				$.mobile.buttonMarkup.hoverDelay = 0;
			});
		</script>
		<script type="text/javascript" src="vendor/couchapp/jquery.couch.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.couch.app.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.form.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.mustache.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.mobile.js"></script>
		<script type="text/javascript" src="vendor/couchapp/phonegap.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.mobile.datebox.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.mobile.simpledialog.js"></script>
		<script type="text/javascript" src="vendor/couchapp/evab.js"></script>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script type="text/javascript" src="vendor/couchapp/markerclusterer.js"></script>
		<script type="text/javascript" src="vendor/couchapp/markerwithlabel.js"></script>
	</head>
	<body>
		<div data-role="page" id="ProjektListePage">
			<div id="hProjektListePageHeader" data-role="header" data-position="fixed" data-tap-toggle="false" data-backbtn="false">
				<h2 class="hProjektListePageTitel">Projekte</h2>
				<a href='#' name='MenuProjektListe' data-role='button' data-icon="wrench" data-iconpos="notext" class="r ui-btn-right">Menu</a>
			</div>
			<div data-role="content">
				<ul id="Projekte" data-role="listview" data-filter="true" data-filter-placeholder="suchen..." />
				</ul>
			</div>
			<div data-role="footer" id="ProjektListePageFooter" data-position="fixed" data-tap-toggle="false">
				<div data-role="navbar">
					<ul>
						<li><a href="#" data-icon="plus" class="ui-btn-active hpl_NeuLink">neues Projekt</a></li>
						<li><a href="#" id="ProjektListeMapOeffnen" data-icon="mappin">Karte</a></li>
					</ul>
				</div>
			</div>
			<script type="text/javascript" charset="utf-8">
				$(":jqmData(role='page')").on("pageinit", function () {
					//Beim direkten Aufruf dieser Seite muss die sessionStorage aus der DB gelesen werden
					//wo sie von speichereLetzteUrl gespeichert wurde
					//sessionStorage.Projektliste ist dann null und sessionStorage.length 1
					//sessionStorage.Projektliste ist auch null, wenn die Projektliste gelöscht wurde
					//holeSessionStorageAusDb stellt die alte sessionStorage.Projektliste wieder her
					//darum hier die sessionStorage.length prüfen
					if (sessionStorage.length === 0) {
						holeSessionStorageAusDb("hProjektListe");
					} else {
						initiiereProjektliste();
					}

					//Menu aufbauen
					$(document).on('click', '[name="MenuProjektListe"]', function (event) {
						event.preventDefault();
						erstelleMenuProjektliste(this);
					});

					//neues Projekt erstellen
					$("body").on("click", ".hpl_NeuLink", function (event) {
						event.preventDefault();
						erstelleNeuesProjekt();
					});

					$("#Projekte").on("swipeleft", ".Projekt", function () {
						var ProjektId;
						ProjektId = $(this).attr('ProjektId');
						sessionStorage.ProjektId = ProjektId;
						window.open("hRaumListe.html", target = "_self");
					});

					$("#Projekte").on("click", ".Projekt", function (event) {
						var ProjektId;
						event.preventDefault();
						ProjektId = $(this).attr('ProjektId');
						sessionStorage.ProjektId = ProjektId;
						window.open("hProjektEdit.html", target = "_self");
					});

					$("#Projekte").on("swipeleft", ".erste", function () {
						erstelleNeuesProjekt();
					});

					$("body").on("swiperight", function () {
						window.open("BeobListe.html", target = "_self");
					});

					$('#ProjektListePageFooter').on('click', '#ProjektListeMapOeffnen', function (event) {
						var contentHeight;
						event.preventDefault();
						$.mobile.changePage("#ProjektListeMap");
						//Seitenhöhe korrigieren, weil sonst GoogleMap weiss bleibt
						contentHeight = $(window).height() - 43;
						$("#map_canvas").css("height", contentHeight + "px");
					});

					$(document).on("pageshow", '#ProjektListeMap', function () {
						//dies hier im pageshow, weil die Karte sonst in Chrome nicht erscheit
						erstelleKarteFuerProjektliste();
					});

					$(document).on("pagehide", '#ProjektListeMap', function () {
						//leeren, damit bei erneuten Öffnen die Karte nicht zweimal aufgebaut wird
						$("#map_canvas").html("");
					});

					//Menü aufbauen
					function erstelleMenuProjektliste(thiz) {
						if (!localStorage.Username) {
							pruefeAnmeldung();
						}
						//Code um Menü aufzubauen
						$(thiz).simpledialog({
							'mode' : 'bool',
							'prompt' : 'Menü',
							'fullHTML': 'true',
							'buttons' : {
							 	'einfacher Modus': {
									click: function () {
										window.open("BeobListe.html", target = "_self");
									},
									theme: "a",
									icon: "check"
								},
								'Felder verwalten': {
									click: function () {
										sessionStorage.zurueck = "hProjektListe.html";
										window.open("FeldListe.html", target = "_self");
									},
									theme: "a",
									icon: "edit"
								},
								'Projekte exportieren': {
									click: function () {
										window.open('_list/ExportProjekt/ExportProjekt?startkey=["' + localStorage.Username + '",{},{},{},{},{}]&endkey=["' + localStorage.Username + '"]&descending=true');
									},
									theme: "a",
									icon: "arrow-r"
								},
								'Einstellungen': {
									click: function () {
										öffneMeineEinstellungen("");
									},
									theme: "a",
									icon: "wrench"
								},
								'lokal installieren': {
									click: function () {
										window.open("Installieren.html", target = "_self");
									},
									theme: "a",
									icon: "lightning"
								},
								'neu anmelden': {
									click: function () {
										sessionStorage.UserStatus = "neu";
										window.open("index.html", target = "_self");
									},
									theme: "a",
									icon: "person"
								},
								'schliessen': {
									click: function () { return true; },
									icon: "back",
									theme: "c"
								}
							}
						})
					}

					function erstelleKarteFuerProjektliste() {
						if (!localStorage.Username) {
							pruefeAnmeldung();
						}
						$db = $.couch.db("evab");
						//Zuerst Orte abfragen
						$db.view('evab/hProjektlisteOrteFuerKarte?key="' + localStorage.Username + '"&include_docs=true', {
							success: function (data) {
								var i, anzOrt, Ort;
								anzOrt = 0;
								var infowindow = new google.maps.InfoWindow();
								//Orte zählen
								for (i in data.rows) {
									anzOrt += 1;
								}
								//Keine Orte: Hinweis und zurück
								if (anzOrt === 0) {
									melde("Es gibt keine Orte mit Koordinaten");
									history.back();
								//Orte vorhanden: Karte aufbauen
								} else {
									var lat = 47.383333;
									var lng = 8.533333;
									var latlng = new google.maps.LatLng(lat, lng);
									var options = {
										zoom: 15,
										center: latlng,
										streetViewControl: false,
										mapTypeId: google.maps.MapTypeId.HYBRID
									};
									var map = new google.maps.Map(document.getElementById("map_canvas"),options);
									google.maps.event.trigger(map,'resize');
									var bounds = new google.maps.LatLngBounds();
									//für alle Orte Marker erstellen
									var markers = [];
									for (i in data.rows) {
										Ort = data.rows[i].doc;
										var hOrtId = Ort._id;
										var hRaumId = Ort.hRaumId;
										var hProjektId = Ort.hProjektId;
										var oName = Ort.oName;
										var oXKoord = Ort.oXKoord;
										var oYKoord = Ort.oYKoord;
										var lat2 = Ort.oLatitudeDecDeg;
										var lng2 = Ort.oLongitudeDecDeg;
										//var externalPage = "hOrtEdit.html";
										var latlng2 = new google.maps.LatLng(lat2, lng2);
										if (anzOrt === 1) {
											//map.fitbounds setzt zu hohen zoom, wenn nur eine Beobachtung erfasst wurde > verhindern
											latlng = latlng2;
										} else {
											//Kartenausschnitt um diese Koordinate erweitern
											bounds.extend(latlng2);
										}
										var marker = new MarkerWithLabel({ 
											map: map,
											position: latlng2,
											title: oName.toString(),
											labelContent: oName,
											labelAnchor: new google.maps.Point(22, 0),
											labelClass: "MapLabel", // the CSS class for the label
											labelStyle: {opacity: 0.75}
										});
										markers.push(marker);
										var contentString = '<div id="content">'+
											'<div id="siteNotice">'+
											'</div>'+
											'<h4 id="firstHeading" class="GmInfowindow">' + oName + '</h4>'+
											'<div id="bodyContent" class="GmInfowindow">'+
											'<p>X-Koordinate: ' + oXKoord + '</p>'+
											'<p>Y-Koordinate: ' + oYKoord + '</p>'+
											"<p><a href=\"#\" onclick=\"oeffneOrt('" + hOrtId + "')\" rel=\"external\">bearbeiten<\/a></p>"+
											'</div>'+
											'</div>';
										makeListener(map, marker, contentString);
									}
									var mcOptions = {maxZoom: 17};
									var markerCluster = new MarkerClusterer(map, markers, mcOptions);
									if (anzOrt === 1) {
										//map.fitbounds setzt zu hohen zoom, wenn nur eine Beobachtung erfasst wurde > verhindern
										map.setCenter(latlng);
										map.setZoom(18);
									} else {
										//Karte auf Ausschnitt anpassen
										map.fitBounds(bounds);
									}
								}
								
								function makeListener(map, marker, contentString) {
									google.maps.event.addListener(marker, 'click', function () {
										infowindow.setContent(contentString);
										infowindow.open(map,marker);
									});
								}
							}
						});
					}
				});
			</script>
		</div>
		<div data-role="page" id="ProjektListeMap" style="width:100%; height:100%;">
			<div data-role="header" data-position="fixed" data-tap-toggle="false">
				<a href="#ProjektListePage" data-role="button" data-icon="arrow-l" data-iconpos="notext" data-direction="reverse">abbrechen</a>
				<h1>Karte</h1>
				<a href='#' name='MenuProjektListe' data-role='button' data-icon="wrench" data-iconpos="notext" class="r ui-btn-right">Menu</a>
			</div>
			<div data-role="content" style="width:100%; height:100%; padding:0;"> 
				<div id="map_canvas" style="width:100%; height:100%;"></div>
			</div>
		</div>
	</body>
</html>