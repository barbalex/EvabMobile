<!DOCTYPE html>
<html lang="de">
	<head>
		<link rel="SHORTCUT ICON" href="Bilder/favicon.ico">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>EvAB</title>
		<link rel="stylesheet" href="style/jquery.mobile.css">
		<link rel="stylesheet" href="style/evab.css">
		<style>.ui-icon-evab-location {background-image:url('Bilder/evab-location.png');}</style>
		<link rel="stylesheet" href="style/jquery.mobile.datebox.css">
		<link rel="stylesheet" href="style/jquery.mobile.simpledialog.css">
		<script src="vendor/couchapp/jquery.js"></script>
		<script src="vendor/couchapp/jquery-migrate.js"></script>
		<script>
			$(document).on("mobileinit", function () {
				$.mobile.page.prototype.options.degradeInputs.date = 'text';
				$.mobile.page.prototype.options.degradeInputs.time = 'text';
				$.mobile.selectmenu.prototype.options.nativeMenu = false;
				$.event.special.swipe.horizontalDistanceThreshold = 250;
				$.mobile.buttonMarkup.hoverDelay = 0;
			});
		</script>
		<script src="vendor/couchapp/jquery.couch.js"></script>
		<script src="vendor/couchapp/jquery.form.js"></script>
		<script src="vendor/couchapp/jquery.mobile.js"></script>
		<script src="vendor/couchapp/phonegap.js"></script>
		<script src="vendor/couchapp/jquery.mobile.datebox.js"></script>
		<script src="vendor/couchapp/jquery.mobile.simpledialog2.js"></script>
		<script src="vendor/couchapp/evab.js"></script>
		<script src="vendor/couchapp/sha1.js"></script>
		<script src="https://maps.google.com/maps/api/js?sensor=false"></script>
		<script src="vendor/couchapp/markerclusterer.js"></script>
		<script src="vendor/couchapp/markerwithlabel.js"></script>
	</head>
	<body>
		<div data-role="page" id="KartePage" style="width:100%; height:100%;">
			<div data-role="header" id="KarteHeader" data-position="fixed" data-tap-toggle="false">
				<a href="#" id="ZurueckKarte" data-role="button" data-icon="arrow-l" data-iconpos="notext">zurück</a>
				<h1>Karte</h1>
			</div>
			<div data-role="content" style="width:100%; height:100%; padding:0;"> 
				<div id="MapCanvas" style="width:100%; height:100%;"></div>
			</div>
			<script charset="utf-8">
				
				$("#KartePage").on("pageshow", function () {
					//Karten müssen in pageshow erstellt werden, weil sie sonst in Chrome nicht erscheinen
					var viewname, KeinOrtMeldung, contentHeight;
					//In diesem Array werden alle Marker gespeichert, damit sie gelöscht werden können
					//wird benutzt von: hOrtEdit.html, BeobEdit.html
					var markersArray = [];
					var InfoWindowArray = [];

					//sicherstellen, dass localStorage.zurueck existiert (gibt sonst später Fehler)
					if (!localStorage.zurueck) {
						$.mobile.changePage("BeobListe.html");
					}

					//Je nachdem, welche Seite die Karte aufruft, muss unterschiedlich vorgegangen werden
					switch(localStorage.zurueck) {
						case "hProjektListe":
							viewname = 'evab/hProjektlisteOrteFuerKarte?key="' + localStorage.Username + '"&include_docs=true';
							KeinOrtMeldung = "Es gibt keine Orte mit Koordinaten";
							erstelleKarteH();
							break;
						case "hProjektEdit":	//gleich wie hRaumListe
						case "hRaumListe":
							viewname = 'evab/hProjektOrteFuerKarte?startkey=["' + localStorage.Username + '", "' + localStorage.ProjektId + '"]&endkey=["' + localStorage.Username + '", "' + localStorage.ProjektId + '" ,{}]&include_docs=true';
							KeinOrtMeldung = "Es gibt keine Orte mit Koordinaten";
							erstelleKarteH();
							break;
						case "hRaumEdit":	//gleich wie hOrtListe
						case "hOrtListe":
							viewname = 'evab/hRaumOrteFuerKarte?startkey=["' + localStorage.Username + '", "' + localStorage.RaumId + '"]&endkey=["' + localStorage.Username + '", "' + localStorage.RaumId + '" ,{}]&include_docs=true';
							KeinOrtMeldung = "Es gibt keine Orte mit Koordinaten";
							erstelleKarteH();
							break;
						case "hOrtEdit":
							OrtOderBeob = "Ort";
							erstelleKartehOrtEdit();
							break;
						case "BeobListe":
							erstelleKarteBeobListe();
							break;
						case "BeobEdit":
							erstelleKarteBeobEdit();
							break;
					}

					//erstellt Karten für hProjektListe bis hOrtListe
					//im ersten Teil wird die Liste aller Orte erstellt und an den zweiten Teil übergeben
					function erstelleKarteH() {
						var contentHeight, hOrtLatLngListe;
						//Seitenhöhe korrigieren, weil sonst GoogleMap weiss bleibt
						contentHeight = $(window).height() - 44;
						$("#MapCanvas").css("height", contentHeight + "px");
						//zuständige hOrtLatLngListe ermitteln
						switch (localStorage.zurueck) {
							case "hProjektListe":
							hOrtLatLngListe = "hOrteLatLngProjektliste";
							break;
						case "hProjektEdit":	//gleich wie hRaumListe
						case "hRaumListe":
							hOrtLatLngListe = "hOrteLatLngProjekt";
							break;
						case "hRaumEdit":	//gleich wie hOrtListe
						case "hOrtListe":
							hOrtLatLngListe = "hOrteLatLngRaum";
							break;
						}
						//Liste der Orte holen. Prüfen, ob sie noch als Variable vorliegt
						if (window[hOrtLatLngListe]) {
							erstelleKarteH_2(window[hOrtLatLngListe]);
						} else {
							$db = $.couch.db("evab");
							$db.view(viewname, {
								success: function (data) {
									window[hOrtLatLngListe] = data;
									erstelleKarteH_2(data);
								}
							});
						}
					}

					function erstelleKarteH_2(hOrteLatLng) {
						var anzOrt, infowindow, Ort, lat, lng, latlng, options, map, bounds, markers, hOrtId, latlng2, marker, contentString, mcOptions, markerCluster;
						infowindow = new google.maps.InfoWindow();
						//Orte zählen
						anzOrt = hOrteLatLng.rows.length;
						//Keine Orte: Hinweis und zurück
						if (anzOrt === 0) {
							melde(KeinOrtMeldung);
							history.back();
						//Orte vorhanden: Karte aufbauen
						} else {
							//Karte mal auf Zürich zentrieren, falls in den hOrteLatLng.rows keine Koordinaten kommen
							//auf die die Karte ausgerichtet werden kann
							lat = 47.383333;
							lng = 8.533333;
							latlng = new google.maps.LatLng(lat, lng);
							options = {
								zoom: 15,
								center: latlng,
								streetViewControl: false,
								mapTypeId: google.maps.MapTypeId.HYBRID
							};
							map = new google.maps.Map(document.getElementById("MapCanvas"),options);
							//google.maps.event.trigger(map,'resize');
							bounds = new google.maps.LatLngBounds();
							//für alle Orte Marker erstellen
							markers = [];
							for (i in hOrteLatLng.rows) {
								Ort = hOrteLatLng.rows[i].doc;
								hOrtId = Ort._id;
								latlng2 = new google.maps.LatLng(Ort.oLatitudeDecDeg, Ort.oLongitudeDecDeg);
								if (anzOrt === 1) {
									//map.fitbounds setzt zu hohen zoom, wenn nur eine Beobachtung erfasst wurde > verhindern
									latlng = latlng2;
								} else {
									//Kartenausschnitt um diese Koordinate erweitern
									bounds.extend(latlng2);
								}
								marker = new MarkerWithLabel({ 
									map: map,
									position: latlng2,
									//title muss String sein
									title: Ort.oName.toString() || "",
									labelContent: Ort.oName,
									labelAnchor: new google.maps.Point(22, 0),
									labelClass: "MapLabel", // the CSS class for the label
									labelStyle: {opacity: 0.75}
								});
								markers.push(marker);
								contentString = '<div id="content">'+
									'<div id="siteNotice">'+
									'</div>'+
									'<div id="bodyContent" class="GmInfowindow">'+
									'<p>Projekt: ' + Ort.pName + '</p>'+
									'<p>Raum: ' + Ort.rName + '</p>'+
									'<p>Ort: ' + Ort.oName + '</p>'+
									'<p>Koordinaten: ' + Ort.oXKoord + ' / ' + Ort.oYKoord + '</p>'+
									"<p><a href=\"#\" onclick=\"oeffneOrt('" + hOrtId + "')\">bearbeiten<\/a></p>"+
									'</div>'+
									'</div>';
								makeListener(map, marker, contentString);
							}
							mcOptions = {maxZoom: 17};
							markerCluster = new MarkerClusterer(map, markers, mcOptions);
							if (anzOrt === 1) {
								//map.fitbounds setzt zu hohen zoom, wenn nur eine Beobachtung erfasst wurde > verhindern
								map.setCenter(latlng);
								map.setZoom(18);
							} else {
								//Karte auf Ausschnitt anpassen
								map.fitBounds(bounds);
							}
						}

						//diese Funktion muss hier sein, damit infowindow bekannt ist
						function makeListener(map, marker, contentString) {
							google.maps.event.addListener(marker, 'click', function () {
								infowindow.setContent(contentString);
								infowindow.open(map,marker);
							});
						}
					}

					//wird benutzt in hOrtEdit.html
					function erstelleKartehOrtEdit() {
						var map, verorted, lat, lng, ZoomLevel, latlng, options, map, marker, contentString, infowindow;
						//Seitenhöhe korrigieren, weil sonst GoogleMap weiss bleibt
						contentHeight = $(window).height() - 44;
						$("#MapCanvas").css("height", contentHeight + "px");
						if (localStorage.oLatitudeDecDeg && localStorage.oLongitudeDecDeg) {
							lat = localStorage.oLatitudeDecDeg;
							lng = localStorage.oLongitudeDecDeg;
							ZoomLevel = 15;
							verorted = true;
						} else {
							lat = 47.360566;
							lng = 8.542829;
							ZoomLevel = 12;
							verorted = false;
						}
						latlng = new google.maps.LatLng(lat, lng);
						options = {
							zoom: ZoomLevel,
							center: latlng,
							streetViewControl: false,
							mapTypeId: google.maps.MapTypeId.HYBRID
						};
						map = new google.maps.Map(document.getElementById("MapCanvas"),options);
						if (verorted === true) {
							marker = new google.maps.Marker({
								position: latlng, 
								map: map,
								//title muss String sein
								title: window.hOrt.oName.toString() || "",
								draggable: true
							});
							//Marker in Array speichern, damit er gelöscht werden kann
							markersArray.push(marker);
							contentString = '<div id="content">'+
									'<div id="siteNotice">'+
									'</div>'+
									'<div id="bodyContent" class="GmInfowindow">'+
									'<p>Projekt: ' + window.hOrt.pName + '</p>'+
									'<p>Raum: ' + window.hOrt.rName + '</p>'+
									'<p>Ort: ' + window.hOrt.oName + '</p>'+
									'<p>Koordinaten: ' + localStorage.oXKoord + " / " + localStorage.oYKoord + '</p>' +
									'</div>'+
									'</div>';
							infowindow = new google.maps.InfoWindow({
								content: contentString
							});
							InfoWindowArray.push(infowindow);
							google.maps.event.addListener(marker, 'click', function () {
							infowindow.open(map,marker);
							});
							google.maps.event.addListener(marker, "dragend", function (event) {
								SetLocationhOrtEdit(event.latLng, map, marker);
							});
						}
						google.maps.event.addListener(map, 'click', function (event) {
							placeMarkerhOrtEdit(event.latLng, map, marker);
						});
					}

					//wird benutzt in BeobListe.html
					function erstelleKarteBeobListe() {
						var contentHeight;
						//Seitenhöhe korrigieren, weil sonst GoogleMap weiss bleibt
						contentHeight = $(window).height() - 44;
						$("#MapCanvas").css("height", contentHeight + "px");
						//Beobachtungen holen. Prüfen, ob die Liste noch da ist
						if (window.BeobListeLatLng) {
							erstelleKarteBeobListe_2();
						} else {
							$db = $.couch.db("evab");
							$db.view('evab/BeobListeLatLng?key="' + localStorage.Username + '"&include_docs=true', {
								success: function (data) {
									window.BeobListeLatLng = data;
									erstelleKarteBeobListe_2();
								}
							});
						}
					}

					function erstelleKarteBeobListe_2() {
						var i, anzBeob, beob, key, image, infowindow, lat, lng, latlng, latlng2, options, map, bounds, marker, markers, contentString, mcOptions, markerCluster;
						infowindow = new google.maps.InfoWindow();
						//Anzahl Beobachtungen zählen
						anzBeob = BeobListeLatLng.rows.length;
						if (anzBeob === 0) {
							//Keine Beobachtungen: Hinweis und zurück
							melde("Es wurden noch keine Beobachtungen mit Koordinaten erfasst");
							$.mobile.changePage("BeobListe.html");
						} else {
							//Beobachtungen vorhanden: Karte aufbauen
							lat = 47.383333;
							lng = 8.533333;
							latlng = new google.maps.LatLng(lat, lng);
							options = {
								zoom: 15,
								center: latlng,
								streetViewControl: false,
								mapTypeId: google.maps.MapTypeId.HYBRID
							};
							map = new google.maps.Map(document.getElementById("MapCanvas"),options);
							//google.maps.event.trigger(map,'resize');
							bounds = new google.maps.LatLngBounds();
							//für alle Beobachtungen Marker erstellen
							markers = [];
							for (i in BeobListeLatLng.rows) {
								beob = BeobListeLatLng.rows[i].doc;
								image = "Artgruppenbilder/" + beob.aArtGruppe + ".png";
								latlng2 = new google.maps.LatLng(beob.oLatitudeDecDeg, beob.oLongitudeDecDeg);
								if (anzBeob === 1) {
									//map.fitbounds setzt zu hohen zoom, wenn nur eine Beobachtung erfasst wurde > verhindern
									latlng = latlng2;
								} else {
									//Kartenausschnitt um diese Koordinate erweitern
									bounds.extend(latlng2);
								}
								marker = new MarkerWithLabel({ 
									map: map,
									position: latlng2,
									//title muss String sein
									title: beob.aArtName.toString() || "",
									icon: image,
									labelContent: beob.aArtName,
									labelAnchor: new google.maps.Point(22, 0),
									labelClass: "MapLabel", // the CSS class for the label
									labelStyle: {opacity: 0.75}
								});
								markers.push(marker);
								contentString = '<div id="content">'+
									'<div id="siteNotice">'+
									'</div>'+
									'<h4 id="firstHeading" class="GmInfowindow">' + beob.aArtName + '</h4>'+
									'<div id="bodyContent" class="GmInfowindow">'+
									'<p>Art-Gruppe: ' + beob.aArtGruppe + '</p>'+
									'<p>Autor: ' + beob.aAutor + '</p>'+
									'<p>Datum: ' + beob.zDatum + '</p>'+
									'<p>Zeit: ' + beob.zUhrzeit + '</p>'+
									'<p>Koordinaten: ' + beob.oXKoord + " / " + beob.oYKoord + '</p>' +
									"<p><a <a href=\"#\" onclick=\"oeffneBeob('" + beob._id + "')\">bearbeiten<\/a></p>"+
									'</div>'+
									'</div>';
								makeListener(map, marker, contentString);
							}
							mcOptions = {maxZoom: 17};
							markerCluster = new MarkerClusterer(map, markers, mcOptions);
							if (anzBeob === 1) {
								//map.fitbounds setzt zu hohen zoom, wenn nur eine Beobachtung erfasst wurde > verhindern
								map.setCenter(latlng);
								map.setZoom(18);
							} else {
								//Karte auf Ausschnitt anpassen
								map.fitBounds(bounds);
							}
						}
						//listener schaffen, der bei Klick auf Marker dessen Fenster öffnet
						function makeListener(map, marker, contentString) {
							google.maps.event.addListener(marker, 'click', function () {
								infowindow.setContent(contentString);
								infowindow.open(map,marker);
							});
						}
					}

					function erstelleKarteBeobEdit() {
						var map, verorted, lat, lng, ZoomLevel, latlng, options, mapcanvas, map, image, marker, contentString, infowindow;
						//Seitenhöhe korrigieren, weil sonst GoogleMap weiss bleibt
						contentHeight = $(window).height() - 44;
						$("#MapCanvas").css("height", contentHeight + "px");
						if (localStorage.oLatitudeDecDeg && localStorage.oLongitudeDecDeg) {
							lat = localStorage.oLatitudeDecDeg;
							lng = localStorage.oLongitudeDecDeg;
							ZoomLevel = 15;
							verorted = true;
						} else {
							lat = 47.360566;
							lng = 8.542829;
							ZoomLevel = 12;
							verorted = false;
						}
						latlng = new google.maps.LatLng(lat, lng);
						options = {
							zoom: ZoomLevel,
							center: latlng,
							streetViewControl: false,
							mapTypeId: google.maps.MapTypeId.HYBRID
						};
						mapcanvas = $('#MapCanvas');
						map = new google.maps.Map(mapcanvas[0],options);
						//google.maps.event.trigger(map,'resize');
						image = "Artgruppenbilder/" + localStorage.aArtGruppe + ".png";
						if (verorted === true) {
							marker = new google.maps.Marker({
								position: latlng, 
								map: map,
								//title muss String sein
								title: localStorage.aArtName.toString() || "",
								icon: image,
								draggable: true
							});
							//Marker in Array speichern, damit er gelöscht werden kann
							markersArray.push(marker); 
							contentString = '<div id="content">'+
								'<h4 id="firstHeading" class="GmInfowindow">' + localStorage.aArtName + '</h4>'+
								'<div id="bodyContent" class="GmInfowindow">'+
								'<p>Art-Gruppe: ' + localStorage.aArtGruppe + '</p>'+
								'<p>Autor: ' + window.Beobachtung.aAutor + '</p>'+
								'<p>Datum: ' + window.Beobachtung.zDatum + '</p>'+
								'<p>Zeit: ' + window.Beobachtung.zUhrzeit + '</p>'+
								'<p>Koordinaten: ' + localStorage.oXKoord + "/" + localStorage.oYKoord + '</p>' +
								'</div>'+
								'</div>';
							infowindow = new google.maps.InfoWindow({
								content: contentString
							});
							InfoWindowArray.push(infowindow);
							google.maps.event.addListener(marker, 'click', function () {
								infowindow.open(map,marker);
							});
							google.maps.event.addListener(marker, "dragend", function (event) {
								SetLocationBeobEdit(event.latLng, map, marker);
							});
						}
						google.maps.event.addListener(map, 'click', function (event) {
							placeMarkerBeobEdit(event.latLng, map, marker, image);
						});
					}

					//wird benutzt in hOrtEdit.html
					function placeMarkerhOrtEdit(location, map, marker) {
						var marker;
						//zuerst bisherige Marker löschen
						clearMarkers();
						marker = new google.maps.Marker({
							position: location, 
							map: map,
							//title muss String sein
							title: window.hOrt.oName.toString() || "",
							draggable: true
						});
						//Marker in Array speichern, damit er gelöscht werden kann
						markersArray.push(marker);
						google.maps.event.addListener(marker, "dragend", function (event) {
							SetLocationhOrtEdit(event.latLng, map, marker);
						});
						SetLocationhOrtEdit(location, map, marker);
					}

					function placeMarkerBeobEdit(location, map, marker, image) {
						//zuerst bisherigen Marker löschen
						clearMarkers();
						var marker = new google.maps.Marker({
							position: location, 
							map: map,
							//title muss String sein
							title: localStorage.aArtName.toString() || "",
							icon: image,
							draggable: true
						});
						//Marker in Array speichern, damit er gelöscht werden kann
						markersArray.push(marker);
						google.maps.event.addListener(marker, "dragend", function (event) {
							SetLocationBeobEdit(event.latLng, map, marker);
						});
						SetLocationBeobEdit(location, map, marker);
					}

					//wird benutzt in hOrtEdit.html
					function SetLocationhOrtEdit(LatLng, map, marker) {
						var lat, lng, contentString, infowindow;
						lat = LatLng.lat();
						lng = LatLng.lng();
						localStorage.oLatitudeDecDeg = lat;
						localStorage.oLongitudeDecDeg = lng;
						localStorage.oXKoord = DdInChX(lat, lng);
						localStorage.oYKoord = DdInChY(lat, lng);
						localStorage.oLagegenauigkeit = "Auf Luftbild markiert";
						clearInfoWindows();
						contentString = '<div id="content">'+
									'<div id="siteNotice">'+
									'</div>'+
									'<div id="bodyContent" class="GmInfowindow">'+
									'<p>Projekt: ' + window.hOrt.pName + '</p>'+
									'<p>Raum: ' + window.hOrt.rName + '</p>'+
									'<p>Ort: ' + window.hOrt.oName + '</p>'+
									'<p>Koordinaten: ' + localStorage.oXKoord + " / " + localStorage.oYKoord + '</p>' +
									'</div>'+
									'</div>';
						infowindow = new google.maps.InfoWindow({
							content: contentString
						});
						InfoWindowArray.push(infowindow);
						google.maps.event.addListener(marker, 'click', function () {
						infowindow.open(map,marker);
						});
						speichereKoordinaten(localStorage.OrtId, "hOrt");
					}

					//wird benutzt in BeobEdit.html
					function SetLocationBeobEdit(LatLng, map, marker) {
						var lat, lng, contentString, infowindow;
						lat = LatLng.lat();
						lng = LatLng.lng();
						localStorage.oLatitudeDecDeg = lat;
						localStorage.oLongitudeDecDeg = lng;
						localStorage.oXKoord = DdInChX(lat, lng);
						localStorage.oYKoord = DdInChY(lat, lng);
						localStorage.oLagegenauigkeit = "Auf Luftbild markiert";
						clearInfoWindows();
						contentString = '<div id="content">'+
								'<h4 id="firstHeading" class="GmInfowindow">' + localStorage.aArtName + '</h4>'+
								'<div id="bodyContent" class="GmInfowindow">'+
								'<p>Art-Gruppe: ' + localStorage.aArtGruppe + '</p>'+
								'<p>Autor: ' + $("#aAutorBE").val() + '</p>'+
								'<p>Datum: ' + $("#zDatumBE").val() + '</p>'+
								'<p>Zeit: ' + $("#zUhrzeitBE").val() + '</p>'+
								'<p>Koordinaten: ' + localStorage.oXKoord + " / " + localStorage.oYKoord + '</p>' +
								'</div>'+
								'</div>';
						infowindow = new google.maps.InfoWindow({
							content: contentString
						});
						InfoWindowArray.push(infowindow);
						google.maps.event.addListener(marker, 'click', function () {
							infowindow.open(map,marker);
						});
						speichereKoordinaten(localStorage.BeobId, "Beobachtung");
					}

					//GoogleMap: alle Marker löschen
					//benutzt wo in GoogleMaps Marker gesetzt und verschoben werden
					function clearMarkers() {
						if (markersArray) {
							for (i in markersArray) {
								markersArray[i].setMap(null);
							}
						}
					}

					//GoogleMap: alle InfoWindows löschen
					//benutzt wo in GoogleMaps Infowindows neu gesetzt werden müssen, weil die Daten verändert wurden
					function clearInfoWindows() {
						if (InfoWindowArray) {
							for (i in InfoWindowArray) {
								InfoWindowArray[i].setMap(null);
							}
						}
					}
				});

				$("#KartePage").on("pageinit", function () {
					//zurück-Button steuern
					$("#KarteHeader").on('click', '#ZurueckKarte', function (event) {
						var zurueck;
						event.preventDefault();
						if (localStorage.zurueck) {
							zurueck = localStorage.zurueck + ".html";
						} else {
							zurueck = "BeobListe.html";
						}
						$.mobile.changePage(zurueck);
						delete localStorage.zurueck;
					});
				});

				$("#KartePage").on("pagehide", function () {
					//leeren, damit bei erneuten Öffnen die Karte nicht zweimal aufgebaut wird
					$("#MapCanvas").html("");
				});
			</script>
		</div>
	</body>
</html>