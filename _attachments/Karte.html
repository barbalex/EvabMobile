<!DOCTYPE html>
<html>
	<head>
		<link rel="SHORTCUT ICON" href="Bilder/favicon.ico">
		<meta http-equiv=Content-Type content="text/html; charset=UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<title>EvAB</title>
		<link rel="stylesheet" href="style/jquery.mobile.css" type="text/css"/>
		<link rel="stylesheet" href="style/evab.css" type="text/css"/>
		<style type="text/css">.ui-icon-evab-location {background-image:url('Bilder/evab-location.png');}</style>
		<link rel="stylesheet" href="style/jquery.mobile.datebox.css" type="text/css"/>
		<link rel="stylesheet" href="style/jquery.mobile.simpledialog.css" type="text/css"/>
		<script type="text/javascript" src="vendor/couchapp/jquery.js"></script>
		<script type="text/javascript">
			$(document).on("mobileinit", function () {
				$.mobile.page.prototype.options.degradeInputs.date = 'text';
				$.mobile.page.prototype.options.degradeInputs.time = 'text';
				$.mobile.selectmenu.prototype.options.nativeMenu = false;
				$.event.special.swipe.horizontalDistanceThreshold = 250;
				$.mobile.buttonMarkup.hoverDelay = 0;
			});
		</script>
		<script type="text/javascript" src="vendor/couchapp/jquery.couch.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.couch.app.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.form.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.mobile.js"></script>
		<script type="text/javascript" src="vendor/couchapp/phonegap.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.mobile.datebox.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.mobile.simpledialog.js"></script>
		<script type="text/javascript" src="vendor/couchapp/evab.js"></script>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script type="text/javascript" src="vendor/couchapp/markerclusterer.js"></script>
		<script type="text/javascript" src="vendor/couchapp/markerwithlabel.js"></script>
	</head>
	<body>
		<div data-role="page" id="Karte" style="width:100%; height:100%;">
			<div data-role="header" id="KarteHeader" data-position="fixed" data-tap-toggle="false">
				<a href="#" id="ZurueckKarte" data-role="button" data-icon="arrow-l" data-iconpos="notext">zurück</a>
				<h1>Karte</h1>
			</div>
			<div data-role="content" style="width:100%; height:100%; padding:0;"> 
				<div id="MapCanvas" style="width:100%; height:100%;"></div>
			</div>
			<script type="text/javascript" charset="utf-8">
				
				$("#Karte").on("pageshow", function () {
					//Karten müssen in pageshow erstellt werden, weil sie sonst in Chrome nicht erscheinen
					var viewname, KeinOrtMeldung, contentHeight;
					//In diesem Array werden alle Marker gespeichert, damit sie gelöscht werden können
					//wird benutzt von: hOrtEdit.html, BeobEdit.html
					var markersArray = [];
					var InfoWindowArray = [];

					//sicherstellen, dass localStorage.zurueck existiert (gibt sonst später Fehler)
					if (!localStorage.zurueck) {
						window.open("BeobListe.html", target = "_self")
					}
					if (!localStorage.Username) {
						pruefeAnmeldung();
					}

					//Je nachdem, welche Seite die Karte aufruft, muss unterschiedlich vorgegangen werden
					switch(localStorage.zurueck) {
						case "hProjektListe":
							viewname = 'evab/hProjektlisteOrteFuerKarte?key="' + localStorage.Username + '"&include_docs=true';
							KeinOrtMeldung = "Es gibt keine Orte mit Koordinaten";
							erstelleKarteH();
							break;
						case "hProjektEdit":	//gleich wie hRaumListe
						case "hRaumListe":
							viewname = 'evab/hProjektOrteFuerKarte?startkey=["' + localStorage.Username + '", "' + localStorage.ProjektId + '"]&endkey=["' + localStorage.Username + '", "' + localStorage.ProjektId + '" ,{}]&include_docs=true';
							KeinOrtMeldung = "Es gibt keine Orte mit Koordinaten";
							erstelleKarteH();
							break;
						case "hRaumEdit":	//gleich wie hOrtListe
						case "hOrtListe":
							viewname = 'evab/hRaumOrteFuerKarte?startkey=["' + localStorage.Username + '", "' + localStorage.RaumId + '"]&endkey=["' + localStorage.Username + '", "' + localStorage.RaumId + '" ,{}]&include_docs=true';
							KeinOrtMeldung = "Es gibt keine Orte mit Koordinaten";
							erstelleKarteH();
							break;
						case "hOrtEdit":
							erstelleKartehOrtEdit();
							break;
						case "BeobListe":
							erstelleKarteBeobListe();
							break;
						case "BeobEdit":
							erstelleKarteBeobEdit();
							break;
					}

					//erstellt Karten für hProjektListe bis hOrtListe
					//im ersten Teil wird die Liste aller Orte erstellt und an den zweiten Teil übergeben
					function erstelleKarteH() {
						var contentHeight, hOrtLatLngListe;
						//Seitenhöhe korrigieren, weil sonst GoogleMap weiss bleibt
						contentHeight = $(window).height() - 44;
						$("#MapCanvas").css("height", contentHeight + "px");
						//zuständige hOrtLatLngListe ermitteln
						switch (localStorage.zurueck) {
							case "hProjektListe":
							hOrtLatLngListe = "hOrteLatLngProjektliste";
							break;
						case "hProjektEdit":	//gleich wie hRaumListe
						case "hRaumListe":
							hOrtLatLngListe = "hOrteLatLngProjekt";
							break;
						case "hRaumEdit":	//gleich wie hOrtListe
						case "hOrtListe":
							hOrtLatLngListe = "hOrteLatLngRaum";
							break;
						}
						//Liste der Orte holen. Prüfen, ob sie noch als Variable vorliegt
						if (window[hOrtLatLngListe]) {
							erstelleKarteH_2(window[hOrtLatLngListe]);
						} else if (localStorage[hOrtLatLngListe]) {
							window[hOrtLatLngListe] = JSON.parse(localStorage[hOrtLatLngListe]);
							erstelleKarteH_2(window[hOrtLatLngListe]);
						} else {
							$db = $.couch.db("evab");
							$db.view(viewname, {
								success: function (data) {
									window[hOrtLatLngListe] = data;
									localStorage[hOrtLatLngListe] = JSON.stringify(data);
									erstelleKarteH_2(data);
								}
							});
						}
					}

					function erstelleKarteH_2(hOrteLatLng) {
						var i, anzOrt, infowindow, Ort, lat, lng, latlng, options, map, bounds, markers, hOrtId, oName, oXKoord, oYKoord, lat2, lng2, latlng2, marker, contentString, mcOptions, markerCluster;
						anzOrt = 0;
						infowindow = new google.maps.InfoWindow();
						//Orte zählen
						for (i in hOrteLatLng.rows) {
							anzOrt += 1;
						}
						//Keine Orte: Hinweis und zurück
						if (anzOrt === 0) {
							melde(KeinOrtMeldung);
							history.back();
						//Orte vorhanden: Karte aufbauen
						} else {
							//Karte mal auf Zürich zentrieren, falls in den hOrteLatLng.rows keine Koordinaten kommen
							//auf die die Karte ausgerichtet werden kann
							lat = 47.383333;
							lng = 8.533333;
							latlng = new google.maps.LatLng(lat, lng);
							options = {
								zoom: 15,
								center: latlng,
								streetViewControl: false,
								mapTypeId: google.maps.MapTypeId.HYBRID
							};
							map = new google.maps.Map(document.getElementById("MapCanvas"),options);
							//google.maps.event.trigger(map,'resize');
							bounds = new google.maps.LatLngBounds();
							//für alle Orte Marker erstellen
							markers = [];
							for (i in hOrteLatLng.rows) {
								Ort = hOrteLatLng.rows[i].doc;
								hOrtId = Ort._id;
								oName = Ort.oName;
								oXKoord = Ort.oXKoord;
								oYKoord = Ort.oYKoord;
								lat2 = Ort.oLatitudeDecDeg;
								lng2 = Ort.oLongitudeDecDeg;
								latlng2 = new google.maps.LatLng(lat2, lng2);
								if (anzOrt === 1) {
									//map.fitbounds setzt zu hohen zoom, wenn nur eine Beobachtung erfasst wurde > verhindern
									latlng = latlng2;
								} else {
									//Kartenausschnitt um diese Koordinate erweitern
									bounds.extend(latlng2);
								}
								marker = new MarkerWithLabel({ 
									map: map,
									position: latlng2,
									title: oName.toString(),
									labelContent: oName,
									labelAnchor: new google.maps.Point(22, 0),
									labelClass: "MapLabel", // the CSS class for the label
									labelStyle: {opacity: 0.75}
								});
								markers.push(marker);
								contentString = '<div id="content">'+
									'<div id="siteNotice">'+
									'</div>'+
									'<h4 id="firstHeading" class="GmInfowindow">' + oName + '</h4>'+
									'<div id="bodyContent" class="GmInfowindow">'+
									'<p>X-Koordinate: ' + oXKoord + '</p>'+
									'<p>Y-Koordinate: ' + oYKoord + '</p>'+
									"<p><a href=\"#\" onclick=\"oeffneOrt('" + hOrtId + "')\">bearbeiten<\/a></p>"+
									'</div>'+
									'</div>';
								makeListener(map, marker, contentString);
							}
							mcOptions = {maxZoom: 17};
							markerCluster = new MarkerClusterer(map, markers, mcOptions);
							if (anzOrt === 1) {
								//map.fitbounds setzt zu hohen zoom, wenn nur eine Beobachtung erfasst wurde > verhindern
								map.setCenter(latlng);
								map.setZoom(18);
							} else {
								//Karte auf Ausschnitt anpassen
								map.fitBounds(bounds);
							}
						}

						//diese Funktion muss hier sein, damit infowindow bekannt ist
						function makeListener(map, marker, contentString) {
							google.maps.event.addListener(marker, 'click', function () {
								infowindow.setContent(contentString);
								infowindow.open(map,marker);
							});
						}
					}

					//wird benutzt in hOrtEdit.html
					function erstelleKartehOrtEdit() {
						var map, verorted, lat, lng, ZoomLevel, latlng, options, map, oName, marker, contentString, infowindow;
						//Seitenhöhe korrigieren, weil sonst GoogleMap weiss bleibt
						contentHeight = $(window).height() - 44;
						$("#MapCanvas").css("height", contentHeight + "px");
						if (localStorage.oLatitudeDecDeg && localStorage.oLongitudeDecDeg) {
							lat = localStorage.oLatitudeDecDeg;
							lng = localStorage.oLongitudeDecDeg;
							ZoomLevel = 15;
							verorted = true;
						} else {
							lat = 47.360566;
							lng = 8.542829;
							ZoomLevel = 12;
							verorted = false;
						}
						latlng = new google.maps.LatLng(lat, lng);
						options = {
							zoom: ZoomLevel,
							center: latlng,
							streetViewControl: false,
							mapTypeId: google.maps.MapTypeId.HYBRID
						};
						map = new google.maps.Map(document.getElementById("MapCanvas"),options);
						oName = $("#oName").val();
						if (verorted === true) {
							marker = new google.maps.Marker({
								position: latlng, 
								map: map, 
								title: oName,
								draggable: true
							});
							//Marker in Array speichern, damit er gelöscht werden kann
							markersArray.push(marker);
							contentString = '<div id="content">'+
											'<div id="siteNotice">'+
											'</div>'+
											'<h4 id="firstHeading" class="GmInfowindow">' + oName + '</h4>'+
											'<div id="bodyContent" class="GmInfowindow">'+
											'<p>X-Koordinate: ' + localStorage.oXKoord + '</p>'+
											'<p>Y-Koordinate: ' + localStorage.oYKoord + '</p>'+
											'</div>'+
											'</div>';
							infowindow = new google.maps.InfoWindow({
								content: contentString
							});
							InfoWindowArray.push(infowindow);
							google.maps.event.addListener(marker, 'click', function () {
							infowindow.open(map,marker);
							});
							google.maps.event.addListener(marker, "dragend", function (event) {
								SetLocationhOrtEdit(event.latLng, map, marker);
							});
						}
						google.maps.event.addListener(map, 'click', function (event) {
							placeMarkerhOrtEdit(event.latLng, map, marker, oName);
						});
					}

					//wird benutzt in BeobListe.html
					function erstelleKarteBeobListe() {
						var contentHeight;
						//Seitenhöhe korrigieren, weil sonst GoogleMap weiss bleibt
						contentHeight = $(window).height() - 44;
						$("#MapCanvas").css("height", contentHeight + "px");
						//Beobachtungen holen. Prüfen, ob die Liste noch da ist
						if (window.BeobListeLatLng) {
							erstelleKarteBeobListe_2();
						} else if (localStorage.BeobListeLatLng) {
							window.BeobListeLatLng = JSON.parse(localStorage.BeobListeLatLng);
							erstelleKarteBeobListe_2();
						} else {
							if (!localStorage.Username) {
								pruefeAnmeldung();
							}
							$db = $.couch.db("evab");
							$db.view('evab/BeobListeLatLng?key="' + localStorage.Username + '"&include_docs=true', {
								success: function (data) {
									window.BeobListeLatLng = data;
									localStorage.BeobListeLatLng = JSON.stringify(data);
									erstelleKarteBeobListe_2();
								}
							});
						}
					}

					function erstelleKarteBeobListe_2() {
						var i, anzBeob, beob, key, image, infowindow, lat, lng, latlng, options, map, bounds, marker, markers;
						anzBeob = 0;
						infowindow = new google.maps.InfoWindow();
						for (i in BeobListeLatLng.rows) {
							//Beobachtungen zählen
							anzBeob += 1;
						}
						if (anzBeob === 0) {
							//Keine Beobachtungen: Hinweis und zurück
							melde("Es wurden noch keine Beobachtungen mit Koordinaten erfasst");
							$.mobile.changePage("#BeobListePage");
						} else {
							//Beobachtungen vorhanden: Karte aufbauen
							lat = 47.383333;
							lng = 8.533333;
							latlng = new google.maps.LatLng(lat, lng);
							options = {
								zoom: 15,
								center: latlng,
								streetViewControl: false,
								mapTypeId: google.maps.MapTypeId.HYBRID
							};
							map = new google.maps.Map(document.getElementById("MapCanvas"),options);
							//google.maps.event.trigger(map,'resize');
							bounds = new google.maps.LatLngBounds();
							//für alle Beobachtungen Marker erstellen
							markers = [];
							for (i in BeobListeLatLng.rows) {
								beob = BeobListeLatLng.rows[i].doc;
								var BeobId = beob._id;
								var Datum = beob.zDatum;
								var Zeit = beob.zUhrzeit;
								var ArtGruppe = beob.aArtGruppe;
								image = "Artgruppenbilder/" + ArtGruppe + ".png";
								var ArtName = beob.aArtName;
								var Autor = beob.aAutor;
								var lat2 = beob.oLatitudeDecDeg;
								var lng2 = beob.oLongitudeDecDeg;
								var latlng2 = new google.maps.LatLng(lat2, lng2);
								if (anzBeob === 1) {
									//map.fitbounds setzt zu hohen zoom, wenn nur eine Beobachtung erfasst wurde > verhindern
									latlng = latlng2;
								} else {
									//Kartenausschnitt um diese Koordinate erweitern
									bounds.extend(latlng2);
								}
								marker = new MarkerWithLabel({ 
									map: map,
									position: latlng2,  
									title: ArtName,
									icon: image,
									labelContent: ArtName,
									labelAnchor: new google.maps.Point(22, 0),
									labelClass: "MapLabel", // the CSS class for the label
									labelStyle: {opacity: 0.75}
								});
								markers.push(marker);
								var contentString = '<div id="content">'+
									'<div id="siteNotice">'+
									'</div>'+
									'<h4 id="firstHeading" class="GmInfowindow">' + ArtName + '</h4>'+
									'<div id="bodyContent" class="GmInfowindow">'+
									'<p>Art-Gruppe: ' + ArtGruppe + '</p>'+
									'<p>Autor: ' + Autor + '</p>'+
									'<p>Datum: ' + Datum + '</p>'+
									'<p>Zeit: ' + Zeit + '</p>'+
									"<p><a <a href=\"#\" onclick=\"oeffneBeob('" + BeobId + "')\">bearbeiten<\/a></p>"+
									'</div>'+
									'</div>';
								makeListener(map, marker, contentString);
							}
							var mcOptions = {maxZoom: 17};
							var markerCluster = new MarkerClusterer(map, markers, mcOptions);
							if (anzBeob === 1) {
								//map.fitbounds setzt zu hohen zoom, wenn nur eine Beobachtung erfasst wurde > verhindern
								map.setCenter(latlng);
								map.setZoom(18);
							} else {
								//Karte auf Ausschnitt anpassen
								map.fitBounds(bounds);
							}
						}
						//listener schaffen, der bei Klick auf Marker dessen Fenster öffnet
						function makeListener(map, marker, contentString) {
							google.maps.event.addListener(marker, 'click', function () {
								infowindow.setContent(contentString);
								infowindow.open(map,marker);
							});
						}
					}

					function erstelleKarteBeobEdit() {
						var map, verorted, lat, lng, ZoomLevel, latlng, options, mapcanvas, map, aAutor, zDatum, zUhrzeit, image, marker, contentString, infowindow;
						//Seitenhöhe korrigieren, weil sonst GoogleMap weiss bleibt
						contentHeight = $(window).height() - 44;
						$("#MapCanvas").css("height", contentHeight + "px");
						if (localStorage.oLatitudeDecDeg && localStorage.oLongitudeDecDeg) {
							lat = localStorage.oLatitudeDecDeg;
							lng = localStorage.oLongitudeDecDeg;
							ZoomLevel = 15;
							verorted = true;
						} else {
							lat = 47.360566;
							lng = 8.542829;
							ZoomLevel = 12;
							verorted = false;
						}
						latlng = new google.maps.LatLng(lat, lng);
						options = {
							zoom: ZoomLevel,
							center: latlng,
							streetViewControl: false,
							mapTypeId: google.maps.MapTypeId.HYBRID
						};
						mapcanvas = $('#MapCanvas');
						map = new google.maps.Map(mapcanvas[0],options);
						//google.maps.event.trigger(map,'resize');
						aAutor = $("#aAutor").val();
						zDatum = $("#zDatum").val();
						zUhrzeit = $("#zUhrzeit").val();
						image = "Artgruppenbilder/" + localStorage.aArtGruppe + ".png";
						if (verorted === true) {
							marker = new google.maps.Marker({
								position: latlng, 
								map: map, 
								title: localStorage.aArtName,
								icon: image,
								draggable: true
							});
							//Marker in Array speichern, damit er gelöscht werden kann
							markersArray.push(marker); 
							contentString = '<div id="content">'+
								'<h4 id="firstHeading" class="GmInfowindow">' + localStorage.aArtName + '</h4>'+
								'<div id="bodyContent" class="GmInfowindow">'+
								'<p>Art-Gruppe: ' + localStorage.aArtGruppe + '</p>'+
								'<p>Autor: ' + aAutor + '</p>'+
								'<p>Datum: ' + zDatum + '</p>'+
								'<p>Zeit: ' + zUhrzeit + '</p>'+
								'</div>'+
								'</div>';
							infowindow = new google.maps.InfoWindow({
								content: contentString
							});
							InfoWindowArray.push(infowindow);
							google.maps.event.addListener(marker, 'click', function () {
							infowindow.open(map,marker);
							});
							google.maps.event.addListener(marker, "dragend", function (event) {
								SetLocationBeobEdit(event.latLng, map, marker);
							});
						}
						google.maps.event.addListener(map, 'click', function (event) {
							placeMarkerBeobEdit(event.latLng, map, marker, image);
						});
					}

					//wird benutzt in hOrtEdit.html
					function placeMarkerhOrtEdit(location, map, marker, oName) {
						var marker;
						//zuerst bisherige Marker löschen
						clearMarkers();
						marker = new google.maps.Marker({
							position: location, 
							map: map,
							title: oName,
							draggable: true
						});
						//Marker in Array speichern, damit er gelöscht werden kann
						markersArray.push(marker);
						google.maps.event.addListener(marker, "dragend", function (event) {
							SetLocationhOrtEdit(event.latLng, map, marker);
						});
						SetLocationhOrtEdit(location, map, marker);
					}

					function placeMarkerBeobEdit(location, map, marker, image) {
						//zuerst bisherigen Marker löschen
						clearMarkers();
						var marker = new google.maps.Marker({
							position: location, 
							map: map,
							title: localStorage.aArtName,
							icon: image,
							draggable: true
						});
						//Marker in Array speichern, damit er gelöscht werden kann
						markersArray.push(marker);
						google.maps.event.addListener(marker, "dragend", function (event) {
							SetLocationBeobEdit(event.latLng, map, marker);
						});
						SetLocationBeobEdit(location, map, marker);
					}

					//wird benutzt in hOrtEdit.html
					function SetLocationhOrtEdit(LatLng, map, marker) {
						var lat, lng, contentString, infowindow;
						lat = LatLng.lat();
						lng = LatLng.lng();
						localStorage.oLatitudeDecDeg = lat;
						localStorage.oLongitudeDecDeg = lng;
						localStorage.oXKoord = DdInChX(lat, lng);
						localStorage.oYKoord = DdInChY(lat, lng);
						clearInfoWindows();
						contentString = '<div id="content"><div id="bodyContent">'+
										'<p>' + localStorage.oXKoord + "/" + localStorage.oYKoord + '</p>' +
										'</div></div>';
						infowindow = new google.maps.InfoWindow({
							content: contentString
						});
						InfoWindowArray.push(infowindow);
						google.maps.event.addListener(marker, 'click', function () {
						infowindow.open(map,marker);
						});
						speichereKoordinaten(localStorage.OrtId, "Auf Luftbild markiert");
					}

					//wird benutzt in BeobEdit.html
					function SetLocationBeobEdit(LatLng, map, marker) {
						var lat, lng, contentString, infowindow;
						lat = LatLng.lat();
						lng = LatLng.lng();
						localStorage.oLatitudeDecDeg = lat;
						localStorage.oLongitudeDecDeg = lng;
						localStorage.oXKoord = DdInChX(lat, lng);
						localStorage.oYKoord = DdInChY(lat, lng);
						clearInfoWindows();
						contentString = '<div id="content"><div id="bodyContent">'+
										'<p>' + localStorage.oXKoord + "/" + localStorage.oYKoord + '</p>' +
										'</div></div>';
						infowindow = new google.maps.InfoWindow({
							content: contentString
						});
						InfoWindowArray.push(infowindow);
						google.maps.event.addListener(marker, 'click', function () {
						infowindow.open(map,marker);
						});
						speichereKoordinaten(localStorage.BeobId, "Auf Luftbild markiert");
					}

					//GoogleMap: alle Marker löschen
					//benutzt wo in GoogleMaps Marker gesetzt und verschoben werden
					function clearMarkers() {
						if (markersArray) {
							for (i in markersArray) {
								markersArray[i].setMap(null);
							}
						}
					}

					//GoogleMap: alle InfoWindows löschen
					//benutzt wo in GoogleMaps Infowindows neu gesetzt werden müssen, weil die Daten verändert wurden
					function clearInfoWindows() {
						if (InfoWindowArray) {
							for (i in InfoWindowArray) {
								InfoWindowArray[i].setMap(null);
							}
						}
					}
				});

				$("#Karte").on("pageinit", function () {
					//zurück-Button steuern
					$("#KarteHeader").on('click', '#ZurueckKarte', function (event) {
						var zurueck;
						event.preventDefault();
						if (localStorage.zurueck) {
							zurueck = localStorage.zurueck + ".html";
						} else {
							zurueck = "BeobListe.html";
						}
						$.mobile.changePage(zurueck);
						delete localStorage.zurueck;
					});
				});

				$("#Karte").on("pagehide", function () {
					//leeren, damit bei erneuten Öffnen die Karte nicht zweimal aufgebaut wird
					$("#MapCanvas").html("");
				});
			</script>
		</div>
	</body>
</html>