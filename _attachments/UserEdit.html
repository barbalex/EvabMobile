<!DOCTYPE html>
<html>
	<head>
		<link rel="SHORTCUT ICON" href="Bilder/favicon.ico">
		<meta http-equiv=Content-Type content="text/html; charset=UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<title>EvAB</title>
		<link rel="stylesheet" href="style/jquery.mobile.css" type="text/css"/>
		<link rel="stylesheet" href="style/evab.css" type="text/css"/>
		<link rel="stylesheet" href="style/jquery.mobile.datebox.css" type="text/css"/>
		<link rel="stylesheet" href="style/jquery.mobile.simpledialog.css" type="text/css"/>
		<script type="text/javascript" src="vendor/couchapp/jquery.js"></script>
		<script type="text/javascript">
			$(document).on("mobileinit", function () {
				$.mobile.page.prototype.options.degradeInputs.date = 'text';
				$.mobile.page.prototype.options.degradeInputs.time = 'text';
				$.mobile.selectmenu.prototype.options.nativeMenu = false;
				$.event.special.swipe.horizontalDistanceThreshold = 250;
				$.mobile.buttonMarkup.hoverDelay = 0;
			});
		</script>
		<script type="text/javascript" src="vendor/couchapp/jquery.couch.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.couch.app.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.form.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.mobile.js"></script>
		<script type="text/javascript" src="vendor/couchapp/phonegap.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.mobile.datebox.js"></script>
		<script type="text/javascript" src="vendor/couchapp/jquery.mobile.simpledialog.js"></script>
		<script type="text/javascript" src="vendor/couchapp/evab.js"></script>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script type="text/javascript" src="vendor/couchapp/markerclusterer.js"></script>
		<script type="text/javascript" src="vendor/couchapp/markerwithlabel.js"></script>
	</head>
	<body>
		<div data-role="page" id="UserEditPage">
			<div data-role="header" data-position="fixed" data-tap-toggle="false">
				<a href="#" id="zurückUserEdit" data-role="button" data-icon="arrow-l" data-iconpos="notext">zurück</a>
				<h2>meine Einstellungen</h2>
			</div>
			<div id="UserEditContent" data-role="content" style="padding:0em;">
				<form id="UserEditForm" action="#" method="get">
					<div data-role="fieldcontain">
						<label for="UserName">Benutzername:</label>
						<input id="UserName" type="text" disabled="disabled"/>
						<p>Der Benutzername kann nicht verändert werden.<br /><br />
						EvAB mobile speichert nur die verschlüsselte Form Ihres Passworts. Es kann deshalb nicht verändert werden und wird nicht angezeigt.</p>
					</div>
					<hr />
					<div data-role="fieldcontain">
						<label for="Autor">Autor:</label>
						<input id="Autor" name="Autor" class="Feld" type="text" placeholder="(erforderlich)" required/>
						<p>Eingabe empfohlen. Beschreiben Sie den Autor so, wie er in den Beobachtungen erscheinen soll. Beispiel: Fritz Muster, Zürich.</p>
					</div>
					<hr />
					<div data-role="fieldcontain">
						<label for="Email">email-Adresse:</label>
						<input id="Email" name="Email" class="Feld" type="email" placeholder="(erforderlich)" required/>
					</div>
					<hr />
					<div data-role="fieldcontain">
						<fieldset data-role="controlgroup">
							<legend>Sprache für Artnamen:</legend>
								<input type="radio" name="ArtenSprache" class="Feld" id="Lateinisch" value="Lateinisch"  />
								<label for="Lateinisch">Lateinisch (Standard)</label>
								<input type="radio" name="ArtenSprache" class="Feld" id="Deutsch" value="Deutsch"  />
								<label for="Deutsch">Deutsch</label>
						</fieldset>
						<p>Wenn Sie Deutsch wählen, können Sie nur Beobachtungen von Arten erfassen, die einen Deutschen Namen haben. Das ist - je nach Artengruppe - nur ein kleiner Teil der Arten!</p>
					</div>
					<hr />
					<div data-role="fieldcontain">
						<fieldset data-role="controlgroup">
							<legend>Meine Beobachtungen dürfen verwendet werden:</legend>
								<input type="radio" name="Datenverwendung" class="Feld" id="JaAber" value="JaAber"/>
								<label for="JaAber">ja, für Naturschutzzwecke (Standard)*</label>
								<input type="radio" name="Datenverwendung" class="Feld" id="Ja" value="Ja"/>
								<label for="Ja">ja, ohne Einschränkung</label>
								<input type="radio" name="Datenverwendung" class="Feld" id="Nein" value="Nein"/>
								<label for="Nein">nein</label>
						</fieldset>
					</div>
					<p>* Bei dieser Option werden die <a href="http://www.natportal.ch/data/deontologie_d.pdf" target="_blank">Datenschutzrichtlinien der Schweizerischen Nationalen Datenzentren für Fauna und Flora</a> eingehalten.<br /><br />Die zuständigen Naturschutzstellen von Bund, Kanton und Gemeinden verwenden die Informationen nur für Naturschutzzwecke. Beobachtungen von nicht besonders empfindlichen Arten können in grober räumlicher Auflösung publiziert werden (5*5km).<br /><br />Die Daten werden in die Datenbank der <a href="http://www.naturschutz.zh.ch" target="_blank">Fachstelle Naturschutz des Kantons Zürich</a> synchronisiert und von dort an die zuständigen Nationalen Artdatenzentren weitergeleitet: <a href="http://www.crsf.ch/" target="_blank">info Flora</a>, <a href="http://www.cscf.ch/" target="_blank">CSCF (Fauna)</a>, <a href="http://www.nism.uzh.ch" target="_blank">NISM (Moose)</a>, <a href="www.swissfungi.ch" target="_blank">Swissfungi (Pilze)</a>.</p>
				</form>
			</div>
			<script type="text/javascript">

				$("#UserEditPage").on("pageshow", function () {
					//Beim direkten Aufruf der Seite hat holeSessionStorageAusDb bei pageshow noch nicht beendet
					//darum prüfen, ob sessionStorage.UserEditWirdInitiiert nicht true ist
					//sonst übernimmt holeSessionStorageAusDb das initiieren
					if (!sessionStorage.UserEditWirdInitiiert) {
						initiiereUserEdit();
					}
					delete sessionStorage.UserEditWirdInitiiert;
				});

				$(":jqmData(role='page')").on("pageinit", function () {
					//Beim direkten Aufruf dieser Seite muss die sessionStorage aus der DB gelesen werden
					//wo sie von speichereLetzteUrl gespeichert wurde
					if (sessionStorage.length === 0) {
						holeSessionStorageAusDb("UserEdit");
						sessionStorage.UserEditWirdInitiiert = true;
					}

					//zurück-Button steuern
					$("#UserEditPage").on('click', '#zurückUserEdit', function (event) {
						event.preventDefault();
						//sicherstellen, dass er immer ein zurück kennt
						if (!sessionStorage.zurueck) {
							sessionStorage.zurueck = "BeobListe.html";
						}
						$.mobile.changePage(sessionStorage.zurueck);
						delete sessionStorage.zurueck;
					});

					//jedes Feld bei Änderung speichern
					$("#UserEditForm").on("change", ".Feld", function () {
						var Feldname, Feldjson, Feldwert;
						Feldname = this.name;
						//nötig, damit Arrays richtig kommen
						Feldjson = $("[name='" + Feldname + "']").serializeObject();
						Feldwert = Feldjson[Feldname];
						if (validiereUserUserEdit()) {
							speichern(Feldname, Feldwert);
						}
					});

					//kontrollierren, ob die erforderlichen Felder etwas enthalten
					//wenn ja wird true retourniert, sonst false
					function validiereUserUserEdit() {
						if (!$("#Autor").val()) {
							melde("Bitte Autor eingeben");
							setTimeout(function() { 
								$('#Autor').focus();
							}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
							return false;
						}
						if (!$("#Email").val()) {
							melde("Bitte email-Adresse eingeben");
							setTimeout(function() { 
								$('#Email').focus();
							}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
							return false;
						}
						return true;
					}

					function speichern(Feldname, Feldwert) {
						$db = $.couch.db("evab");
						$db.openDoc(sessionStorage.UserId, {
							success: function (doc) {
									if (Feldwert) {
										doc[Feldname] = Feldwert;
									} else if (doc[Feldname]) {
										delete doc[Feldname]
									}
									if (Feldname === "ArtenSprache") {
										sessionStorage.ArtenSprache = Feldwert;
									}
								$db.saveDoc(doc, {
									error: function () {
										melde("Fehler: Änderung in " + Feldname + " nicht gespeichert");
									}
								});
							}
						});
					}
				});
			</script>
		</div>
	</body>
</html>