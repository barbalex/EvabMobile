<!DOCTYPE html>
<html lang="de">
	<head>
		<link rel="SHORTCUT ICON" href="Bilder/favicon.ico">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>EvAB</title>
		<link rel="stylesheet" href="style/jquery.mobile.css">
		<link rel="stylesheet" href="style/themes/gruen.min.css">
		<link rel="stylesheet" href="style/evab.css">
		<link rel="stylesheet" href="style/jquery.mobile.datebox.css">
		<script src="vendor/couchapp/jquery.js"></script>
		<script src="vendor/couchapp/jquery-migrate.js"></script>
		<script>
			$(document).on("mobileinit", function () {
				$.mobile.page.prototype.options.degradeInputs.date = 'text';
				$.mobile.page.prototype.options.degradeInputs.time = 'text';
				$.mobile.selectmenu.prototype.options.nativeMenu = false;
				$.event.special.swipe.horizontalDistanceThreshold = 250;
				$.mobile.buttonMarkup.hoverDelay = 0;
			});
		</script>
		<script src="vendor/couchapp/jquery.couch.js"></script>
		<script src="vendor/couchapp/jquery.form.js"></script>
		<script src="vendor/couchapp/jquery.mobile.js"></script>
		<script src="vendor/couchapp/phonegap.js"></script>
		<script src="vendor/couchapp/jquery.mobile.datebox.js"></script>
		<script src="vendor/couchapp/evab.js"></script>
		<script src="vendor/couchapp/sha1.js"></script>
		<script src="https://maps.google.com/maps/api/js?sensor=false"></script>
		<script src="vendor/couchapp/markerclusterer.js"></script>
		<script src="vendor/couchapp/markerwithlabel.js"></script>
	</head>
	<body>
		<div data-role="page" id="UserEditPage">
			<div data-role="header" id="UserEditHeader" data-position="fixed" data-tap-toggle="false">
				<a href="#" id="zurückUserEdit" class="ui-btn ui-btn-inline ui-btn-icon-left ui-corner-all ui-icon-arrow-l ui-btn-icon-notext">zurück</a>
				<h2>meine Einstellungen</h2>
			</div>
			<div id="UserEditContent" data-role="content">
				<form id="UserEditForm" action="#" method="get">
					<div data-role="fieldcontain">
						<label for="ue_Email">Email:</label>
						<input id="ue_Email" name="Email" type="text" disabled="disabled">
						<p>Die Email kann nicht verändert werden.<br ><br >
						EvAB mobile speichert nur die verschlüsselte Form Ihres Passworts. Es kann deshalb nicht verändert werden und wird nicht angezeigt.</p>
					</div>
					<hr >
					<div data-role="fieldcontain">
						<label for="Autor">Autor:</label>
						<input id="Autor" name="Autor" type="text" placeholder="(erforderlich)" required>
						<p>Eingabe empfohlen. Beschreiben Sie den Autor so, wie er in den Beobachtungen erscheinen soll. Beispiel: Fritz Muster, Zürich.</p>
					</div>
					<hr >
					<div data-role="fieldcontain">
						<fieldset data-role="controlgroup">
							<legend>Meine Beobachtungen dürfen verwendet werden:</legend>
								<input type="radio" name="Datenverwendung" class="Feld" id="JaAber" value="JaAber">
								<label for="JaAber">ja, für Naturschutzzwecke (Standard)*</label>
								<input type="radio" name="Datenverwendung" class="Feld" id="Ja" value="Ja">
								<label for="Ja">ja, ohne Einschränkung</label>
								<input type="radio" name="Datenverwendung" class="Feld" id="Nein" value="Nein">
								<label for="Nein">nein</label>
						</fieldset>
					</div>
					<p>* Bei dieser Option werden die <a href="https://www2.unine.ch/files/content/sites/cscf/files/shared/documents/2013_Deontologie%20Infos%20Species_DE.pdf" target="_blank">Datenschutzrichtlinien der Schweizerischen Nationalen Datenzentren für Fauna und Flora</a> eingehalten.<br><br>Die zuständigen Naturschutzstellen von Bund, Kanton und Gemeinden verwenden die Informationen nur für Naturschutzzwecke. Beobachtungen von nicht besonders empfindlichen Arten können in grober räumlicher Auflösung publiziert werden (5*5km).<br><br>Die Daten werden in die Datenbank der <a href="http://www.naturschutz.zh.ch" target="_blank">Fachstelle Naturschutz des Kantons Zürich</a> synchronisiert und von dort an die zuständigen Nationalen Artdatenzentren weitergeleitet: <a href="http://www.infoflora.ch/" target="_blank">info flora</a>, <a href="http://www.cscf.ch/" target="_blank">CSCF (Fauna)</a>, <a href="http://www.nism.uzh.ch" target="_blank">NISM (Moose)</a>, <a href="http://www.swissfungi.ch" target="_blank">Swissfungi (Pilze)</a>.</p>
				</form>
			</div>
			<script>

				$("#UserEditPage").on("pageshow", function () {
					if (localStorage.length === 0 || !localStorage.Email) {
						leereAlleVariabeln();
						$.mobile.changePage("index.html");
					}
					initiiereUserEdit();
				});

				$(":jqmData(role='page')").on("pageinit", function () {
					// Wird diese Seite direkt aufgerufen und es gibt keinen localStorage,
					// muss auf index.html umgeleitet werden
					if (localStorage.length === 0 || !localStorage.Email) {
						leereAlleVariabeln();
						$.mobile.changePage("index.html");
					}

					// zurück-Button steuern
					$("#UserEditHeader").on('click', '#zurückUserEdit', function (event) {
						event.preventDefault();
						// sicherstellen, dass er immer ein zurück kennt
						if (!localStorage.zurueck) {
							localStorage.zurueck = "BeobListe.html";
						}
						$.mobile.changePage(localStorage.zurueck);
						delete localStorage.zurueck;
					});

					// jedes Feld bei Änderung speichern
					$("#UserEditForm").on("change", ".Feld", function () {
						var Feldname, Feldjson, Feldwert;
						Feldname = this.name;
						// nötig, damit Arrays richtig kommen
						Feldjson = $("[name='" + Feldname + "']").serializeObject();
						Feldwert = Feldjson[Feldname];
						if (validiereUserUserEdit()) {
							speichern(Feldname, Feldwert);
						}
					});

					$("#UserEditForm").on("change", "[name='Datenverwendung']", function () {
						localStorage.Datenverwendung = $(this).attr("id");
					});

					// Autor bei Änderung speichern
					$("#UserEditForm").on("change", "#Autor", function () {
						$db = $.couch.db("evab");
						$db.openDoc("f19cd49bd7b7a150c895041a5d02acb0", {
							success: function (doc) {
								if ($("#Autor").val()) {
									// Wenn Autor erfasst ist, speichern
									// Falls Standardwert noch nicht existiert, 
									// uss zuerst das Objekt geschaffen werden
									if (!doc.Standardwert) {
										doc.Standardwert = {};
									}
									doc.Standardwert[localStorage.Email] = $("#Autor").val();
								} else {
									// Wenn kein Autor erfasst ist, einen allfälligen löschen
									if (doc.Standardwert) {
										delete doc.Standardwert[localStorage.Email];
									}
								}
								$db.saveDoc(doc, {
									success: function () {
										// Feldliste soll neu aufgebaut werden
										leereStorageFeldListe();
										localStorage.Autor = $("#Autor").val();
									},
									error: function () {
										melde("Fehler: Änderung am Autor nicht gespeichert");
									}
								});
							},
							error: function () {
								melde("Fehler: Änderung am Autor nicht gespeichert");
							}
						});
					});
				});

				// kontrollierren, ob die erforderlichen Felder etwas enthalten
				// wenn ja wird true retourniert, sonst false
				function validiereUserUserEdit() {
					if (!$("#Autor").val()) {
						melde("Bitte Autor eingeben");
						setTimeout(function() { 
							$('#Autor').focus();
						}, 50);  // need to use a timer so that .blur() can finish before you do .focus()
						return false;
					}
					return true;
				}

				function speichern(Feldname, Feldwert) {
					if (localStorage.Datenverwendung) {
						$db = $.couch.db("evab");
						$db.openDoc(localStorage.Email, {
							success: function (doc) {
									if (Feldwert) {
										doc[Feldname] = Feldwert;
									} else if (doc[Feldname]) {
										delete doc[Feldname]
									}
								$db.saveDoc(doc, {
									error: function () {
										console.log('fehler in function speichern(that)');
										//melde("Fehler: Änderung in " + Feldname + " nicht gespeichert");
									}
								});
							},
							error: function () {
								console.log('fehler in function speichern(that)');
								//melde("Fehler: Änderung in " + Feldname + " nicht gespeichert");
							}
						});
					} else {
						// es gibt noch keine User-Doc
						// vielleicht hatte der User ein Konto bei ArtenDb erstellt und ist das erste mal in Evab
						speichereUserInEvab();
					}
				}
			</script>
		</div>
	</body>
</html>