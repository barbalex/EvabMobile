<!DOCTYPE html>
<html>
  <head>
  	<link rel="SHORTCUT ICON" href="Bilder/favicon.ico">
  	<META http-equiv=Content-Type content="text/html; charset=UTF-8"/>
  	<title>EvAB</title>
  	<link rel="stylesheet" href="style/main.css" type="text/css">
  	<link rel="stylesheet" href="style/jquery.mobile.css" type="text/css"/>
  	<link rel="stylesheet" href="style/evab.css" type="text/css"/>
  	<script src="vendor/couchapp/sha1.js" type="text/javascript"></script>
  </head>
  <body>
	<div data-role="page">
		<div data-role="header" data-backbtn="false">
			<h1>anmelden</h1>
		</div>
		<div data-role="content">
			<p style="text-align: center"><b>EvAB</b> = <b>E</b>rfassung <b>v</b>on <b>A</b>rt-<b>B</b>eobachtungen</p>
			<form id="LoginForm" action="#" method="get" autocomplete="on">
				<div data-role="fieldcontain">
					<label for="UserName">Benutzername:</label>
					<input id="UserName" name="UserName" type="text" autofocus required/>
				</div>
				<div data-role="fieldcontain">
					<label for="Passwort">Passwort:</label>
					<input id="Passwort" name="Passwort" type="password" required/>
				</div>
			</form>
			<p style="text-align: center">Sie sehen nur die eigenen Beobachtungen. Darum brauchen Sie ein Konto.</p>
		</div>
		<div data-role="footer">
			<div data-role="navbar">
				<ul>
					<li><a href="#" id="SubmitButton" data-icon="check" data-iconpos="left"  class="ui-btn-active">anmelden</a></li>
					<li><a href="Signup.html" id="SignupButton" data-icon="plus" data-iconpos="left" rel="external">Konto erstellen</a></li>
				</ul>
			</div><!-- /navbar -->
		</div><!-- /footer -->
	</div>
  </body>
  <script src="vendor/couchapp/loader.js"></script>
  <script type="text/javascript" charset="utf-8">;
	function handleDocumentReady()
	{
		$db = $.couch.db("evab-ch_barbalex_evab");
		//if (!("autofocus" in document.createElement("input"))) {
	    //  document.getElementById("UserName").focus();                      //FUNKTIONIERT NICHT? Gibt sogar Fehler in Firebug
	    //}
		
		$("#SubmitButton").tap(function(event) {
			var UserName = $('input[name=UserName]').val();
			var Passwort = $('input[name=Passwort]').val();
			if (UserName == "") {
				MeldungEinzeilig("Bitte Benutzernamen eingeben");
			} else if (Passwort==""){
				MeldungEinzeilig("Bitte Passwort eingeben");
			} else {
			submitEinloggen();
			}
		});
	}
	
	$(document).ready(handleDocumentReady);
  </script>
  <script type="text/javascript" charset="utf-8">	
  	function submitEinloggen() {
  		var name = $('input[name=UserName]').val();
		var pass = $('input[name=Passwort]').val();
		einloggen(name, pass);
  	}
	
	function einloggen(name, pass) {
  		//var elem = $(this);
  		
		$.couch.login({
			name : name,
			password : pass,
			success : function(r) {
				_init(name, pass);
			},
			error: function() {
				MeldungZweizeilig("Die Anmeldung ist gescheitert.", "Sie m√ºssen ev. ein Konto erstellen.");
			}
		});      
	}
	
	function _init(name, pass) {
		$$(this).userCtx = null;
		$.couch.session({
			success : function(r) {
				var userCtx = r.userCtx;
				User = userCtx.name;
				if (userCtx.name) {
					_replicate(name, pass);
					var Modus;
					$db.view("evab/User",
						{success: function(data) {
							var i;
							var doc;
							for(i in data.rows) {
								key = data.rows[i].key;
								doc = data.rows[i].value;
								if (key == User) {
									Modus = doc.Modus;
								}
							}
							if (Modus == "hierarchisch"){
								window.open("hProjektListe.html", target="_self");
							} else {
								window.open("BeobListe.html", target="_self");
							}
						}
					});
				} else if (userCtx.roles.indexOf("_admin") != -1) {
					MeldungEinzeilig("Oops, die Datenbank hat keine Benutzer!");
				} else {
					MeldungEinzeilig("Sie konnten nicht eingeloggt werden");
				}
			}
		});
	}

	function _replicate(name, pass){
		//$.couch.replicate("http://barbalex:dLhdMg12@barbalex.couchone.com/evab", "http://ch_barbalex_evab:123@127.0.0.1:5984/evab-ch_barbalex_evab",{continuous:true});
		//$.couch.replicate("http://ch_barbalex_evab:123@127.0.0.1:5984/evab-ch_barbalex_evab", "http://barbalex:dLhdMg12@barbalex.couchone.com/evab",{continuous:true});
	}
  </script>
</html>
