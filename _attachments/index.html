<!DOCTYPE html>
<html>
  <head>
  	<link rel="SHORTCUT ICON" href="Bilder/favicon.ico">
  	<META http-equiv=Content-Type content="text/html; charset=UTF-8"/>
  	<title>EvAB</title>
  	<link rel="stylesheet" href="style/main.css" type="text/css">
  	<link rel="stylesheet" href="style/jquery.mobile.css" type="text/css"/>
  	<link rel="stylesheet" href="style/evab.css" type="text/css"/>
  	<script src="vendor/couchapp/sha1.js" type="text/javascript"></script>
  </head>
  <body>
	<div data-role="page">
		<div data-role="header" data-backbtn="false">
			<h1>einloggen</h1>
		</div>
		<div data-role="content">
			<form id="LoginForm" action="#" method="get">
				<div data-role="fieldcontain">
					<label for="UserName">Benutzername:</label>
					<input id="UserName" name="UserName" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="Passwort">Passwort:</label>
					<input id="Passwort" name="Passwort" type="password"/>
					<p>Im App wird Ihr Passwort gar nicht über das Internet geschickt, auf der Webseite bloss in verschlüsselter Form.</p>
				</div>
				<p>Jeder Benutzer sieht ausschliesslich eigene Beobachtungen. Darum brauchen Sie ein Konto.</p>
			</form>
		</div>
		<div data-role="footer">
			<div data-role="navbar">
				<ul>
					<li><a href="#" id="SubmitButton" data-icon="check" data-iconpos="left"  class="ui-btn-active">anmelden</a></li>
					<li><a href="Signup.html" id="SignupButton" data-icon="plus" data-iconpos="left" rel="external">Konto erstellen</a></li>
				</ul>
			</div><!-- /navbar -->
		</div><!-- /footer -->
	</div>
  </body>
  <script src="vendor/couchapp/loader.js"></script>
  <script type="text/javascript" charset="utf-8">;
	function handleDocumentReady()
	{
		$db = $.couch.db("evab-ch_barbalex_evab");
		
		$("#SubmitButton").tap(function(event) {
			var UserName = $('input[name=UserName]').val();
			var Passwort = $('input[name=Passwort]').val();
			if (UserName == "") {
				MeldungEinzeilig("Bitte Benutzernamen eingeben");
			} else if (Passwort==""){
				MeldungEinzeilig("Bitte Passwort eingeben");
			} else {
			submitEinloggen();
			}
		});
	}
	
	$(document).ready(handleDocumentReady);
  </script>
  <script type="text/javascript" charset="utf-8">	
  	function submitEinloggen() {
  		var name = $('input[name=UserName]').val();
		var pass = $('input[name=Passwort]').val();
		einloggen(name, pass);
  	}
	
	function einloggen(name, pass) {
  		//var elem = $(this);
  		
		$.couch.login({
			name : name,
			password : pass,
			success : function(r) {
				_init(name, pass);
			},
			error: function() {
				MeldungZweizeilig("Die Anmeldung ist gescheitert.", "Sie müssen ev. ein Konto erstellen.");
			}
		});      
	}
	
	function _init(name, pass) {
		$$(this).userCtx = null;
		$.couch.session({
			success : function(r) {
				var userCtx = r.userCtx;
				if (userCtx.name) {
					_replicate(name, pass);
					window.open("BeobListe.html", target="_self");
				} else if (userCtx.roles.indexOf("_admin") != -1) {
					MeldungEinzeilig("Oops, die Datenbank hat keine Benutzer!");
				} else {
					MeldungEinzeilig("Sie konnten nicht eingeloggt werden");
				}
			}
		});
	}

	function _replicate(name, pass){
		//$.couch.replicate("http://barbalex:dLhdMg12@barbalex.couchone.com/evab", "http://ch_barbalex_evab:123@127.0.0.1:5984/evab-ch_barbalex_evab",{continuous:true});
		//$.couch.replicate("http://ch_barbalex_evab:123@127.0.0.1:5984/evab-ch_barbalex_evab", "http://barbalex:dLhdMg12@barbalex.couchone.com/evab",{continuous:true});
	}
  </script>
</html>
