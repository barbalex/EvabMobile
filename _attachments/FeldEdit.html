<!DOCTYPE html>
<html>
<head>
	<link rel="SHORTCUT ICON" href="Bilder/favicon.ico">
	<meta http-equiv=Content-Type content="text/html; charset=UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>EvAB</title>
	<link rel="stylesheet" href="style/jquery.mobile.css" type="text/css"/>
	<link rel="stylesheet" href="style/jquery.mobile.datebox.css" type="text/css"/>
	<link rel="stylesheet" href="style/jquery.mobile.simpledialog.css" type="text/css"/>
	<link rel="stylesheet" href="style/evab.css" type="text/css"/>
	<style type="text/css">.ui-icon-evab-location {background-image:url('Bilder/evab-location.png');}</style>
	<script type="text/javascript" src="vendor/couchapp/jquery.js"></script>
	<script type="text/javascript">
		$(document).on("mobileinit", function () {
			$.mobile.page.prototype.options.degradeInputs.date = 'text';
			$.mobile.page.prototype.options.degradeInputs.time = 'text';
			$.mobile.selectmenu.prototype.options.nativeMenu = false;
			$.event.special.swipe.horizontalDistanceThreshold = 250;
			$.mobile.buttonMarkup.hoverDelay = 0;
		});
	</script>
	<script type="text/javascript" src="vendor/couchapp/jquery.couch.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.couch.app.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.form.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.mustache.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.mobile.js"></script>
	<script type="text/javascript" src="vendor/couchapp/phonegap.js"></script>
	<script type="text/javascript" src="vendor/couchapp/evab.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.mobile.simpledialog.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" src="vendor/couchapp/markerclusterer.js"></script>
	<script type="text/javascript" src="vendor/couchapp/markerwithlabel.js"></script>
</head>
<body>
	<div data-role="page" id="FeldEditPage">
		<div data-role="header" data-position="fixed" data-tap-toggle="false" id="FeldEditHeader">
			<a href="#" id="BackButton" data-role="button" data-icon="arrow-l" data-iconpos="notext">abbrechen</a>
			<h2 class="FeldEditHeaderTitel">Datenfelder</h2>
			<a href='#' id='MenuFeldEdit' data-role='button' data-icon="wrench" data-iconpos="notext" class="r ui-btn-right">Menu</a>
		</div>
		<div id="FeldContent" data-role="content" style="padding:0em;">
			<form id="UserFeldForm" action="#" method="get" autocomplete="off">
				<h2>meine Einstellungen</h2>
				<div data-role="fieldcontain">
					<label for="SichtbarImModusEinfach">Sichtbar im einfachen Modus?</label>
					<select class="Feldeigenschaften" id="SichtbarImModusEinfach" data-role="slider">
						<option value="nein">nein</option>
						<option value="ja">ja</option>
					</select> 
				</div>
				<div data-role="fieldcontain">
					<label for="SichtbarImModusHierarchisch">Sichtbar im hierarchischen Modus?</label>
					<select class="Feldeigenschaften" id="SichtbarImModusHierarchisch" data-role="slider">
						<option value="nein">nein</option>
						<option value="ja">ja</option>
					</select> 
				</div>
				<div data-role="fieldcontain">
					<label for="Standardwert">Standardwert:</label>
					<input id="Standardwert" name="Standardwert" type="text" placeholder="dieser Wert wird bei neuen Beobachtungen in diesem Feld eingefügt"/>
				</div>
			</form>
				<hr>
				<h2>Feldeigenschaften</h2>
			<form id="FeldEditForm" action="#" method="get">
				<div data-role="fieldcontain">
					<fieldset data-role="controlgroup">
						<legend>Hierarchiestufe (erforderlich):</legend>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Projekt" value="Projekt"/>
							<label for="Projekt">Projekt</label>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Raum" value="Raum"/>
							<label for="Raum">Raum</label>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Ort" value="Ort"/>
							<label for="Ort">Ort</label>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Zeit" value="Zeit"/>
							<label for="Zeit">Zeit</label>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Art" value="Art"/>
							<label for="Art">Art</label>
					</fieldset>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldName">Name:</label>
					<input class="Feldeigenschaften required" id="FeldName" type="text" placeholder="erforderlich"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschriftung">Beschriftung:</label>
					<input class="Feldeigenschaften required" id="FeldBeschriftung" type="text" placeholder="erforderlich"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschreibung">Beschreibung:</label>
					<textarea class="Feldeigenschaften" id="FeldBeschreibung"></textarea>
				</div>
				<div data-role="fieldcontain">
					<label for="Reihenfolge">Reihenfolge:</label>
					<input class="Feldeigenschaften required" id="Reihenfolge" type="number" placeholder="erforderlich"/>
				</div>
				<div id="FeldFolgtNachDiv"></div>
				<div data-role="fieldcontain">
					<label for="FeldNameEvab">Name in EvAB:</label>
					<input class="Feldeigenschaften" id="FeldNameEvab" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameZdsf">Name beim ZDSF:</label>
					<input class="Feldeigenschaften" id="FeldNameZdsf" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameCscf">Name beim CSCF:</label>
					<input class="Feldeigenschaften" id="FeldNameCscf" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameNism">Name beim NISM:</label>
					<input class="Feldeigenschaften" id="FeldNameNism" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameWslFlechten">Name bei WSL Flechten:</label>
					<input class="Feldeigenschaften" id="FeldNameWslFlechten" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameWslPilze">Name bei WSL Pilze:</label>
					<input class="Feldeigenschaften" id="FeldNameWslPilze" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<fieldset data-role="controlgroup">
						<legend>Feldtyp:</legend>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="textinput" value="textinput"/>
							<label for="textinput">einfaches Feld (textinput)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="textarea" value="textarea"/>
							<label for="textarea">einfaches Feld, wächst mit Inhalt (textarea)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="toggleswitch" value="toggleswitch"/>
							<label for="toggleswitch">ja/nein (toggleswitch)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="slider" value="slider"/>
							<label for="slider">Schieber: Zahlen von min. Wert bis max. Wert (slider)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="selectmenu" value="selectmenu"/>
							<label for="selectmenu">Auswahlliste geschlossen, ein Wert möglich (selectmenu)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="multipleselect" value="multipleselect"/>
							<label for="multipleselect">Auswahlliste geschlossen, mehrere Werte möglich (multipleselect)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="radio" value="radio"/>
							<label for="radio">Auswahlliste offen, ein Wert möglich (radio)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="checkbox" value="checkbox"/>
							<label for="checkbox">Auswahlliste offen, mehrere Werte möglich (checkbox)</label>
					</fieldset>
				</div>
				<div data-role="fieldcontain">
					<fieldset data-role="controlgroup">
						<legend>Datentyp eines einfachen Feldes:</legend>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="text" value="text"/>
							<label for="text">Text</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="number" value="number"/>
							<label for="number">Zahl</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="date" value="date"/>
							<label for="date">Datum</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="time" value="time"/>
							<label for="time">Zeit</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="datetime" value="datetime"/>
							<label for="datetime">Datum und Zeit</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="email" value="email"/>
							<label for="email">email</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="url" value="url"/>
							<label for="url">url</label>
					</fieldset>
				</div>
				<div data-role="fieldcontain" id="Artgruppenliste">
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschreibung">Optionen in Auswahllisten:</label>
					<textarea class="Feldeigenschaften" id="Optionen" placeholder="Werte,mit,Komma,und,ohne,Leerzeichen,trennen. Erforderlich für Auswahllisten"></textarea>
				</div>
				<div data-role="fieldcontain">
					<label for="SliderMinimum">Kleinster Wert für Schieber:</label>
					<input class="Feldeigenschaften" id="SliderMinimum" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="SliderMaximum">Höchster Wert für Schieber:</label>
					<input class="Feldeigenschaften" id="SliderMaximum" type="text" />
				</div>
			</form>
		</div>
		<div data-role="footer" data-position="fixed" data-tap-toggle="false" id="FeldEditFooter">
			<div data-role="navbar">
				<ul>
					<li><a href="#" id="NeuesFeldFeldEdit" data-icon="plus" class="ui-btn-active">neu</a></li>			
					<li><a href="#" data-role="button" id="LoeschenLinkFeldEdit" data-icon="minus" forceinput="false">l&ouml;schen</a></li>
				</ul>
			</div><!-- /navbar -->
		</div><!-- /footer -->
		<script type="text/javascript">
			//Code, der bei Verwendung von ajax bei jedem Aufruf laufen soll (swipen)
			$("#FeldEditPage").on("pageshow", function () {
				//Beim direkten Aufruf der Seite hat holeSessionStorageAusDb bei pageshow noch nicht beendet
				//darum prüfen, ob sessionStorage.FeldId ungleich null ist
				//sonst übernimmt holeSessionStorageAusDb das initiieren
				if (sessionStorage.FeldId) {
					initiiereFeldEdit();
				}
			});

			//Code, der bei Verwendung von ajax nur beim ersten Aufruf der Seite laufen soll
			$(":jqmData(role='page')").on("pageinit", function () {
				//Beim direkten Aufruf dieser Seite muss die sessionStorage aus der DB gelesen werden
				//wo sie von speichereLetzteUrl gespeichert wurde
				if (sessionStorage.length === 0) {
					holeSessionStorageAusDb("FeldEdit");
				}

				//jedes Feld aus Feldeigenschaften bei Änderung speichern
				$("#FeldContent").on("change", ".Feldeigenschaften", function () {
					var FeldWert, FeldName, AlterFeldWert;
					if (!localStorage.Username) {
						pruefeAnmeldung();
					}
					FeldWert = this.value;
					FeldName = this.name;
					sessionStorage.FeldName = FeldName;
					//AlterFeldWert = this.defaultValue;
					AlterFeldWert = Feld[this.name];
					//alert(FeldName + " vorher: " + AlterFeldWert + ", neu: " + FeldWert);
					//Felder der Datenzentren dürfen nicht verändert werden
					//ausser Standardwert, dessen Änderung wird aber in einer anderen Funktion verarbeitet
					if (Feld.User === "ZentrenBdKt") {
						//Feldwert zurücksetzen	
						if (AlterFeldWert) {
							$("#" + FeldName).val(AlterFeldWert);
						} else {
							$("#" + FeldName).val("");
						}
						delete sessionStorage.FeldName;
						melde("Dies ist ein geschütztes Feld eines öffentlichen Datenzentrums<br><br>Sie können ein neues Feld erstellen");
					} else if (FeldName === "FeldName") {
						//Wenn eigener Feldname verändert wird, kontrollieren, dass er nicht schon verwendet wurde
						if (AlterFeldWert) {
							//wenn ein alter Feldname existiert,
							//zählen, in wievielen Datensätzen das Feld verwendet wird
							$db = $.couch.db("evab");
							$db.view('evab/FeldSuche?key="' + localStorage.Username + '"&include_docs=true', {
								success: function (data) {
									var i, anzVorkommen, Datensatz, TempFeld, ds;
									anzVorkommen = 0;
									for (i in data.rows) {
										if (typeof i !== "function") {
											Datensatz = data.rows[i].doc; 
											TempFeld = Datensatz[Feld.FeldName];
											if (TempFeld) {
												anzVorkommen += 1;
											}
										}
									}
									if (anzVorkommen === 0) {
										//prüfen, ob der Feldname schon existiert
										//wenn ja: melden, zurückstellen
										//wenn nein: speichern
										pruefeFeldNamen(AlterFeldWert);
									} else {
										ds = "Datensätzen";
										if (anzVorkommen === 1) {
											ds = "Datensatz";
										}
										$("#FeldName").val(Feld.FeldName);
										delete sessionStorage.FeldName;
										melde("Dieses Feld wird in " + anzVorkommen + " " + ds + " verwendet.<br>Es kann deshalb nicht verändert werden.<br>Bereinigen Sie zuerst die Daten.");
									}
								}
							});
						} else {
							//Vorher gab es keinen Feldnamen
							//prüfen, ob der Feldname schon existiert
							//wenn ja: melden, zurückstellen
							//wenn nein: speichern
							pruefeFeldNamen(AlterFeldWert);
						}
					} else if (FeldName === "Hierarchiestufe" && FeldWert === "Art") {
						speichereFeldeigenschaften();
						//Wenn die Hierarchiestufe zu Art geändert wird, muss das Feld für die Artgruppe aufgebaut werden
						ArtGruppeAufbauenFeldEdit();
					} else if (FeldName === "Hierarchiestufe" && FeldWert !== "Art") {
						speichereFeldeigenschaften();
						$db = $.couch.db("evab");
						$db.openDoc(Feld._id, {
							success: function (doc) {
								var letzteHierarchiestufe;
								letzteHierarchiestufe = doc.Hierarchiestufe;
								if (letzteHierarchiestufe === "Art") {
									//Wenn die Hierarchiestufe Art war und geändert wird, muss das Feld für die Artgruppe entfernt werden
									$("#Artgruppenliste").empty();
								}
							}
						});
					} else {
						speichereFeldeigenschaften();
					}
				});

				$("#FeldEditForm").on("change", "#FeldFolgtNach", function () {
					setzeReihenfolgeMitVorgaenger(this.value);
					//Feldliste soll neu aufgebaut werden
					delete window.Feldliste;
					delete sessionStorage.Feldliste;
				});

				$("#FeldEditFooter").on("click", "#NeuesFeldFeldEdit", function (event) {
					event.preventDefault();
					neuesFeld();
				});

				$("#UserFeldForm").on("change", "#Standardwert", function () {
					var Optionen, Feldwert, LetzterFeldwert, Formularelement, StandardwertOptionen;
					if (!localStorage.Username) {
						pruefeAnmeldung();
					}
					Optionen = $("#Optionen").val() || [];	//undefined verhindern
					Feldwert = this.value || [];	//undefined verhindern
					if (Optionen) {
						//es gibt Optionen. Der Standardwert muss eine oder allenfalls mehrere Optionen sein
						LetzterFeldwert = [];
						if (Feld.Standardwert) {
							if (Feld.Standardwert[localStorage.Username]) {
								LetzterFeldwert = Feld.Standardwert[localStorage.Username];
							}
						}
						//Standardwert in Array verwandeln
						StandardwertOptionen = [];
						if (Feldwert) {
							//Fehler verhindern, falls Feldwert undefined ist
							StandardwertOptionen = Feldwert.split(",");
						}
						if (["multipleselect", "checkbox"].indexOf(Feld.Formularelement) > -1) {
							//alle StandardwertOptionen müssen Optionen sein
							for (i in StandardwertOptionen) {
								if (typeof i !== "function") {
									if (Optionen.indexOf(StandardwertOptionen[i]) === -1) {
										//ein Wert ist keine Option, abbrechen
										$("#Standardwert").val(LetzterFeldwert);
										melde("Bitte wählen Sie eine oder mehrere der Optionen");
										return;
									}
								}
							}
							//alle Werte sind Optionen
							speichereStandardwert();
						} else if (["toggleswitch", "selectmenu", "radio"].indexOf(Feld.Formularelement) > -1) {
							//Array darf nur ein Element enthalten
							if (StandardwertOptionen.length > 1) {
								//Array enthält mehrere Optionen, nicht zulässig
								$("#Standardwert").val(LetzterFeldwert);
								melde("Bitte wählen Sie nur EINE der Optionen");
							} else {
								//Array enthält eine einzige Option
								for (i in StandardwertOptionen) {
									if (typeof i !== "function") {
										if (Optionen.indexOf(StandardwertOptionen[i]) === -1) {
											//der Wert ist keine Option, abbrechen
											$("#Standardwert").val(LetzterFeldwert);
											melde("Bitte wählen Sie eine der Optionen");
											return;
										}
									}
								}
								//alle Werte sind Optionen
								speichereStandardwert();
								return;
							}
						} else {
							//Optionen sind erfasst, Feld braucht aber keine. Alle Werte akzeptieren
							speichereStandardwert();
						}
					} else {
						//Es gibt keine Optionen. Alle Standardwerte akzeptieren
						speichereStandardwert();
					}
				});

				//Code für den Feld-Löschen-Dialog
				$('#FeldEditFooter').on('click', '#LoeschenLinkFeldEdit', function (event) {
					event.preventDefault();
					if (!localStorage.Username) {
						pruefeAnmeldung();
					}
					if (Feld.User === "ZentrenBdKt") {
						melde("Dies ist ein Feld eines nationalen Datenzentrums<br><br>Es kann nicht gelöscht werden<br><br>Sie können es ausblenden");
					} else {
						$(this).simpledialog({
							'mode' : 'bool',
							'prompt' : 'Dieses Feld löschen?',
							'forceInput': 'false',
							'buttons' : {
								'ja': {
									click: function () {
										$('#dialogoutput').text('ja');
										if (!Feld.FeldName) {
											//Ohne Feldname kann nicht kontrolliert werden, in wievielen Datensätzen das Feld vorkommt
											loescheFeld();
										} else {
											$db = $.couch.db("evab");
											//zählen, in wievielen Datensätzen das Feld verwendet wird
											$db.view('evab/FeldSuche?key="' + localStorage.Username + '"&include_docs=true', {
												success: function (data) {
													var i, anzVorkommen, Datensatz, TempFeld, ds;
													anzVorkommen = 0;
													for (i in data.rows) {
														if (typeof i !== "function") {
															Datensatz = data.rows[i].doc;
															TempFeld = Datensatz[Feld.FeldName];
															if (TempFeld) {
																anzVorkommen += 1;
															}
														}
													}
													if (anzVorkommen === 0) {
														loescheFeld();
													} else {
														ds = "Datensätzen";
														if (anzVorkommen === 1) {
															ds = "Datensatz";
														}
														melde("Löschen abgebrochen:<br>Dieses Feld wird in " + anzVorkommen + " " + ds + " verwendet<br>Bereinigen Sie zuerst die Daten");
													}
												}
											});
										}
									},
									icon: "delete",
									theme: "c"
								},
								'nein': {
									click: function () {
										$('#dialogoutput').text('nein');
									}
								}
							}
						})
					}
				});

				//Menu aufbauen
				$("#FeldEditHeader").on('click', "#MenuFeldEdit", function (event) {
					event.preventDefault();
					erstelleMenuFürFelder(this);
				});

				//BackButton steuern
				$("#FeldEditHeader").on('click', '#BackButton', function (event) {
					event.preventDefault();
					geheZurück();
				});

				//swipen steuern
				$("body").on("swipeleft", function () {
					geheZumNächstenFeld(Feld._id);
				});

				$("body").on("swiperight", function () {
					geheZumVorigenFeld(Feld._id);
				});

				//prüft neue oder umbenannte Feldnamen
				//bekommt den alten Feldwert (sofern einer existiert)
				function pruefeFeldNamen(FeldNameAlt) {
					var FeldNameNeu, viewname;
					if (!localStorage.Username) {
						pruefeAnmeldung();
					}
					FeldNameNeu = $("#FeldName").val();
					viewname = 'evab/FeldNamen?key="' + FeldNameNeu + '"';
					$db = $.couch.db("evab");
					$db.view(viewname, {
						success: function (data) {
							var i, key, TempFeld, AnzEigeneOderOffizielleFelderMitSelbemNamen;
							AnzEigeneOderOffizielleFelderMitSelbemNamen = 0;
							//durch alle Felder mit demselben Artnamen laufen
							//prüfen, ob sie eigene oder offielle sind
							if (data.rows) {
								for (i in data.rows) {
									if (typeof i !== "function") {
										if (data.rows[i].value) {
											TempFeld = data.rows[i].value;
											//ist es ein eigenes oder ein offizielles?
											if (TempFeld.User === localStorage.Username || TempFeld.User === "ZentrenBdKt") {
												//ja > dieser Name ist nicht zulässig
												AnzEigeneOderOffizielleFelderMitSelbemNamen += 1;
											}
										}
									}
								}
							}
							if (AnzEigeneOderOffizielleFelderMitSelbemNamen === 0) {
								//Feldname ist neu, somit zulässig > speichern
								//und alten FeldNamen aus der Liste der anzuzeigenden Felder entfernen
								$("#SichtbarImModusHierarchisch").val("ja");
								$("select#SichtbarImModusHierarchisch").slider("refresh");
								speichereFeldeigenschaften();
							} else {
								//Feldname kommt bei diesem User schon vor
								if (FeldnameAlt) {
									$("#FeldName").val(FeldNameAlt);
								} else {
									$("#FeldName").val("");
								}
								delete sessionStorage.FeldName;
								setTimeout(function () { 
									$('#FeldName').focus(); 
								}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
								melde("Dieser Feldname existiert schon<br>Wählen Sie einen anderen");
							}
						}
					});
				}

				function loescheFeld() {
					$db = $.couch.db("evab");
					$db.openDoc(Feld._id, {
						success: function (document) {
							$db.removeDoc(document, {
								success: function () {
									delete window.Feldliste;
									delete sessionStorage.Feldliste;
									delete sessionStorage.FeldId;
									delete sessionStorage.Feld;
									window.open("FeldListe.html", target = '_self');
								},
								error: function () {
									melde("Fehler: nicht gelöscht");
								}
							});
						},
						error: function () {
							melde("Fehler: nicht gelöscht");
						}
					});
					return false;
				}


				//Öffnet das nächste Feld
				//nächstes des letzten => melden
				//erwartet die ID des aktuellen Datensatzes
				function geheZumNächstenFeld(IdAktuell) {
					if (window.Feldliste) {
						//Feldliste aus globaler Variable verwenden - muss nicht geparst werden
						geheZumNächstenFeld_2(IdAktuell);
					} else if (sessionStorage.Feldliste) {
						//sessionStorage verwenden
						Feldliste = JSON.parse(sessionStorage.Feldliste);
						geheZumNächstenFeld_2(IdAktuell);
					} else {
						if (!localStorage.Username) {
							pruefeAnmeldung();
						}
						$db = $.couch.db("evab");
						$db.view('evab/FeldListe', {
							success: function (data) {
								Feldliste = data;
								sessionStorage.Feldliste = JSON.stringify(data);
								geheZumNächstenFeld_2(IdAktuell);
							}
						});
					}
				}

				function geheZumNächstenFeld_2(IdAktuell) {
					var i, y, FeldIdAktuell, FeldIdNächstes, AnzFelder, AktFeld_i, AktFeld_y;
					AnzFelder = Feldliste.rows.length -1;
					for (i in Feldliste.rows) {
						if (typeof i !== "function") {
							//alle Felder durchlaufen, aktuelles eigenes oder offizielles suchen
							AktFeld_i = Feldliste.rows[i].value;
							//vorsicht: Objekte zählen Elemente ab 1, Arrays ab 0!
							if (AktFeld_i.User === localStorage.Username || AktFeld_i.User === "ZentrenBdKt") {
								//Nur eigene und offizielle Felder berücksichtigen
								FeldIdAktuell = Feldliste.rows[i].value._id;
								if (FeldIdAktuell === IdAktuell) {
									//das ist das aktuelle Feld
									//von hier aus vorwärts das nächste eigene oder offizielle suchen
									if (i < AnzFelder) {
										//das aktuelle Feld ist nicht das letzte
										for (y = parseInt(i)+1; y <= AnzFelder; y++) {
											//alle verbleibenden Felder durchlaufen, eigenes suchen
											AktFeld_y = Feldliste.rows[y].value;
											//Nur eigene Felder und offizielle berücksichtigen
											if (AktFeld_y.User === localStorage.Username || AktFeld_y.User === "ZentrenBdKt") {
												//das ist das nächste eigene Feld > öffnen
												sessionStorage.FeldId = Feldliste.rows[parseInt(i)+1].value._id;
												alert("zu nächstem");
												initiiereFeldEdit();
											} else {
												if (y === AnzFelder) {
													//am letzten Feld angelangt und es ist kein eigenes
													melde("Das ist das letzte Feld");
												}
											}
										}
									} else {
										//das aktuelle Feld ist das letzte
										melde("Das ist das letzte Feld");
									}
								}
							}
						}
					}
				}

				//Öffnet das vorige Feld
				//voriges des ersten => FeldListe
				//erwartet die ID des aktuellen Datensatzes
				function geheZumVorigenFeld(IdAktuell) {
					if (window.Feldliste) {
						//Feldliste aus globaler Variable verwenden - muss nicht geparst werden
						geheZumVorigenFeld_2(IdAktuell);
					} else if (sessionStorage.Feldliste) {
						//sessionStorage verwenden
						Feldliste = JSON.parse(sessionStorage.Feldliste);
						geheZumVorigenFeld_2(IdAktuell);
					} else {
						if (!localStorage.Username) {
							pruefeAnmeldung();
						}
						$db = $.couch.db("evab");
						$db.view('evab/FeldListe', {
							success: function (data) {
								Feldliste = data;
								sessionStorage.Feldliste = JSON.stringify(data);
								geheZumVorigenFeld_2(IdAktuell);
							}
						});
					}
				}

				function geheZumVorigenFeld_2(IdAktuell) {
					var i, y, FeldIdAktuell, FeldIdVoriges, AnzFelder, AktFeld_i, AktFeld_y;
					AnzFelder = Feldliste.rows.length -1;
					for (i in Feldliste.rows) {
						if (typeof i !== "function") {
							//alle Felder durchlaufen, aktuelles eigenes oder offizielles suchen
							AktFeld_i = Feldliste.rows[i].value;
							//vorsicht: Objekte zählen Elemente ab 1, Arrays ab 0!
							if (AktFeld_i.User === localStorage.Username || AktFeld_i.User === "ZentrenBdKt") {
								//Nur eigene und offizielle Felder berücksichtigen
								FeldIdAktuell = Feldliste.rows[i].value._id;
								if (FeldIdAktuell === IdAktuell) {
									//das ist das aktuelle Feld
									//von hier aus rückwärts das nächste eigene oder offizielle suchen
									if (i > 0) {
										//das aktuelle Feld ist nicht das erste 
										for (y = parseInt(i)-1; y >= 0; y--) {
											//alle vorhergehenden Felder durchlaufen, eigenes suchen
											AktFeld_y = Feldliste.rows[y].value;
											//Nur eigene Felder und offizielle berücksichtigen
											if (AktFeld_y.User === localStorage.Username || AktFeld_y.User === "ZentrenBdKt") {
												//das ist das nächstvorherige eigene Feld > öffnen
												FeldIdVoriges = Feldliste.rows[parseInt(i)-1].value._id;
												sessionStorage.FeldId = FeldIdVoriges;
												alert("zu vorigem");
												initiiereFeldEdit();
											} else {
												if (y === 1) {
													//am ersten Feld angelangt und es ist kein eigenes
													//wir gehen zur Feldliste
													geheZurück();
												}
											}
										}
									} else {
										//das aktuelle Feld ist das erste
										//wir gehen zur Feldliste
										geheZurück();
									}
								}
							}
						}
					}
				}

				//empfängt den Feldnamen des gewählten Vorgängers
				//ermittelt dessen Reihenfolge
				//sucht das nächste eigene Feld und setzt als Reihenfolge den Mittelwert der zwei Reihenfolgen
				//Wenn kein weiteres eigenes Feld kommt, wird als Reihenfolge der nächste um mindestens 1 höhere ganzzahlige Wert gesetzt
				function setzeReihenfolgeMitVorgaenger(FeldNameVorgaenger) {
					var viewname;
					$db = $.couch.db("evab");
					viewname = 'evab/FeldListeFeldName?key="' + FeldNameVorgaenger + '"';
					$db.view(viewname, {
						success: function (data) {
							var ReihenfolgeVorgaenger;
							ReihenfolgeVorgaenger = data.rows[0].value.Reihenfolge;
							$("#Reihenfolge").val(Math.floor(ReihenfolgeVorgaenger + 1));
							speichereFeldeigenschaften();
						}
					});
				}

				function geheZurück() {
					delete sessionStorage.FeldId;
					delete sessionStorage.Feld;
					if (sessionStorage.zurueck.slice(0, 6) === "Felder") {
						//direkt zurück, Feldliste auslassen
						window.open(sessionStorage.zurueck, target = "_self");
						
					} else {
						window.open("FeldListe.html", target = "_self");
					}
				}

				function speichereStandardwert() {
					if (!localStorage.Username) {
						pruefeAnmeldung();
					}
					$db = $.couch.db("evab");
					$db.openDoc(Feld._id, {
						success: function (doc) {
							//Standardwert managen
							//Standardwert ist Objekt, in dem die Werte für jeden User gespeichert werden
							//darum manuell für diesen User updaten
							if (doc.Standardwert) {
								//Standardwert existierte
								if ($("#Standardwert").val()) {
									//neuen Standardwert setzen
									doc.Standardwert[localStorage.Username] = $("#Standardwert").val();
								} else {
									//Standardwert ist leer
									if (doc.Standardwert[localStorage.Username]) {
										//bisherigen Standardwert löschen
										delete doc.Standardwert[localStorage.Username];
									}
								}
							} else {
								//Bisher gab es noch keinen Standardwert
								if ($("#Standardwert").val()) {
									//Objekt für Standardwert schaffen und neuen Wert setzen
									doc.Standardwert = {};
									doc.Standardwert[localStorage.Username] = $("#Standardwert").val();
								}
							}
							$db.saveDoc(doc, {
								success: function (data) {
									Feld = data;
									sessionStorage.Feld = JSON.stringify(data);
									sessionStorage.FeldId = Feld._id;
								},
								error: function () {
									melde("Fehler: Feld nicht gespeichert");
								}
							});
						},
						error: function () {
							melde("Fehler: Feld nicht gespeichert");
						}
					});
				}

				//speichert
				function speichereFeldeigenschaften() {
					$db = $.couch.db("evab");
					$db.openDoc(Feld._id, {
						success: function (doc) {
							var Formularfelder, idx1, idx2;
							Formularfelder = $("#FeldEditForm").serializeObjectNull();
							//Felder mit Arrays: Kommagetrennte Werte in Arrays verwandeln. Plötzlich nicht mehr nötig??!!
							if (Formularfelder.Optionen) {
								Formularfelder.Optionen = Formularfelder.Optionen.split(",");
							}
							/*if (doc.ArtGruppe) {
								doc.ArtGruppe = doc.ArtGruppe.split(", ");
							}*/
							//Wenn Beschriftung fehlt und Name existiert: Beschriftung = Name
							if (!Formularfelder.FeldBeschriftung && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
								Formularfelder.FeldBeschriftung = Formularfelder.FeldName;
								//Feldliste soll neu aufgebaut werden
								delete window.Feldliste;
								delete sessionStorage.Feldliste;
							}
							//Es braucht eine Reihenfolge
							if (!Formularfelder.Reihenfolge && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
								Formularfelder.Reihenfolge = 1;
								//Feldliste soll neu aufgebaut werden
								delete window.Feldliste;
								delete sessionStorage.Feldliste;
							}
							//Es braucht einen Feldtyp
							if (!Formularfelder.Formularelement && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
								Formularfelder.Formularelement = "textinput";
								Formularfelder.InputTyp = "text";
							}
							//Wenn Feldtyp von textinput weg geändert wurde, sollte InputTyp entfernt werden
							if (Formularfelder.Formularelement !== "textinput" && Formularfelder.InputTyp) {
								delete Formularfelder.InputTyp;
								$("#" + Feld.InputTyp).prop("checked",false).checkboxradio("refresh");
							}
							//Wenn Feldtyp gesetzt wurde, muss ein InputTyp existieren. Wenn er nicht gesetzt wurde, text setzen
							if (Formularfelder.Formularelement === "textinput" && !Formularfelder.InputTyp) {
								Formularfelder.InputTyp = "text";
							}
							//Sichtbarkeitseinstellungen: In einem Array werden die User aufgelistet, welche das Feld sehen
							//Es muss geprüft werden, ob der aktuelle User in diesem Array enthalten ist
							//Soll das Feld im Modus einfach sichtbar sein?
							idx1 = doc.SichtbarImModusEinfach.indexOf(localStorage.Username);
							if ($("#SichtbarImModusEinfach").val() === "ja") {
								//User ergänzen, wenn noch nicht enthalten
								if (idx1 === -1) {
									doc.SichtbarImModusEinfach.push(localStorage.Username);
								}
							} else {
								//User entfernen, wenn enthalten
								if (idx1 !== -1) {
									doc.SichtbarImModusEinfach.splice(idx1, 1);
								}
							}
							//Soll das Feld im Modus hierarchisch sichtbar sein?
							idx2 = doc.SichtbarImModusHierarchisch.indexOf(localStorage.Username);
							if ($("#SichtbarImModusHierarchisch").val() === "ja") {
								//User ergänzen, wenn noch nicht enthalten
								if (idx2 === -1) {
									doc.SichtbarImModusHierarchisch.push(localStorage.Username);
								}
							} else {
								//User entfernen, wenn enthalten
								if (idx2 !== -1) {
									doc.SichtbarImModusHierarchisch.splice(idx2, 1);
								}
							}
							//Formularfelder in Dokument schreiben
							for (i in Formularfelder) {
								if (typeof i !== "function") {
									if (Formularfelder[i]) {
										if (i === "Reihenfolge" || i === "SliderMinimum" || i === "SliderMaximum") {
											//Zahl wird sonst in Text verwandelt und falsch sortiert
											doc[i] = parseInt(Formularfelder[i]);
										} else {
											doc[i] = Formularfelder[i];
										}
									} else {
										//leere Felder entfernen, damit werden auch soeben gelöschte Felder entfernt
										delete doc[i];
									}
								}
							}
							$db.saveDoc(doc, {
								success: function (data) {
									Feld = data;
									sessionStorage.Feld = JSON.stringify(data);
									sessionStorage.FeldId = data._id;
									//Wenn FeldName oder FeldBeschreibung geändert wird: Feldliste soll neu aufbauen
									if (sessionStorage.FeldName === "FeldName" || sessionStorage.FeldName === "FeldBeschreibung" || sessionStorage.FeldName === "Reihenfolge") {
										delete window.Feldliste;
										delete sessionStorage.Feldliste;
									}
									delete sessionStorage.FeldName;
								},
								error: function () {
									melde("Fehler: Feld nicht gespeichert");
								}
							});
						},
						error: function () {
							melde("Fehler: Feld nicht gespeichert");
						}
					});
				}
			});
		</script>
	</div>
  </body>
</html>