<!DOCTYPE html>
<html>
<head>
	<link rel="SHORTCUT ICON" href="Bilder/favicon.ico">
  	<meta http-equiv=Content-Type content="text/html; charset=UTF-8"/>
  	<meta name="viewport" content="width=device-width, initial-scale=1"/>
  	<title>EvAB</title>
  	<link rel="stylesheet" href="style/jquery.mobile.css" type="text/css"/>
  	<link rel="stylesheet" href="style/jquery.mobile.datebox.css" type="text/css"/>
  	<link rel="stylesheet" href="style/jquery.mobile.simpledialog.css" type="text/css"/>
  	<link rel="stylesheet" href="style/evab.css" type="text/css"/>
  	<style type="text/css">.ui-icon-evab-location {background-image:url('Bilder/evab-location.png');}</style>
	<script type="text/javascript" src="vendor/couchapp/jquery.js"></script>
	<script type="text/javascript">			
		$(document).on("mobileinit", function () {
			$.mobile.page.prototype.options.degradeInputs.date = 'text';
			$.mobile.page.prototype.options.degradeInputs.time = 'text';
			$.mobile.selectmenu.prototype.options.nativeMenu = false;
			$.event.special.swipe.horizontalDistanceThreshold = 250;
			$.mobile.buttonMarkup.hoverDelay = 0;
		});
	</script>
	<script type="text/javascript" src="vendor/couchapp/jquery.couch.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.couch.app.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.form.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.mobile.js"></script>
	<script type="text/javascript" src="vendor/couchapp/phonegap.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.mobile.datebox.js"></script>
	<script type="text/javascript" src="vendor/couchapp/jquery.mobile.simpledialog.js"></script>
	<script type="text/javascript" src="vendor/couchapp/evab.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" src="vendor/couchapp/markerclusterer.js"></script>
  	<script type="text/javascript" src="vendor/couchapp/markerwithlabel.js"></script>
</head>
<body>
	<div data-role="page" id="FeldEditPage">
		<div data-role="header" data-position="fixed" data-tap-toggle="false" id="FeldEditHeader">
			<a href="#" id="zurueckFeldEdit" data-role="button" data-icon="arrow-l" data-iconpos="notext">abbrechen</a>
			<h2 class="FeldEditHeaderTitel">Datenfelder</h2>
			<a href='#' id='MenuFeldEdit' data-role='button' data-icon="wrench" data-iconpos="notext" class="r ui-btn-right">Menu</a>
		</div>
		<div id="FeldEditContent" data-role="content" style="padding:0em;">
			<form id="UserFeldForm" action="#" method="get" autocomplete="off">
				<h2>meine Einstellungen</h2>
				<div data-role="fieldcontain">
					<label for="SichtbarImModusEinfach">Sichtbar im einfachen Modus?</label>
					<select class="Feldeigenschaften" id="SichtbarImModusEinfach" name="SichtbarImModusEinfach" data-role="slider">
						<option value="nein">nein</option>
						<option value="ja">ja</option>
					</select> 
				</div>
				<div data-role="fieldcontain">
					<label for="SichtbarImModusHierarchisch">Sichtbar im hierarchischen Modus?</label>
					<select class="Feldeigenschaften" id="SichtbarImModusHierarchisch" name="SichtbarImModusHierarchisch" data-role="slider">
						<option value="nein">nein</option>
						<option value="ja">ja</option>
					</select> 
				</div>
				<div data-role="fieldcontain">
					<label for="Standardwert">Standardwert:</label>
					<input id="Standardwert" name="Standardwert" type="text" placeholder="wird bei neuen Beobachtungen in diesem Feld eingefügt"/>
				</div>
			</form>
				<hr>
				<h2>Feldeigenschaften</h2>
			<form id="FeldEditForm" action="#" method="get">
				<div data-role="fieldcontain">
					<fieldset data-role="controlgroup">
						<legend>Hierarchiestufe (erforderlich):</legend>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Projekt" value="Projekt"/>
							<label for="Projekt">Projekt</label>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Raum" value="Raum"/>
							<label for="Raum">Raum</label>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Ort" value="Ort"/>
							<label for="Ort">Ort</label>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Zeit" value="Zeit"/>
							<label for="Zeit">Zeit</label>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Art" value="Art"/>
							<label for="Art">Art</label>
					</fieldset>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldName">Name:</label>
					<input class="Feldeigenschaften required" id="FeldName" name="FeldName" type="text" placeholder="erforderlich"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschriftung">Beschriftung:</label>
					<input class="Feldeigenschaften required" id="FeldBeschriftung" name="FeldBeschriftung" type="text" placeholder="erforderlich"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschreibung">Beschreibung:</label>
					<textarea class="Feldeigenschaften" id="FeldBeschreibung" name="FeldBeschreibung"></textarea>
				</div>
				<div data-role="fieldcontain">
					<label for="Reihenfolge">Reihenfolge:</label>
					<input class="Feldeigenschaften required" id="Reihenfolge" name="Reihenfolge" type="number" placeholder="erforderlich"/>
				</div>
				<div id="FeldFolgtNachDiv"></div>
				<div data-role="fieldcontain">
					<label for="FeldNameEvab">Name in EvAB:</label>
					<input class="Feldeigenschaften" id="FeldNameEvab" name="FeldNameEvab" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameZdsf">Name beim ZDSF:</label>
					<input class="Feldeigenschaften" id="FeldNameZdsf" name="FeldNameZdsf" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameCscf">Name beim CSCF:</label>
					<input class="Feldeigenschaften" id="FeldNameCscf" name="FeldNameCscf" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameNism">Name beim NISM:</label>
					<input class="Feldeigenschaften" id="FeldNameNism" name="FeldNameNism" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameWslFlechten">Name bei WSL Flechten:</label>
					<input class="Feldeigenschaften" id="FeldNameWslFlechten" name="FeldNameWslFlechten" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameWslPilze">Name bei WSL Pilze:</label>
					<input class="Feldeigenschaften" id="FeldNameWslPilze" name="FeldNameWslPilze" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<fieldset data-role="controlgroup">
						<legend>Feldtyp:</legend>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="textinput" value="textinput"/>
							<label for="textinput">einfaches Feld (textinput)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="textarea" value="textarea"/>
							<label for="textarea">einfaches Feld, wächst mit Inhalt (textarea)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="toggleswitch" value="toggleswitch"/>
							<label for="toggleswitch">ja/nein (toggleswitch)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="slider" value="slider"/>
							<label for="slider">Schieber: Zahlen von min. Wert bis max. Wert (slider)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="selectmenu" value="selectmenu"/>
							<label for="selectmenu">Auswahlliste geschlossen, ein Wert möglich (selectmenu)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="multipleselect" value="multipleselect"/>
							<label for="multipleselect">Auswahlliste geschlossen, mehrere Werte möglich (multipleselect)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="radio" value="radio"/>
							<label for="radio">Auswahlliste offen, ein Wert möglich (radio)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="checkbox" value="checkbox"/>
							<label for="checkbox">Auswahlliste offen, mehrere Werte möglich (checkbox)</label>
					</fieldset>
				</div>
				<div data-role="fieldcontain">
					<fieldset data-role="controlgroup">
						<legend>Datentyp eines einfachen Feldes:</legend>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="text" value="text"/>
							<label for="text">Text</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="number" value="number"/>
							<label for="number">Zahl</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="date" value="date"/>
							<label for="date">Datum</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="time" value="time"/>
							<label for="time">Zeit</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="datetime" value="datetime"/>
							<label for="datetime">Datum und Zeit</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="email" value="email"/>
							<label for="email">email</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="url" value="url"/>
							<label for="url">url</label>
					</fieldset>
				</div>
				<div data-role="fieldcontain" id="Artgruppenliste">
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschreibung">Optionen in Auswahllisten:</label>
					<textarea class="Feldeigenschaften" id="Optionen" name="Optionen" placeholder="Werte,mit,Komma,und,ohne,Leerzeichen,trennen. Erforderlich für Auswahllisten"></textarea>
				</div>
				<div data-role="fieldcontain">
					<label for="SliderMinimum">Kleinster Wert für Schieber:</label>
					<input class="Feldeigenschaften" id="SliderMinimum" name="SliderMinimum" type="text"/>
				</div>
				<div data-role="fieldcontain">
					<label for="SliderMaximum">Höchster Wert für Schieber:</label>
					<input class="Feldeigenschaften" id="SliderMaximum" name="SliderMaximum" type="text" />
				</div>
			</form>
			<ul data-role="pagination">
				<li class="ui-pagination-prev"><a href="#">Prev</a></li>
				<li class="ui-pagination-next"><a href="#">Next</a></li>
			</ul>
		</div>
		<div data-role="footer" data-position="fixed" data-tap-toggle="false" id="FeldEditFooter">
			<div data-role="navbar">
				<ul>
					<li><a href="#" id="NeuesFeldFeldEdit" data-icon="plus" class="ui-btn-active">neu</a></li>			
					<li><a href="#" data-role="button" id="LoescheFeldFeldEdit" data-icon="minus" forceinput="false">l&ouml;schen</a></li>
				</ul>
			</div><!-- /navbar -->
		</div><!-- /footer -->
		<script type="text/javascript">
			//Sollte keine id vorliegen, zu FeldListe.html wechseln
			//das kommt im Normalfall nur vor, wenn der Cache des Browsers geleert wurde
			//oder in der Zwischenzeit auf einem anderen Browser dieser Datensatz gelöscht wurde
			$("#FeldEditPage").on("pageshow", function () {
				if (localStorage.length === 0 || !localStorage.Username) {
					leereAlleVariabeln();
					$.mobile.changePage("index.html");
				} else if (!localStorage.FeldId) {
					leereAlleVariabeln();
					geheZurueckFE();
				}
				initiiereFeldEdit();
			});

			//Code, der bei Verwendung von ajax nur beim ersten Aufruf der Seite laufen soll
			$(":jqmData(role='page')").on("pageinit", function () {
				//Wird diese Seite direkt aufgerufen und es gibt keinen localStorage,
				//muss auf index.html umgeleitet werden
				if (localStorage.length === 0 || !localStorage.Username) {
					leereAlleVariabeln();
					$.mobile.changePage("index.html");
				} else if (!localStorage.FeldId) {
					leereAlleVariabeln();
					$.mobile.changePage("BeobListe.html");
				}

				//jedes Feld aus Feldeigenschaften bei Änderung speichern
				$("#FeldEditContent").on("change", ".Feldeigenschaften", function () {
					var AlterFeldWert;
					localStorage.FeldWert = this.value;
					if (this.name) {
						localStorage.FeldName = this.name;
						localStorage.AlterFeldWert = Feld[this.name];
					} else {
						localStorage.FeldName = this.id;
						localStorage.AlterFeldWert = Feld[this.id];
					}
					//Felder der Datenzentren dürfen nicht verändert werden
					//ausser Standardwert, dessen Änderung wird aber in einer anderen Funktion verarbeitet
					if (Feld.User === "ZentrenBdKt") {
						//Feldwert zurücksetzen	
						if (localStorage.AlterFeldWert) {
							$("#" + localStorage.FeldName).val(localStorage.AlterFeldWert);
						} else {
							$("#" + localStorage.FeldName).val("");
						}
						delete localStorage.FeldName;
						delete localStorage.FeldWert;
						delete localStorage.AlterFeldWert;
						melde("Dies ist ein geschütztes Feld eines öffentlichen Datenzentrums<br><br>Sie können ein neues Feld erstellen");
					} else if (localStorage.FeldName === "FeldName") {
						//Wenn eigener Feldname verändert wird, kontrollieren, dass er nicht schon verwendet wurde
						//ohne explizit auf undefined zu prüfen, akzeptierte die Bedingung einen alten Feldwert von 
						//undefined als o.k.!!!!
						if (localStorage.AlterFeldWert !== "undefined" && localStorage.AlterFeldWert) {
							//wenn ein alter Feldname existiert,
							//zählen, in wievielen Datensätzen das Feld verwendet wird
							$db = $.couch.db("evab");
							$db.view('evab/FeldSuche?key="' + localStorage.Username + '"&include_docs=true', {
								success: function (data) {
									var i, anzVorkommen, Datensatz, TempFeld, ds;
									anzVorkommen = 0;
									//zählen, in wievielen Datensätzen das bisherige Feld verwendet wird
									for (i in data.rows) {
										if (typeof i !== "function") {
											Datensatz = data.rows[i].doc; 
											TempFeld = Datensatz[localStorage.AlterFeldWert];
											if (TempFeld) {
												anzVorkommen += 1;
											}
										}
									}
									if (anzVorkommen === 0) {
										//alter Feldname wurde noch in keinem Datensatz verwendet
										//prüfen, ob der neue Feldname schon existiert
										//wenn ja: melden, zurückstellen
										//wenn nein: speichern
										pruefeFeldNamen();
									} else {
										//Feldname wird schon verwendet > melden, zurückstellen
										ds = "Datensätzen";
										if (anzVorkommen === 1) {
											ds = "Datensatz";
										}
										$("#FeldName").val(localStorage.AlterFeldWert);
										delete localStorage.FeldName;
										delete localStorage.FeldWert;
										delete localStorage.AlterFeldWert;
										melde("Dieses Feld wird in " + anzVorkommen + " " + ds + " verwendet.<br>Es kann deshalb nicht verändert werden.<br>Bereinigen Sie zuerst die Daten.");
									}
								}
							});
						} else {
							//Vorher gab es keinen Feldnamen
							//prüfen, ob der neue Feldname schon existiert
							//wenn ja: melden, zurückstellen
							//wenn nein: speichern
							pruefeFeldNamen();
						}
					} else if (localStorage.FeldName === "Hierarchiestufe" && localStorage.FeldWert === "Art") {
						$(".FeldEditHeaderTitel").text(localStorage.FeldWert + ": " + Feld.FeldBeschriftung);
						leereStorageFeldListe();
						speichereFeldeigenschaften();
						//Wenn die Hierarchiestufe zu Art geändert wird, muss das Feld für die Artgruppe aufgebaut werden
						ArtGruppeAufbauenFeldEdit();
					} else if (localStorage.FeldName === "Hierarchiestufe" && localStorage.FeldWert !== "Art") {
						$(".FeldEditHeaderTitel").text(localStorage.FeldWert + ": " + Feld.FeldBeschriftung);
						if (window.Feld.Hierarchiestufe === "Art") {
							//Wenn die Hierarchiestufe Art war und geändert wird, muss das Feld für die Artgruppe entfernt werden
							$("#Artgruppenliste").empty();
						}
						leereStorageFeldListe();
						speichereFeldeigenschaften();
					} else {
						if (localStorage.FeldName === "FeldBeschriftung") {
							$(".FeldEditHeaderTitel").text(Feld.Hierarchiestufe + ": " + localStorage.FeldWert);
						}
						speichereFeldeigenschaften();
					}
				});

				$("#FeldEditForm").on("change", "#FeldFolgtNach", function () {
					setzeReihenfolgeMitVorgaenger(this.value);
					//Feldliste soll neu aufgebaut werden
					delete window.Feldliste;
				});

				$("#FeldEditFooter").on("click", "#NeuesFeldFeldEdit", function (event) {
					event.preventDefault();
					neuesFeld();
				});

				$("#UserFeldForm").on("change", "#Standardwert", function () {
					var Optionen, Feldwert, LetzterFeldwert, Formularelement, StandardwertOptionen;
					Optionen = $("#Optionen").val() || [];	//undefined verhindern
					Feldwert = this.value || [];	//undefined verhindern
					if (Optionen.length > 0) {
						//es gibt Optionen. Der Standardwert muss eine oder allenfalls mehrere Optionen sein
						LetzterFeldwert = [];
						if (Feld.Standardwert) {
							if (Feld.Standardwert[localStorage.Username]) {
								LetzterFeldwert = Feld.Standardwert[localStorage.Username];
							}
						}
						//Standardwert in Array verwandeln
						StandardwertOptionen = [];
						if (Feldwert.length > 0) {
							//Fehler verhindern, falls Feldwert undefined ist
							StandardwertOptionen = Feldwert.split(",");
						}
						if (["multipleselect", "checkbox"].indexOf(Feld.Formularelement) > -1) {
							//alle StandardwertOptionen müssen Optionen sein
							for (i in StandardwertOptionen) {
								if (typeof i !== "function") {
									if (Optionen.indexOf(StandardwertOptionen[i]) === -1) {
										//ein Wert ist keine Option, abbrechen
										$("#Standardwert").val(LetzterFeldwert);
										melde("Bitte wählen Sie eine oder mehrere der Optionen");
										return;
									}
								}
							}
							//alle Werte sind Optionen
							speichereStandardwert();
						} else if (["toggleswitch", "selectmenu", "radio"].indexOf(Feld.Formularelement) > -1) {
							//Array darf nur ein Element enthalten
							if (StandardwertOptionen.length > 1) {
								//Array enthält mehrere Optionen, nicht zulässig
								$("#Standardwert").val(LetzterFeldwert);
								melde("Bitte wählen Sie nur EINE der Optionen");
							} else {
								//Array enthält eine einzige Option
								for (i in StandardwertOptionen) {
									if (typeof i !== "function") {
										if (Optionen.indexOf(StandardwertOptionen[i]) === -1) {
											//der Wert ist keine Option, abbrechen
											$("#Standardwert").val(LetzterFeldwert);
											melde("Bitte wählen Sie eine der Optionen");
											return;
										}
									}
								}
								//alle Werte sind Optionen
								speichereStandardwert();
								return;
							}
						} else {
							//Optionen sind erfasst, Feld braucht aber keine. Alle Werte akzeptieren
							speichereStandardwert();
						}
					} else {
						//Es gibt keine Optionen. Alle Standardwerte akzeptieren
						speichereStandardwert();
					}
				});

				//Code für den Feld-Löschen-Dialog
				$('#FeldEditFooter').on('click', '#LoescheFeldFeldEdit', function (event) {
					event.preventDefault();
					if (Feld.User === "ZentrenBdKt") {
						melde("Dies ist ein Feld eines nationalen Datenzentrums<br><br>Es kann nicht gelöscht werden<br><br>Sie können es ausblenden");
					} else {
						$(this).simpledialog({
							'mode' : 'bool',
							'prompt' : 'Dieses Feld löschen?',
							'forceInput': 'false',
							'buttons' : {
								'ja': {
									click: function () {
										$('#dialogoutput').text('ja');
										if (!Feld.FeldName) {
											//Ohne Feldname kann nicht kontrolliert werden, in wievielen Datensätzen das Feld vorkommt
											loescheFeld();
										} else {
											$db = $.couch.db("evab");
											//zählen, in wievielen Datensätzen das Feld verwendet wird
											$db.view('evab/FeldSuche?key="' + localStorage.Username + '"&include_docs=true', {
												success: function (data) {
													var i, anzVorkommen, Datensatz, TempFeld, ds;
													anzVorkommen = 0;
													for (i in data.rows) {
														if (typeof i !== "function") {
															Datensatz = data.rows[i].doc;
															TempFeld = Datensatz[Feld.FeldName];
															if (TempFeld) {
																anzVorkommen += 1;
															}
														}
													}
													if (anzVorkommen === 0) {
														loescheFeld();
													} else {
														ds = "Datensätzen";
														if (anzVorkommen === 1) {
															ds = "Datensatz";
														}
														melde("Löschen abgebrochen:<br>Dieses Feld wird in " + anzVorkommen + " " + ds + " verwendet<br>Bereinigen Sie zuerst die Daten");
													}
												}
											});
										}
									},
									icon: "delete",
									theme: "c"
								},
								'nein': {
									click: function () {
										$('#dialogoutput').text('nein');
									}
								}
							}
						})
					}
				});

				//Menu aufbauen
				$("#FeldEditHeader").on('click', "#MenuFeldEdit", function (event) {
					event.preventDefault();
					erstelleMenuFürFelder(this);
				});

				//BackButton steuern
				$("#FeldEditHeader").on('click', '#zurueckFeldEdit', function (event) {
					event.preventDefault();
					geheZurueckFE();
				});

				//swipen steuern
				$("#FeldEditPage").on("swipeleft", "#FeldEditContent", function () {
					geheZumNächstenFeld();
				});

				$("#FeldEditPage").on("swiperight", "#FeldEditContent", function () {
					geheZumVorigenFeld();
				});

				//Pagination Pfeil voriger initialisieren
				$("#FeldEditPage").on("vclick", ".ui-pagination-prev", function (event) {
					event.preventDefault();
					geheZumVorigenFeld();
				});

				//Pagination Pfeil nächster initialisieren
				$("#FeldEditPage").on("vclick", ".ui-pagination-next", function (event) {
					event.preventDefault();
					geheZumNächstenFeld();
				});

				//Pagination Pfeiltasten initialisieren
				$("#FeldEditPage").on("keyup", function (e) {
					//nur reagieren, wenn ProjektEditPage sichtbar und Fokus nicht in einem Feld
					if (!$(e.target).is("input, textarea, select, button") && $('#FeldEditPage').is(':visible')) {
						// Left arrow
						if (e.keyCode === $.mobile.keyCode.LEFT) {
							geheZumVorigenFeld();
							e.preventDefault();
						}
						// Right arrow
						else if (e.keyCode === $.mobile.keyCode.RIGHT) {
							geheZumNächstenFeld();
							e.preventDefault();
						}
					}
				});

				//prüft neue oder umbenannte Feldnamen
				//prüft, ob der neue Feldname schon existiert
				//wenn ja: melden, zurückstellen
				//wenn nein: speichern
				function pruefeFeldNamen() {
					$db = $.couch.db("evab");
					$db.view('evab/FeldNamen?key="' + localStorage.FeldWert + '"', {
						success: function (data) {
							var i, key, TempFeld, AnzEigeneOderOffizielleFelderMitSelbemNamen;
							AnzEigeneOderOffizielleFelderMitSelbemNamen = 0;
							//durch alle Felder mit demselben Artnamen laufen
							//prüfen, ob sie eigene oder offielle sind
							if (data.rows) {
								for (i in data.rows) {
									if (typeof i !== "function") {
										if (data.rows[i].value) {
											TempFeld = data.rows[i].value;
											//ist es ein eigenes oder ein offizielles?
											if (TempFeld.User === localStorage.Username || TempFeld.User === "ZentrenBdKt") {
												//ja > dieser Name ist nicht zulässig
												AnzEigeneOderOffizielleFelderMitSelbemNamen += 1;
											}
										}
									}
								}
							}
							if (AnzEigeneOderOffizielleFelderMitSelbemNamen === 0) {
								//Feldname ist neu, somit zulässig > speichern
								//und alten FeldNamen aus der Liste der anzuzeigenden Felder entfernen
								$("#SichtbarImModusHierarchisch").val("ja");
								$("select#SichtbarImModusHierarchisch").slider("refresh");
								speichereFeldeigenschaften();
							} else {
								//Feldname kommt bei diesem User schon vor
								//Wert im Feld zurücksetzen
								if (localStorage.AlterFeldWert) {
									$("#FeldName").val(localStorage.AlterFeldWert);
								} else {
									$("#FeldName").val("");
								}
								setTimeout(function () { 
									$('#FeldName').focus(); 
								}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
								melde("Feldname " + localStorage.FeldWert + "existiert schon<br>Wählen Sie einen anderen");
								delete localStorage.FeldName;
								delete localStorage.FeldWert;
								delete localStorage.AlterFeldWert;
							}
						},
						error: function () {
							//Wert im Feld zurücksetzen
							if (localStorage.AlterFeldWert) {
								$("#FeldName").val(localStorage.AlterFeldWert);
							} else {
								$("#FeldName").val("");
							}
							melde("Fehler: Änderung in " + localStorage.FeldName + " nicht gespeichert");
							delete localStorage.FeldName;
							delete localStorage.FeldWert;
							delete localStorage.AlterFeldWert;
						}
					});
				}

				function loescheFeld() {
					if (window.Feld) {
						//Objekt nutzen
						loescheFeld_2();
					} else {
						//Feld aus DB holen
						$db = $.couch.db("evab");
						$db.openDoc(Feld._id, {
							success: function (data) {
								window.Feld = data;
								loescheFeld_2();
							},
							error: function () {
								melde("Fehler: nicht gelöscht");
							}
						});
					}
				}

				function loescheFeld_2() {
					$db = $.couch.db("evab");
					$db.removeDoc(window.Feld, {
						success: function (data) {
							//Liste anpassen. Vorsicht: Bei refresh kann sie fehlen
							if (window.Feldliste) {
								for (i in window.Feldliste.rows) {
									if (window.Feldliste.rows[i].value._id === data.id) {
										window.Feldliste.rows.splice(i, 1);
										break;
									}
								}
							} else {
								//Keine Feldliste mehr. Storage löschen
								leereStorageFeldListe();
							}
							leereStorageFeldEdit();
							$.mobile.changePage("FeldListe.html");
						},
						error: function () {
							melde("Fehler: nicht gelöscht");
						}
					});
				}


				//Öffnet das nächste Feld
				//nächstes des letzten => melden
				//erwartet die ID des aktuellen Datensatzes
				function geheZumNächstenFeld() {
					if (window.Feldliste) {
						//Feldliste aus globaler Variable verwenden - muss nicht geparst werden
						geheZumNächstenFeld_2();
					} else {
						$db = $.couch.db("evab");
						$db.view('evab/FeldListe', {
							success: function (data) {
								window.Feldliste = data;
								geheZumNächstenFeld_2();
							}
						});
					}
				}

				function geheZumNächstenFeld_2() {
					var i, y, FeldIdAktuell, FeldIdNächstes, AnzFelder, AktFeld_i, AktFeld_y;
					AnzFelder = Feldliste.rows.length -1;
					for (i in Feldliste.rows) {
						if (typeof i !== "function") {
							//alle Felder durchlaufen, aktuelles eigenes oder offizielles suchen
							AktFeld_i = Feldliste.rows[i].value;
							//vorsicht: Objekte zählen Elemente ab 1, Arrays ab 0!
							if (AktFeld_i.User === localStorage.Username || AktFeld_i.User === "ZentrenBdKt") {
								//Nur eigene und offizielle Felder berücksichtigen
								FeldIdAktuell = Feldliste.rows[i].value._id;
								if (FeldIdAktuell === localStorage.FeldId) {
									//das ist das aktuelle Feld
									//von hier aus vorwärts das nächste eigene oder offizielle suchen
									if (parseInt(i) < AnzFelder) {
										//das aktuelle Feld ist nicht das letzte
										for (y = parseInt(i)+1; y <= AnzFelder; y++) {
											//alle verbleibenden Felder durchlaufen, eigenes suchen
											AktFeld_y = Feldliste.rows[y].value;
											//Nur eigene Felder und offizielle berücksichtigen
											if (AktFeld_y.User === localStorage.Username || AktFeld_y.User === "ZentrenBdKt") {
												//das ist das nächste eigene Feld > öffnen
												localStorage.FeldId = Feldliste.rows[parseInt(i)+1].value._id;
												leereStorageFeldEdit("ohneId");
												initiiereFeldEdit();
												return;
											} else {
												if (y === AnzFelder) {
													//am letzten Feld angelangt und es ist kein eigenes
													melde("Das ist das letzte Feld");
													return;
												}
											}
										}
									} else {
										//das aktuelle Feld ist das letzte
										melde("Das ist das letzte Feld");
										return;
									}
								}
							}
						}
					}
				}

				//Öffnet das vorige Feld
				//voriges des ersten => FeldListe
				//erwartet die ID des aktuellen Datensatzes
				function geheZumVorigenFeld() {
					if (window.Feldliste) {
						//Feldliste aus globaler Variable verwenden - muss nicht geparst werden
						geheZumVorigenFeld_2();
					} else {
						$db = $.couch.db("evab");
						$db.view('evab/FeldListe', {
							success: function (data) {
								window.Feldliste = data;
								geheZumVorigenFeld_2();
							}
						});
					}
				}

				function geheZumVorigenFeld_2() {
					var i, y, FeldIdAktuell, FeldIdVoriges, AnzFelder, AktFeld_i, AktFeld_y;
					AnzFelder = Feldliste.rows.length -1;
					for (i in Feldliste.rows) {
						if (typeof i !== "function") {
							//alle Felder durchlaufen, aktuelles eigenes oder offizielles suchen
							AktFeld_i = Feldliste.rows[i].value;
							//vorsicht: Objekte zählen Elemente ab 1, Arrays ab 0!
							if (AktFeld_i.User === localStorage.Username || AktFeld_i.User === "ZentrenBdKt") {
								//Nur eigene und offizielle Felder berücksichtigen
								FeldIdAktuell = Feldliste.rows[i].value._id;
								if (FeldIdAktuell === localStorage.FeldId) {
									//das ist das aktuelle Feld
									//von hier aus rückwärts das nächste eigene oder offizielle suchen
									if (parseInt(i) > 0) {
										//das aktuelle Feld ist nicht das erste 
										for (y = parseInt(i)-1; y >= 0; y--) {
											//alle vorhergehenden Felder durchlaufen, eigenes suchen
											AktFeld_y = Feldliste.rows[y].value;
											//Nur eigene Felder und offizielle berücksichtigen
											if (AktFeld_y.User === localStorage.Username || AktFeld_y.User === "ZentrenBdKt") {
												//das ist das nächstvorherige eigene Feld > öffnen
												FeldIdVoriges = Feldliste.rows[parseInt(i)-1].value._id;
												localStorage.FeldId = FeldIdVoriges;
												leereStorageFeldEdit("ohneId");
												initiiereFeldEdit();
												return;
											} else {
												if (y === 1) {
													//am ersten Feld angelangt und es ist kein eigenes
													//wir gehen zur Feldliste
													geheZurueckFE();
													return;
												}
											}
										}
									} else {
										//das aktuelle Feld ist das erste
										//wir gehen zur Feldliste
										geheZurueckFE();
										return;
									}
								}
							}
						}
					}
				}

				//empfängt den Feldnamen des gewählten Vorgängers
				//ermittelt dessen Reihenfolge
				//sucht das nächste eigene Feld und setzt als Reihenfolge den Mittelwert der zwei Reihenfolgen
				//Wenn kein weiteres eigenes Feld kommt, wird als Reihenfolge der nächste um mindestens 1 höhere ganzzahlige Wert gesetzt
				function setzeReihenfolgeMitVorgaenger(FeldNameVorgaenger) {
					var viewname;
					$db = $.couch.db("evab");
					viewname = 'evab/FeldListeFeldName?key="' + FeldNameVorgaenger + '"';
					$db.view(viewname, {
						success: function (data) {
							var ReihenfolgeVorgaenger;
							ReihenfolgeVorgaenger = data.rows[0].value.Reihenfolge;
							$("#Reihenfolge").val(Math.floor(ReihenfolgeVorgaenger + 1));
							speichereFeldeigenschaften();
						}
					});
				}

				function speichereStandardwert() {
					//Prüfen, ob Feld als Objekt vorliegt
					if (window.Feld) {
						//dieses verwenden
						speichereStandardwert_2();
					} else {
						//aus DB holen
						$db = $.couch.db("evab");
						$db.openDoc(localStorage.FeldId, {
							success: function (doc) {
								window.Feld = doc;
								speichereStandardwert_2();
							},
							error: function () {
								melde("Fehler: Feld nicht gespeichert");
							}
						});
					}

				}

				function speichereStandardwert_2() {
					var Feldwert;
					Feldwert = $("#Standardwert").val();
					//Standardwert managen
					//Standardwert ist Objekt, in dem die Werte für jeden User gespeichert werden
					//darum manuell für diesen User updaten
					if (window.Feld.Standardwert) {
						//Standardwert existierte
						if (Feldwert) {
							//neuen Standardwert setzen
							window.Feld.Standardwert[localStorage.Username] = Feldwert;
						} else {
							//Standardwert ist leer
							if (window.Feld.Standardwert[localStorage.Username]) {
								//bisherigen Standardwert löschen
								delete window.Feld.Standardwert[localStorage.Username];
							}
						}
					} else {
						//Bisher gab es noch keinen Standardwert
						if (Feldwert) {
							//Objekt für Standardwert schaffen und neuen Wert setzen
							window.Feld.Standardwert = {};
							window.Feld.Standardwert[localStorage.Username] = Feldwert;
						}
					}
					$db.saveDoc(window.Feld, {
						success: function (data) {
							window.Feld._rev = data.rev;
							localStorage.FeldId = data.id;
							//Feldlisten leeren, damit Standardwert sofort verwendet werden kann!
							leereStorageFeldListe();
						},
						error: function () {
							melde("Fehler: Feld nicht gespeichert");
						}
					});
				}

				//speichert
				function speichereFeldeigenschaften() {
					//prüfen, ob das Feld als Objekt vorliegt
					if (window.Feld) {
						//bestehendes Objekt verwenden
						speichereFeldeigenschaften_2();
					} else {
						//Objekt aus der DB holen
						$db = $.couch.db("evab");
						$db.openDoc(localStorage.FeldId, {
							success: function (data) {
								window.Feld = data;
								speichereFeldeigenschaften_2();
							},
							error: function () {
								melde("Fehler: Änderung in " + localStorage.FeldName + " nicht gespeichert");
							}
						});
					}
				}

				function speichereFeldeigenschaften_2() {
					var Formularfelder, idx1, idx2;
					Formularfelder = $("#FeldEditForm").serializeObjectNull();
					//Felder mit Arrays: Kommagetrennte Werte in Arrays verwandeln. Plötzlich nicht mehr nötig??!!
					if (Formularfelder.Optionen) {
						Formularfelder.Optionen = Formularfelder.Optionen.split(",");
					}
					/*if (window.Feld.ArtGruppe) {
						window.Feld.ArtGruppe = window.Feld.ArtGruppe.split(", ");
					}*/
					//Wenn Beschriftung fehlt und Name existiert: Beschriftung = Name
					if (!Formularfelder.FeldBeschriftung && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
						Formularfelder.FeldBeschriftung = Formularfelder.FeldName;
						//Feldliste soll neu aufgebaut werden
						leereStorageFeldListe();
					}
					//Es braucht eine Reihenfolge
					if (!Formularfelder.Reihenfolge && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
						Formularfelder.Reihenfolge = 1;
						//Feldliste soll neu aufgebaut werden
						leereStorageFeldListe();
					}
					//Es braucht einen Feldtyp
					if (!Formularfelder.Formularelement && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
						Formularfelder.Formularelement = "textinput";
						Formularfelder.InputTyp = "text";
					}
					//Wenn Feldtyp von textinput weg geändert wurde, sollte InputTyp entfernt werden
					if (Formularfelder.Formularelement !== "textinput" && Formularfelder.InputTyp) {
						delete Formularfelder.InputTyp;
						$("#" + Feld.InputTyp).prop("checked",false).checkboxradio("refresh");
					}
					//Wenn Feldtyp gesetzt wurde, muss ein InputTyp existieren. Wenn er nicht gesetzt wurde, text setzen
					if (Formularfelder.Formularelement === "textinput" && !Formularfelder.InputTyp) {
						Formularfelder.InputTyp = "text";
					}
					//Sichtbarkeitseinstellungen: In einem Array werden die User aufgelistet, welche das Feld sehen
					//Es muss geprüft werden, ob der aktuelle User in diesem Array enthalten ist
					//Soll das Feld im Modus einfach sichtbar sein?
					idx1 = window.Feld.SichtbarImModusEinfach.indexOf(localStorage.Username);
					if ($("#SichtbarImModusEinfach").val() === "ja") {
						//User ergänzen, wenn noch nicht enthalten
						if (idx1 === -1) {
							window.Feld.SichtbarImModusEinfach.push(localStorage.Username);
						}
					} else {
						//User entfernen, wenn enthalten
						if (idx1 !== -1) {
							window.Feld.SichtbarImModusEinfach.splice(idx1, 1);
						}
					}
					//Soll das Feld im Modus hierarchisch sichtbar sein?
					idx2 = window.Feld.SichtbarImModusHierarchisch.indexOf(localStorage.Username);
					if ($("#SichtbarImModusHierarchisch").val() === "ja") {
						//User ergänzen, wenn noch nicht enthalten
						if (idx2 === -1) {
							window.Feld.SichtbarImModusHierarchisch.push(localStorage.Username);
						}
					} else {
						//User entfernen, wenn enthalten
						if (idx2 !== -1) {
							window.Feld.SichtbarImModusHierarchisch.splice(idx2, 1);
						}
					}
					//Formularfelder in Dokument schreiben
					//setzt Vorhandensein von Feldnamen voraus!
					for (i in Formularfelder) {
						if (typeof i !== "function") {
							if (Formularfelder[i]) {
								if (i === "Reihenfolge" || i === "SliderMinimum" || i === "SliderMaximum") {
									//Zahl wird sonst in Text verwandelt und falsch sortiert
									window.Feld[i] = parseInt(Formularfelder[i]);
								} else {
									window.Feld[i] = Formularfelder[i];
								}
							} else {
								//leere Felder entfernen, damit werden auch soeben gelöschte Felder entfernt
								delete window.Feld[i];
							}
						}
					}
					$db.saveDoc(window.Feld, {
						success: function (data) {
							//rev aktualisieren
							window.Feld._rev = data.rev;
							localStorage.FeldId = data.id;
							//Wenn FeldName oder FeldBeschreibung geändert wird: Feldliste soll neu aufbauen
							if (localStorage.FeldName === "FeldName" || localStorage.FeldName === "FeldBeschreibung" || localStorage.FeldName === "Reihenfolge") {
								leereStorageFeldListe();
							}
						},
						error: function () {
							melde("Fehler: Änderung in " + localStorage.FeldName + " nicht gespeichert");
						}
					});
					delete localStorage.FeldName;
					delete localStorage.FeldWert;
					delete localStorage.AlterFeldWert;
				}
			});
		</script>
	</div>
  </body>
</html>