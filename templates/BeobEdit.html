<!DOCTYPE html>
<html>
  <head>
  	<link rel="SHORTCUT ICON" href="../../Bilder/favicon.ico">
  	<meta http-equiv=Content-Type content="text/html; charset=UTF-8"/>
  	<meta name="viewport" content="width=device-width, initial-scale=1"/>
  	<title>EvAB</title>
  	<link rel="stylesheet" href="../../style/evab.css" type="text/css"/>
  	<link rel="stylesheet" href="../../style/main.css" type="text/css">
  	<link rel="stylesheet" href="../../style/jquery.mobile.css" type="text/css"/>
  	<link rel="stylesheet" href="../../style/jquery.mobile.datebox.css" type="text/css"/>
  	<link rel="stylesheet" href="../../style/jquery.mobile.simpledialog.css" type="text/css"/>
  	<style type="text/css">.ui-icon-evab-location {background-image:url('../../Bilder/evab-location.png');}</style>
    <script type="text/javascript" src="../../vendor/couchapp/jquery.js"></script>
    <script type="text/javascript" src="../../vendor/couchapp/jquery.couch.js"></script>
    <script type="text/javascript" src="../../vendor/couchapp/jquery.couch.app.js"></script>
    <script type="text/javascript" src="../../vendor/couchapp/jquery.couch.app.util.js"></script>
    <script type="text/javascript" src="../../vendor/couchapp/jquery.mustache.js"></script>
    <script type="text/javascript">
	//customize jQuery Mobile to let IE7+ in (Mobile IE)
	//run this script after jQuery loads, but before jQuery Mobile loads				
		$(document).bind("mobileinit", function(){
			$.extend(  $.mobile , {	
			//extend gradeA qualifier to include IE7+
				gradeA: function(){    	
			    	//IE version check by James Padolsey, modified by jdalton - from http://gist.github.com/527683
					var ie = (function() {
					    var v = 3, div = document.createElement('div'), a = div.all || [];
					    while (div.innerHTML = '<!--[if gt IE '+(++v)+']><br><![endif]-->', a[0]); 
					    return v > 4 ? v : !v;
					}());
			    	
			    	//must either support media queries or be IE7+
			    	return $.support.mediaquery || (ie && ie >= 7);
			    }
			});
		});
	</script>
    <script type="text/javascript" src="../../vendor/couchapp/jquery.mobile.js"></script>
    <script type="text/javascript" src="../../vendor/couchapp/phonegap.js"></script>
    <script type="text/javascript" src="../../vendor/couchapp/evab.js"></script>
    <script type="text/javascript" src="../../vendor/couchapp/jquery.mobile.simpledialog.js"></script>
  	<script type="text/javascript" src="../../vendor/couchapp/jquery.mobile.datebox.js"></script>
  	<script type="text/javascript">
		$(document).bind("mobileinit", function(){
			$.mobile.page.prototype.options.degradeInputs.date = 'text';
			$.mobile.selectmenu.prototype.options.nativeMenu = true;
		});	
	</script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
  </head>

  <body>
  	<div data-role="page" id="BeobEditPage">
  		<div data-role="header" data-position="fixed">
  			<a href="../../BeobListe.html" data-role="button" data-icon="arrow-l" data-rel="back" data-iconpos="notext">zur Beobachtungs-Liste</a>
  			<h2>Beobachtung</h2>
  			<a href='#' id='Menu' name='Menu' data-role='button' data-icon="gear" data-iconpos="notext" class="r ui-btn-right">Menu</a>
  		</div>
		<div id="BeobEditContent" data-role="content" data-theme="c" style="padding:0em;">
			<form id="BeobEditForm" action="#" method="get" data-identity="{{document}}" autocomplete="off">
				<div data-role="fieldcontain">
					<label for="aArtGruppe" class="select">Art-Gruppe:</label>
					<select id="aArtGruppe" name="aArtGruppe" value="{{aArtGruppe}}" data-icon="arrow-r" data-native-menu="true">
					</select>
				</div>
				<div data-role="fieldcontain">
					<label for="aArtName" class="select">Art-Name:</label>
					<select id="aArtName" name="aArtName" value="{{aArtName}}" data-icon="arrow-r" data-native-menu="true">
					</select>
				</div>
				<div data-role="fieldcontain">
					<label for="aAutor">Autor:</label>
					<input id="aAutor" name="aAutor" type="text" value="{{aAutor}}" required/>
				</div>
				<div data-role="fieldcontain">
					<label for="oXKoord">X-Koordinate:</label>
					<input id="oXKoord" name="oXKoord" type="text" value="{{oXKoord}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="oYKoord">Y-Koordinate:</label>
					<input id="oYKoord" name="oYKoord" type="text" value="{{oYKoord}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="oLagegenauigkeit">Lagegenauigkeit:</label>
					<input id="oLagegenauigkeit" name="oLagegenauigkeit" type="text" value="{{oLagegenauigkeit}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="zDatum">Datum:</label>
					<input id="zDatum" name="zDatum" type="date" data-role="datebox" data-options='{"mode": "calbox"}' value="{{zDatum}}" required/>
				</div>
				<div data-role="fieldcontain">
					<label for="zZeit">Zeit:</label>
					<input id="zZeit" name="zZeit" type="date" data-role="datebox" data-options='{"mode": "timebox"}' value="{{zZeit}}" />
				</div>
			</form>
			<div data-role="footer" data-position="fixed">
				<div data-role="navbar" id="BeobEditNavbar">
					<ul>
						<li><a href="#" id="NeueBeobLink" data-transition="slideup" data-icon="plus">neu</a></li>					
						<li><a href="#" id="LöschenDialogLink" data-role="button" data-icon="minus" forceInput="false">l&ouml;schen</a></li>
						<li><a href="#" id="GetGeolocationButton" data-icon="evab-location">verorten</a></li>						
						<li><a href="#" id="GeButton" data-icon="star">Karte</a></li>
					</ul>
				</div><!-- /navbar -->
			</div><!-- /footer -->
		</div>
	</div>

	<div data-role="page" id="BeobEditMap" style="width:100%; height:100% !important;">
		<div data-role="header" data-position="fixed">
			<a href="#BeobEditPage" data-role="button" data-icon="arrow-l" data-iconpos="notext" >abbrechen</a>
			<h1>Karte</h1>
			<a href='#' id='Menu' name='Menu' data-role='button' data-icon="gear" data-iconpos="notext" class="r ui-btn-right">Menu</a>
		</div>
		<div data-role="content" style="width:100%; height:100%; padding:0"> 
			<div id="map_canvas" style="width:100%; height:100%"></div>
		</div>
	</div>

  </body>


	<script type="text/javascript">
		$(document).ready(function(){
			$db = $.couch.db("evab-ch_barbalex_evab");
			userCtx = null;
			$.couch.session({
			success : function(r) {
				var userCtx = r.userCtx;
				User = userCtx.name;
				}
			});

			refreshArtGruppe("{{aArtGruppe}}");
			refreshArtName("{{aArtName}}");
			
			docId = "{{id}}";
			aArtGruppe = "{{aArtGruppe}}";
			aArtName = "{{aArtName}}";
			aArtId = "{{aArtId}}";
			oLongitudeDecDeg = "{{oLongitudeDecDeg}}";
			oLatitudeDecDeg = "{{oLatitudeDecDeg}}";

			var Status = get_url_param("Status");
			if (Status == "neu"){
				AutorSetzen();
				GetGeolocation();                   
				//DatumZeitSetzen();
			}

			//Neue Beobachtung erfassen
			$("#NeueBeobLink").live("click", function(event){
				event.preventDefault();
				$.mobile.changePage("../../Artgruppenliste.html", "slide", true, false);
				ArtgruppenlisteAufbauen("Neu");
			});

			$("[name='ArtgruppenListItemNeu']").live("click", function(event) {        
				event.preventDefault();
				var ArtGruppe = $(this).attr("id");
				$.mobile.changePage("Artenliste.html", "slide", true, false);
				ArtlisteAufbauen(ArtGruppe, "Neu");
				$("#ArtgruppenListe").empty();
			});
			
			$("[name='ArtListItemNeu']").live("click", function(event) {
				event.preventDefault();
				var ArtGruppe = $(this).attr("aArtGruppe");
				var ArtName = $(this).attr("id");
				var ArtId = $(this).attr("artid");
				$("#ArtenListe").empty();
				BeobNeuSpeichern(User, ArtGruppe, ArtName, ArtId);
			});

			//Editieren von Beobachtungen managen, ausgehend von Artgruppe
			$("select#aArtGruppe").tap(function(event){
				event.preventDefault();
				$.mobile.changePage("../../Artgruppenliste.html", "slide", true, false);
				ArtgruppenlisteAufbauen("Edit");
			});

			$("[name='ArtgruppenListItemEdit']").live("click", function(event) {        
				event.preventDefault();
				aArtGruppe = $(this).attr("id");
				$.mobile.changePage("Artenliste.html", "slide", true, false);
				ArtlisteAufbauen(aArtGruppe, "Edit");
				$("#ArtgruppenListe").empty();
			});
			
			$("[name='ArtListItemEdit']").live("click", function(event) {
				event.preventDefault();
				aArtGruppe = $(this).attr("aArtGruppe");
				aArtName = $(this).attr("id");
				aArtId = $(this).attr("artid");
				speichern("", "ja");
				$("#ArtenListe").empty();
			});

			//Editieren von Beobachtungen managen, ausgehend von ArtName
			$("select#aArtName").tap(function(event){
				event.preventDefault();
				$.mobile.changePage("../../Artenliste.html", "slide", true, false);
				ArtlisteAufbauen(aArtGruppe, "Edit");
			});

			//Für jedes Feld bei Änderung speichern
			$("#aAutor").change(function(){
				speichern("../../", "nein");
			});
			$("#oXKoord").change(function(){
				speichern("../../", "nein");
			});
			$("#oYKoord").change(function(){
				speichern("../../", "nein");
			});
			$("#oLagegenauigkeit").change(function(){
				speichern("../../", "nein");
			});
			$("#zDatum").change(function(){
				speichern("../../", "nein");
			});
			$("#zZeit").change(function(){
				speichern("../../", "nein");
			});
			
			$("#GeButton").tap(function(event) {
				$.mobile.changePage("#BeobEditMap", "slide", false, false);
			});

			$("#GetGeolocationButton").tap(function(){
				GetGeolocation();
			});

			//In diesem Array werden alle Marker gespeichert, damit sie gelöscht werden können
			var markersArray = [];
			var InfoWindowArray = [];

			$('#BeobEditMap').live("pagecreate", function() {
				var map;
				var verorted;
				if (oLatitudeDecDeg != "" && oLongitudeDecDeg != "") {
					var lat = oLatitudeDecDeg;
					var lng = oLongitudeDecDeg;
					verorted = true;
				} else {
					var lat = 47.360566;
					var lng = 8.542829;
					verorted = false;
				}
				var ZoomLevel;
				if (verorted == true) {
					ZoomLevel = 15;
				} else {
					ZoomLevel = 12;
				}
				var latlng = new google.maps.LatLng(lat, lng);
				var options = {
				    zoom: ZoomLevel,
				    center: latlng,
				    streetViewControl: false,
				    mapTypeId: google.maps.MapTypeId.HYBRID
				};
				var mapcanvas = $('#map_canvas');
				var map = new google.maps.Map(mapcanvas[0],options);
				google.maps.event.trigger(map,'resize');
				var aArtGruppe = $("select#aArtGruppe").val();
				var aArtName = $("select#aArtName").val();
				var aAutor = $("input#aAutor").val();
				var zDatum = $("input#zDatum").val();
				var zZeit = $("input#zZeit").val();
				var image = "../../Artgruppenbilder/" + aArtGruppe + ".png";
				if (verorted == true){
					var marker = new google.maps.Marker({
						position: latlng, 
					    map: map, 
					    title: aArtName,
					    icon: image,
						draggable: true
					});
					//Marker in Array speichern, damit er gelöscht werden kann
					markersArray.push(marker); 
					var contentString = '<div id="content">'+
					    '<div id="siteNotice">'+
					    '</div>'+
					    '<h4 id="firstHeading" class="GmInfowindow">' + aArtName + '</h4>'+
					    '<div id="bodyContent" class="GmInfowindow">'+
					    '<p>Art-Gruppe: ' + aArtGruppe + '</p>'+
					    '<p>Autor: ' + aAutor + '</p>'+
					    '<p>Datum: ' + zDatum + '</p>'+
					    '<p>Zeit: ' + zZeit + '</p>'+
					    '</div>'+
					    '</div>';
					var infowindow = new google.maps.InfoWindow({
					    content: contentString
					});
					InfoWindowArray.push(infowindow);
					google.maps.event.addListener(marker, 'click', function() {
					  infowindow.open(map,marker);
					});
					google.maps.event.addListener(marker, "dragend", function(event) {
						SetLocation(event.latLng, map, marker);
					});
				}
				google.maps.event.addListener(map, 'click', function(event) {
					placeMarker(event.latLng, map, marker, image, aArtName);
				});
			});

			function placeMarker(location, map, marker, image, aArtName) {
				//zuerst bisherigen Marker löschen
				clearMarkers();
				var marker = new google.maps.Marker({
			    	position: location, 
			    	map: map,
			    	title: aArtName,
			    	icon: image,
					draggable: true
				});
				//Marker in Array speichern, damit er gelöscht werden kann
				markersArray.push(marker);
				google.maps.event.addListener(marker, "dragend", function(event) {
					SetLocation(event.latLng, map, marker);
				});
				SetLocation(location, map, marker);
			}

			function SetLocation(LatLng, map, marker) {
				var lat = LatLng.lat();
				var lng = LatLng.lng();
				oLatitudeDecDeg = lat;
				oLongitudeDecDeg = lng;
				var x = DdInChX(lat, lng);
				var y = DdInChY(lat, lng);
				$("input#oXKoord").val(x);
				$("input#oYKoord").val(y);
				$("input#oLagegenauigkeit").val("Auf Luftbild markiert");
				clearInfoWindows();
				var contentString = '<div id="content"><div id="bodyContent">'+
								'<p>' + $("input#oXKoord").val() + "/" + $("input#oYKoord").val() + '</p>' +
								'</div></div>';
				var infowindow = new google.maps.InfoWindow({
				    content: contentString
				});
				InfoWindowArray.push(infowindow);
				google.maps.event.addListener(marker, 'click', function() {
				  infowindow.open(map,marker);
				});
				speichern("../../", "nein");
			}

			//alle Marker löschen
			function clearMarkers() {
				if (markersArray) {
					for (i in markersArray) {
				    	markersArray[i].setMap(null);
				    }
				}
			}

			//alle InfoWindows löschen
			function clearInfoWindows() {
				if (InfoWindowArray) {
					for (i in InfoWindowArray) {
				    	InfoWindowArray[i].setMap(null);
				    }
				}
			}

			//Code für den Beobachtung-Löschen-Dialog
			$('#LöschenDialogLink').live('click', function() {
				$(this).simpledialog({
					'mode' : 'bool',
			    	'prompt' : 'Beobachtung löschen?',
			    	'forceInput': 'false',
			    	'buttons' : {
					 	'ja': {
					      	click: function () {
					        	$('#dialogoutput').text('ja');
					        	handleDelete();
			        		},
			        		icon: "delete",
			        		theme: "c"
			      		},
			      		'nein': {
			        		click: function () {
			          			$('#dialogoutput').text('nein');
			        		}
			      		}
			    	}
			  	})
			});

			//UserId ermitteln, um Link zum UserEdit im Menü zu setzen
			var UserId;
			$db.view("evab/User",
				{success: function(data) {
					var i;
					var doc;
					for(i in data.rows) {
						key = data.rows[i].key;
						doc = data.rows[i].value;
						if (key == User) {
							UserId = doc._id;
						}
					}
				}
			});

			//Menu aufbauen
			$("[name='Menu']").live('click', function(){
				MenuAufbauen(this, User, UserId, "../../");
			});

			//Seitenhöhe korrigieren, weil sonst GoogleMap weiss bleibt
			contentHeight = $(window).height() - 43;
			$("#map_canvas").css("height", contentHeight + "px");

			//transitions ausschalten, weil das auf Android nativ miserabel funktioniert
			$(document).bind("mobileinit", function(){
				defaultDialogTransition = none;
			});
		});
	</script>
	<script type="text/javascript">
		Monate = new Array("Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember");
		jQuery.extend(jQuery.mobile.datebox.prototype.options, {
			'dateFormat': 'YYYY-MM-DD',
			'headerFormat': 'YYYY-MM-DD',
			'monthsOfYear': Monate
		});
		
		function refreshArtGruppe(aArtGruppe)
		{
			$("select#aArtGruppe").selectmenu();
			$("select#aArtGruppe").empty();
			var startoption = "<option value='" + aArtGruppe + "'>" + aArtGruppe + "</option>";
			$("select#aArtGruppe").append(startoption);
			$("select#aArtGruppe").val(aArtGruppe);
			$("select#aArtGruppe").selectmenu("refresh");
		}
		
		function refreshArtName(aArtName)
		{
			$("select#aArtName").selectmenu();
			$("select#aArtName").empty();
			var startoption = "<option value='" + aArtName + "'>" + aArtName + "</option>";
			$("select#aArtName").append(startoption);
			$("select#aArtName").val(aArtName);
			$("select#aArtName").selectmenu("refresh");
		}

		function GetGeolocation(){
			if (navigator.geolocation) { 
	        navigator.geolocation.getCurrentPosition ( 
	            function(position) {
	                oLongitudeDecDeg = position.coords.longitude;
					oLatitudeDecDeg = position.coords.latitude;
					var oLagegenauigkeit = position.coords.accuracy;
					$("input#oLagegenauigkeit").val(oLagegenauigkeit);
					var x = DdInChX(oLatitudeDecDeg, oLongitudeDecDeg);
					var y = DdInChY(oLatitudeDecDeg, oLongitudeDecDeg);
					$("input#oXKoord").val(x);
					$("input#oYKoord").val(y); 
					MeldungEinzeilig('Koordinaten wurden gesetzt');
					speichern("../../", "nein");
	            }, 
	            function(){ 
	                MeldungEinzeilig('Keine Positionsdaten verfügbar');
	            }); 
	        }
		}

		//Speichert alle Daten
		//Pfad: Ist "", wenn von ArtenListe.html aus gespeichert wird. Sonst "../../"
		//BeobEditAufrufen: Bestimmt of das Formular nach dem Speichern geöffnet werden soll. Ist "nein" wenn von der Karte aus gespeichert wird. Auch, wenn schon von BeobEdit.html aus gespeichert wird. Ist "ja", wenn von ArtenListe.html aus gespeichert wird
		function speichern(Pfad, BeobEditAufrufen){
			$db.openDoc(docId, {
				success: function(doc) {
					doc.Modus = "einfach";
					doc.Typ = "Beobachtung";
					doc.User = User;
					doc.aArtGruppe = aArtGruppe;
					doc.aArtName = aArtName;
					doc.aArtId = aArtId;
					if ($("input#aAutor").val()!=""){
						doc.aAutor = $("input#aAutor").val();
					} else if (doc.aAutor!=null){
						delete doc.aAutor;
					}
					if ($("input#oXKoord").val()!=""){
						doc.oXKoord = $("input#oXKoord").val();
					} else if (doc.oXKoord!=null){
						delete doc.oXKoord;
					}
					if ($("input#oYKoord").val()!=""){
						doc.oYKoord = $("input#oYKoord").val();
					} else if (doc.oYKoord!=null){
						delete doc.oYKoord;
					}
					if (oLongitudeDecDeg != ""){
						doc.oLongitudeDecDeg = oLongitudeDecDeg;
					} else if (doc.oLongitudeDecDeg != null){
						delete doc.oLongitudeDecDeg;
					}
					if (oLatitudeDecDeg != ""){
						doc.oLatitudeDecDeg = oLatitudeDecDeg;
					} else if (doc.oLatitudeDecDeg != null){
						delete doc.oLatitudeDecDeg;
					}
					if ($("input#oLagegenauigkeit").val()!=""){
						doc.oLagegenauigkeit = $("input#oLagegenauigkeit").val();
					} else if (doc.oLagegenauigkeit!=null){
						delete doc.oLagegenauigkeit;
					}
					if ($("input#zDatum").val()!=""){
						doc.zDatum = $("input#zDatum").val();
					} else if (doc.zDatum!=null){
						delete doc.zDatum;
					}
					if ($("input#zZeit").val()!=""){
						doc.zZeit = $("input#zZeit").val();
					} else if (doc.zZeit!=null){
						delete doc.zZeit;
					}
					$db.saveDoc(doc, {
						success: function(data) {
							if (BeobEditAufrufen == "ja"){
								window.open(Pfad + "_show/BeobEdit/" + data.id, target="_self");
							}
							refreshBeobListe("../../");
						},
						error: function() {
							MeldungEinzeilig("Die Beobachtung konnte nicht gespeichert werden.");
						 }
					});
				},
				error: function() {
					MeldungZweizeilig("Diese Beobachtung kann nicht geöffnet werden:", docId);
				}
			});
		}
		
		function handleDelete(event)
		{
			// First open doc based on ID in order to get full document
			$db.openDoc(docId, {
				success: function(document) {
					// Then use the opened doc as reference to remove
					$db.removeDoc(document, {
						success: function() {
							window.open("../../BeobListe.html", target = '_self');
						},
						error: function() {
							MeldungEinzeilig("Die Beobachtung mit der ID: " + docId + " konnte nicht gelöscht werden");
						}
					});
				},
				error: function() {
					MeldungEinzeilig("Eine Beobachtung mit der ID: " + docId + " wurde nicht gefunden");
				}
			});
		}
	</script>
</html>
