<!DOCTYPE html>
<html>
  <head>
  	<link rel="SHORTCUT ICON" href="../../Bilder/favicon.ico">
  	<meta http-equiv=Content-Type content="text/html; charset=UTF-8"/>
  	<meta name="viewport" content="width=device-width, initial-scale=1"/>
  	<title>EvAB</title>
  	<link rel="stylesheet" href="../../style/jquery.mobile.css" type="text/css"/>
  	<link rel="stylesheet" href="../../style/evab.css" type="text/css"/>
   	<link rel="stylesheet" href="../../style/evab_theme.css" type="text/css"/>
  	<link rel="stylesheet" href="../../style/jquery.mobile.simpledialog.css" type="text/css"/>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.js"></script>
	<script type="text/javascript">			
		$(document).bind("mobileinit", function(){
			//$.mobile.defaultPageTransition  = 'none';
			$.event.special.swipe.horizontalDistanceThreshold = 250;
		});
    </script>	
	<script type="text/javascript" src="../../vendor/couchapp/jquery.couch.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.couch.app.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.mustache.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.mobile.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.validate.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/phonegap.js" defer="defer"></script>
	<script type="text/javascript" src="../../vendor/couchapp/evab.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.mobile.simpledialog.js"></script>
    
	
  </head>
  <body>
  	<div data-role="page" id="FeldEditPage">
  		<script type="text/javascript">
			//$(document).ready(function() {  //wird erst nach pagebeforeshow aufgerufen! darum pagebeforecreate verwenden
			//$(document).delegate("#FeldEditPage", "pageInit", function() {     //wird auch nach pagebeforeshow aufgerufen
			$(document).delegate("#FeldEditPage", "pagebeforecreate", function() {
			
				var Pfad = "../../";
				User = "";
			
				prüfeAnmeldung(Pfad);
				erstelleSelectFeldFolgtNach();

				//jedes Feld aus Feldeigenschaften bei Änderung speichern
				$("#FeldEditForm").on("change", ".Feldeigenschaften", function() {
					var FeldWert = this.value;
					var FeldName = this.name;
					var AlterFeldWert = this.defaultValue;
					if ("{{User}}" === "ZentrenBdKt") {
						//Felder der Datenzentren dürfen nicht verändert werden
						//ausser Standardwert, dessen Änderung wird aber spezifisch abgehört
						$("#" + FeldName).val(AlterFeldWert);
						melde("Dies ist ein geschütztes Feld eines öffentlichen Datenzentrums<br><br>Sie können ein neues Feld erstellen");
					} else if (FeldName === "FeldName") {
						//Wenn eigener Feldname verändert wird, kontrollieren, dass er nicht schon verwendet wurde
						if ("{{FeldName}}") {
							//wenn ein alter Feldname existiert,
							//zählen, in wievielen Datensätzen das Feld verwendet wird
							$db = $.couch.db("evab");
							$db.view('evab/FeldSuche?key="' + User + '"&include_docs=true', {
								success: function(data) {
									var i;
									var anzVorkommen = 0;
									var Datensatz;
									var Feld;
									for(i in data.rows) {
										Datensatz = data.rows[i].doc; 
										Feld = eval("Datensatz." + "{{FeldName}}");
										if (Feld) {
											anzVorkommen += 1;
										}
									}
									if (anzVorkommen == 0) {
										//prüfen, ob der Feldname schon existiert
										//wenn ja: melden, zurückstellen
										//wenn nein: In SichtbareFelder nachführen und speichern
										prüfeFeldNamen(User);
									} else {
										var ds = "Datensätzen";
										if (anzVorkommen = 1) {
											ds = "Datensatz";
										}
										$("#FeldName").val("{{FeldName}}");
										melde("Ändern abgebrochen:<br>Dieses Feld wird in " + anzVorkommen + " " + ds + " verwendet<br>Bereinigen Sie zuerst die Daten");
									}
								}
							});
						} else {
							//Wenn dies ein neues Feld ist
							//prüfen, ob der Feldname schon existiert
							//wenn ja: melden, zurückstellen
							//wenn nein: In SichtbareFelder nachführen und speichern
							prüfeFeldNamen(User);
						}
					} else if (FeldName === "Hierarchiestufe" && FeldWert == "Art") {
						speichereFeldeigenschaften();
						//Wenn die Hierarchiestufe zu Art geändert wird, muss das Feld für die Artgruppe aufgebaut werden
						ArtGruppeAufbauen();
					} else if (FeldName === "Hierarchiestufe" && FeldWert != "Art") {
						speichereFeldeigenschaften();
						$db = $.couch.db("evab");
						$db.openDoc("{{id}}", {
							success: function(doc) {
								var letzteHierarchiestufe = doc.Hierarchiestufe;
								if (letzteHierarchiestufe == "Art") {
									//Wenn die Hierarchiestufe Art war und geändert wird, muss das Feld für die Artgruppe entfernt werden
									$("#Artgruppenliste").empty();
								}
							}
						});
					} else {
						speichereFeldeigenschaften();
						/*$("#FeldEditForm").validate({          FUNKTIONIERT NICHT
							debug: true,
							onsubmit: false,
							rules: {
								FeldName: "required",
								Beschriftung: "required",
								Reihenfolge: "required",
							},
							messages: {
								FeldName: "Bitte Feldnamen erfassen",
								Beschriftung: "Bitte Beschriftung erfassen",
								Reihenfolge: "Bitte Reihenfolge erfassen",
							},
						    submitHandler: function(form) {
						        speichereFeldeigenschaften();
						    }
						});*/
					}
				});

				$("#FeldEditForm").on("change", "#FeldFolgtNach", function(event) {
					setzeReihenfolgeMitVorgänger(this.value)
				});

				$("#Standardwert").bind("change", function() {
					var Optionen = $("#Optionen").val();
					var Feldwert = this.value;
					if (Optionen !== "") {
						$db = $.couch.db("evab");
						$db.openDoc("{{id}}", {
							success: function(doc) {
								var LetzterFeldwert;
								if (doc.Standardwert) {
									if (doc.Standardwert[User]) {
										LetzterFeldwert = doc.Standardwert[User];
									} else {
										LetzterFeldwert = "";
									}
								} else {
									LetzterFeldwert = "";
								}
								var Formularelement = doc.Formularelement;
								//Standardwert in Array verwandeln
								StandardwertOptionen = Feldwert.split(",");
								//Es sind Optionen erfasst. Standardwert muss eine oder mehrere dieser Optionen sein
								if (["multipleselect", "checkbox"].indexOf(Formularelement) > -1) {
									//alle Werte des Arrays müssen Optionen sein
									for (i in StandardwertOptionen) {
										if (Optionen.indexOf(StandardwertOptionen[i]) == -1) {
											//ein Wert ist keine Option, abbrechen
											$("#Standardwert").val(LetzterFeldwert);
											melde("Ändern abgebrochen:<br>Wählen Sie eine oder mehrere der Optionen");
											return;
										}
									}
									//alle Werte sind Optionen
									speichereStandardwert(User);
								} else if (["toggleswitch", "selectmenu", "radio"].indexOf(Formularelement) > -1) {
									//Array darf nur ein Element enthalten
									if (StandardwertOptionen.length > 1) {
										//Array enthält mehrere Optionen, nicht zulässig
										$("#Standardwert").val(LetzterFeldwert);
										melde("Ändern abgebrochen:<br>Wählen Sie eine einzige der Optionen");
									} else {
										//Array enthält eine einzige Option
										for (i in StandardwertOptionen) {
											if (Optionen.indexOf(StandardwertOptionen[i]) == -1) {
												//der Wert ist keine Option, abbrechen
												$("#Standardwert").val(LetzterFeldwert);
												melde("Ändern abgebrochen:<br>Wählen Sie eine oder mehrere der Optionen");
												return;
											}
										}
										//alle Werte sind Optionen
										speichereStandardwert(User);
									}
								} else {
									//Optionen sind erfasst, Feld braucht aber keine. Alle Werte akzeptieren
									speichereStandardwert(User);
								}
							}
						});
					} else {
						//Feld Optionen ist leer. Alle Werte akzeptieren
						speichereStandardwert(User);
					}
				});

				//Sichtbarkeit Modus hierarchisch speichern
				$("#SichtbarImModusHierarchisch").change(function() {
					speichereSichtbarModusHierarchisch(User, this.value);
				});

				//Sichtbarkeit Modus einfach speichern
				$("#SichtbarImModusEinfach").change(function() {
					speichereSichtbarModusEinfach(User, this.value);
				});

				//Code für den Feld-Löschen-Dialog
				$('#LöschenDialogLink').bind('click', function() {
					if ("{{User}}" == "ZentrenBdKt") {
						melde("Dies ist ein Feld eines nationalen Datenzentrums<br><br>Es kann nicht gelöscht werden<br><br>Sie können es ausblenden");
					} else {
						$(this).simpledialog({
							'mode' : 'bool',
					    	'prompt' : 'Dieses Feld löschen?',
					    	'forceInput': 'false',
					    	'buttons' : {
							 	'ja': {
							      	click: function() {
							        	$('#dialogoutput').text('ja');
							        	if ("{{FeldName}}" == "") {
							        		//Ohne Feldname kann nicht kontrolliert werden, in wievielen Datensätzen das Feld vorkommt
							        		//Feld = eval("Datensatz." + "{{FeldName}}") lieferte einen Fehler!
							        		löscheFeld(Pfad);
							        	} else {
											$db = $.couch.db("evab");
											//zählen, in wievielen Datensätzen das Feld verwendet wird
											$db.view('evab/FeldSuche?key="' + User + '"&include_docs=true', {
												success: function(data) {
													var i;
													var anzVorkommen = 0;
													var Datensatz;
													var Feld;
													for(i in data.rows) {
														Datensatz = data.rows[i].doc;
														Feld = eval("Datensatz." + "{{FeldName}}");
														if (Feld) {
															anzVorkommen += 1;
														}
													}
													if (anzVorkommen == 0) {
														löscheFeld(Pfad);
													} else {
														var ds = "Datensätzen";
														if (anzVorkommen = 1) {
															ds = "Datensatz";
														}
														melde("Löschen abgebrochen:<br>Dieses Feld wird in " + anzVorkommen + " " + ds + " verwendet<br>Bereinigen Sie zuerst die Daten");
													}
												}
											});
										}
					        		},
					        		icon: "delete",
					        		theme: "c"
					      		},
					      		'nein': {
					        		click: function() {
					          			$('#dialogoutput').text('nein');
					        		}
					      		}
					    	}
					  	})
					}
				});

				//Menu aufbauen
				$("[name='Menu']").bind('click', function(){
					erstelleMenuFürFelder(this, "../../");
				});

				//BackButton steuern
				$("[name='BackButton']").bind('click', function(){
					geheZurück();
				});

				//swipen steuern
				$("body").on("swipeleft", "#FeldContent", function() {
					geheZumNächstenFeld(User, "{{id}}");
				});

				$("body").on("swiperight", "#FeldContent", function() {
					geheZumVorigenFeld(User, "{{id}}");
				});
			});

			//$(document).delegate("#FeldEditPage", "pagebeforecreate", function() {
			//$(document).delegate("#FeldEditPage", "pagecreate", function() {
			//$(document).bind("pageInit", function(){
			//$("#FeldEditPage").bind("pageInit", function(){
			//jQuery("div:jqmData(role='page'):last").bind('pageInit', function() {
			//$(document).live("pagebeforeshow", function(){
			$(document).delegate("#FeldEditPage", "pagebeforeshow", function() {

				//alert("Feldname = " + "{{FeldName}}" + ", pagebeforeshow läuft");

				speichereLetzteUrl(User);
				
				//Sichtbarkeit in Modi Hierarchisch und einfach setzen
				//Artgruppe Aufbauen, wenn Hierarchiestufe == Art
				//und allfälligen Standardwert anzeigen
				//in einer Funktion zusammengefasst, weil dasselbe Dokument abgefragt werden muss
				setzeSichtbarInModiUndArtgruppeUndStandardwert(User);

				if ("{{FeldName}}") {
					//fix in Formulare eingebaute Felder: Standardwerte ausblenden und erklären
					if (["aArtGruppe", "aArtName"].indexOf("{{FeldName}}") > -1) {
						$("#Standardwert").attr("placeholder", "Keine Voreinstellung möglich");
						$("#Standardwert").attr("disabled", true);
					} else if ("{{FeldName}}" == "aAutor") {
						$("#Standardwert").attr("placeholder", 'Bitte im Menü "meine Einstellungen" voreinstellen');
						$("#Standardwert").attr("disabled", true);
					} else if (["oXKoord", "oYKoord", "oLatitudeDecDeg", "oLongitudeDecDeg", "oLagegenauigkeit"].indexOf("{{FeldName}}") > -1) {
						$("#Standardwert").attr("placeholder", 'Lokalisierung erfolgt automatisch, keine Voreinstellung möglich');
						$("#Standardwert").attr("disabled", true);
					} else if (["zDatum", "zUhrzeit"].indexOf("{{FeldName}}") > -1) {
						$("#Standardwert").attr("placeholder", 'Standardwert ist "jetzt", keine Voreinstellung möglich');
						$("#Standardwert").attr("disabled", true);
					}
				}
				$(".FeldEditHeaderTitel").text("{{Hierarchiestufe}}" + ": " + "{{FeldBeschriftung}}");
				
				//Radio Felder initiieren (ausser ArtGruppe, das wird dynamisch erzeugt)
				$("input[name='Hierarchiestufe']").checkboxradio();
				$("#{{Hierarchiestufe}}").prop("checked",true).checkboxradio("refresh");
				$("input[name='Formularelement']").checkboxradio();
				$("#{{Formularelement}}").prop("checked",true).checkboxradio("refresh");
				$("input[name='InputTyp']").checkboxradio();
				$("#{{InputTyp}}").prop("checked",true).checkboxradio("refresh");

				
			});
		</script>
		<script type="text/javascript">
			function setzeSichtbarInModiUndArtgruppeUndStandardwert(User){
				//wenn mit den von Mustache übergebenen Arrays vernünftig gearbeitet werden könnte,
				//könnte man sich diese Abfrage ersparen!
				//in einer Funktion zusammengefasst, weil dasselbe Dokument abgefragt werden muss
				$db = $.couch.db("evab");
				$db.openDoc("{{id}}", {
					success: function(Feld) {
						//korrekte Werte in Felder SichtbarImModusEinfach und -Hierarchisch setzen
						var SichtbarImModusHierarchisch = Feld.SichtbarImModusHierarchisch;
						var SichtbarImModusEinfach = Feld.SichtbarImModusEinfach;
						//Vorsicht: Bei neuen Feldern gibt es Feld.SichtbarImModusHierarchisch noch nicht
						if (SichtbarImModusHierarchisch && SichtbarImModusHierarchisch.indexOf(User) != -1) {
							$("select#SichtbarImModusHierarchisch").val("ja");
						} else {
							$("select#SichtbarImModusHierarchisch").val("nein");
						}
						$("select#SichtbarImModusHierarchisch").slider();
						$("select#SichtbarImModusHierarchisch").slider("refresh");
						//Vorsicht: Bei neuen Feldern gibt es Feld.SichtbarImModusEinfach noch nicht
						if (SichtbarImModusEinfach && SichtbarImModusEinfach.indexOf(User) != -1) {
							$("select#SichtbarImModusEinfach").val("ja");
						} else {
							$("select#SichtbarImModusEinfach").val("nein");
						}
						$("select#SichtbarImModusEinfach").slider();
						$("select#SichtbarImModusEinfach").slider("refresh");
						
						//Artgruppe Aufbauen, wenn Hierarchiestufe == Art
						if ("{{Hierarchiestufe}}" === "Art") {
							ArtGruppeAufbauen(Feld.ArtGruppe);
						}
						
						//allfälligen Standardwert anzeigen
						//Standardwert ist Objekt, darin werden die Standardwerte aller Benutzer gespeichert
						//darum hier auslesen und setzen
						if (Feld.Standardwert) {
							var Standardwert = eval("Feld.Standardwert." + User);
							if (Standardwert) {
								$("#Standardwert").val(Standardwert);
							}
						}
					}
				});
			}

			function prüfeFeldNamen(User) {
				var FeldNameAlt = "{{FeldName}}" || "";
				var FeldNameNeu = $("#FeldName").val();
				var viewname = 'evab/FeldNamen?key="' + FeldNameNeu + '"';
				$db = $.couch.db("evab");
				$db.view(viewname, {
					success: function(data) {
						var i;
						var key;
						var Feld;
						for(i in data.rows) {
							//kommt ein Feld mit diesem Namen schon vor?
							if (data.rows[i].value) {
								Feld = data.rows[i].value;
								//ist es ein eigenes oder ein offizielles?
								if (Feld.User == User || Feld.User == "ZentrenBdKt") {
									//ja > dieser Name ist nicht zulässig
									$("#FeldName").val(FeldNameAlt);
									$("#FeldName").focus();
									melde("Dieser Feldname existiert schon<br>Wählen Sie einen anderen");
								} else {
									//Feldname ist bei diesem User neu, somit zulässig > speichern
									//und alten FeldNamen aus der Liste der anzuzeigenden Felder entfernen
									speichereSichtbarModusHierarchisch(User, "ja"); 
									speichereFeldeigenschaften();
								}
							} else {
								//Feldname ist neu, somit zulässig > speichern
								//und alten FeldNamen aus der Liste der anzuzeigenden Felder entfernen
								speichereSichtbarModusHierarchisch(User, "ja"); 
								speichereFeldeigenschaften();
							}
						}
					}
				});
			}

			function speichereSichtbarModusHierarchisch(User, SichtbarImModusHierarchisch) {
				var FeldName = $("#FeldName").val();
				$db = $.couch.db("evab");
				$db.openDoc("{{id}}", {
					success: function(Feld) {
						if (SichtbarImModusHierarchisch == "ja") {
							Feld.SichtbarImModusHierarchisch.push(User);
						} else {
							var idx = Feld.SichtbarImModusHierarchisch.indexOf(User);
							if(idx!=-1) Feld.SichtbarImModusHierarchisch.splice(idx, 1);
						}
						$db.saveDoc(Feld, {
							error: function() {
								melde("Fehler: nicht gespeichert");
							}
						});
					},
					error: function() {
						melde("Fehler: nicht gespeichert");
					}
				});
			}

			function speichereSichtbarModusEinfach(User, SichtbarImModusEinfach) {
				var FeldName = $("#FeldName").val();
				$db = $.couch.db("evab");
				$db.openDoc("{{id}}", {
					success: function(Feld) {
						if (SichtbarImModusEinfach == "ja") {
							Feld.SichtbarImModusEinfach.push(User);
						} else {
							var idx = Feld.SichtbarImModusEinfach.indexOf(User);
							if(idx!=-1) Feld.SichtbarImModusEinfach.splice(idx, 1);
						}
						$db.saveDoc(Feld, {
							error: function() {
								melde("Fehler: nicht gespeichert");
							}
						});
					},
					error: function() {
						melde("Fehler: nicht gespeichert");
					}
				});
			}
			
			function ArtGruppeAufbauen(ArtGruppenArrayIn) {
				$db = $.couch.db("evab");
				$("select#ArtGruppe").empty();
				var viewname = "evab/Artgruppen";
				$db.view(viewname, {
					success: function(data) {
						var i;
						var ArtGruppe;
						var ListItemContainer = "<fieldset data-role='controlgroup'>\n\t<legend>Artgruppen:</legend>";
						var listItem;
						var ArtGruppenArray = ArtGruppenArrayIn || [];
						for(i in data.rows) {
							ArtGruppe = data.rows[i].key;
							listItem = "<input type='checkbox' class='custom Feldeigenschaften' name='ArtGruppe' id='";
							listItem += ArtGruppe;
							listItem += "' value='";
							listItem += ArtGruppe;
							if(ArtGruppenArray.indexOf(ArtGruppe)!=-1) {
								listItem += "' checked='checked";
							}
							listItem += "'/>\n<label for='";
							listItem += ArtGruppe;
							listItem += "'>";
							listItem += ArtGruppe;
							listItem += "</label>";
							ListItemContainer += listItem;
						}
						ListItemContainer += "\n</fieldset>"
						$("#Artgruppenliste").html(ListItemContainer).trigger("create").trigger("refresh");
						//Fehler korrigieren: Untere Navbar wird nur teilweise angezeigt
						//$.mobile.fixedToolbars.show(true);
					}
				});
			}

			function löscheFeld(Pfad) {
				var docId = "{{id}}";
				$db = $.couch.db("evab");
				$db.openDoc(docId, {
					success: function(document) {
						$db.removeDoc(document, {
							success: function() {
								window.open(Pfad + "FeldListe.html?zurueck=" + get_url_param("zurueck"), target = '_self');
							},
							error: function() {
								melde("Fehler: nicht gelöscht");
							}
						});
					},
					error: function() {
						melde("Fehler: nicht gelöscht");
					}
				});
				return false;
			}

		function prüfeAnmeldung(Pfad) {		
			//User Anmeldung überprüfen
			//Wenn angemeldet, globale Variable User aktualisieren
			//Wenn nicht angemeldet, Anmeldedialog öffnen
			$.ajax({
			    url: '/_session',
			    dataType: 'json',
			    async: false,
			    success: function(session){
			    	if(session.userCtx.name != (undefined || null)) {
			        	User = session.userCtx.name;
			        } else {
						window.open(Pfad + "index.html?Status=neu", target="_self");
					}
			    }
			});
		}

		//Öffnet das nächste Feld
		//nächstes des letzten => melden
		//erwartet die ID des aktuellen Datensatzes
		function geheZumNächstenFeld(User, IdAktuell) {
			$db = $.couch.db("evab");
			$db.view('evab/FeldListe', {
				success: function(data) {
					var i, y;
					var FeldIdAktuell;
					var FeldIdNächstes;
					var AnzFelder = data.rows.length -1;  
					for(i in data.rows) {
						//alle Felder durchlaufen, aktuelles eigenes oder offizielles suchen
						Feld = data.rows[i].value;
						//vorsicht: Objekte zählen Elemente ab 1, Arrays ab 0!
						if (Feld.User == User || Feld.User == "ZentrenBdKt") {
							//Nur eigene und offizielle Felder berücksichtigen
							FeldIdAktuell = data.rows[i].value._id;
							if (FeldIdAktuell == IdAktuell) {
								//das ist das aktuelle Feld
								//von hier aus vorwärts das nächste eigene oder offizielle suchen
								if (i < AnzFelder) {
									//das aktuelle Feld ist nicht das letzte
									for (y = parseInt(i)+1; y <= AnzFelder; y++) {
										//alle verbleibenden Felder durchlaufen, eigenes suchen
										Feld = data.rows[y].value;
										//Nur eigene Felder und offizielle berücksichtigen
										if (Feld.User == User || Feld.User == "ZentrenBdKt") {
											//das ist das nächste eigene Feld > öffnen
											FeldIdNächstes = data.rows[parseInt(i)+1].value._id;
											window.open(FeldIdNächstes, target="_self");
											//$.mobile.changePage(FeldIdNächstes);
										} else {
											if (y == AnzFelder) {
												//am letzten Feld angelangt und es ist kein eigenes
												melde("Das ist das letzte Feld");
											}
										}
									}
								} else {
									//das aktuelle Feld ist das letzte
									melde("Das ist das letzte Feld");
								}
							}
						}
					}
				}
			});
		}

		//Öffnet das vorige Feld
		//voriges des ersten => FeldListe
		//erwartet die ID des aktuellen Datensatzes
		function geheZumVorigenFeld(User, IdAktuell) {
			$db = $.couch.db("evab");
			$db.view('evab/FeldListe', {
				success: function(data) {
					var i, y;
					var FeldIdAktuell;
					var FeldIdVoriges;
					var AnzFelder = data.rows.length -1;  
					for(i in data.rows) {
						//alle Felder durchlaufen, aktuelles eigenes oder offizielles suchen
						Feld = data.rows[i].value;
						//vorsicht: Objekte zählen Elemente ab 1, Arrays ab 0!
						if (Feld.User == User || Feld.User == "ZentrenBdKt") {
							//Nur eigene und offizielle Felder berücksichtigen
							FeldIdAktuell = data.rows[i].value._id;
							if (FeldIdAktuell == IdAktuell) {
								//das ist das aktuelle Feld
								//von hier aus rückwärts das nächste eigene oder offizielle suchen
								if (i > 0) {
									//das aktuelle Feld ist nicht das erste 
									for (y = parseInt(i)-1; y >= 0; y--) {
										//alle vorhergehenden Felder durchlaufen, eigenes suchen
										Feld = data.rows[y].value;
										//Nur eigene Felder und offizielle berücksichtigen
										if (Feld.User == User || Feld.User == "ZentrenBdKt") {
											//das ist das nächstvorherige eigene Feld > öffnen
											FeldIdVoriges = data.rows[parseInt(i)-1].value._id;
											window.open(FeldIdVoriges, target="_self");
											//$.mobile.changePage(FeldIdVoriges);
										} else {
											if (y == 1) {
												//am ersten Feld angelangt und es ist kein eigenes
												//wir gehen zur Feldliste
												geheZurück();
											}
										}
									}
								} else {
									//das aktuelle Feld ist das erste
									//wir gehen zur Feldliste
									geheZurück();	
								}
							}
						}
					}
				}
			});
		}

		//empfängt den Feldnamen des gewählten Vorgängers
		//ermittelt dessen Reihenfolge
		//sucht das nächste eigene Feld und setzt als Reihenfolge den Mittelwert der zwei Reihenfolgen
		//Wenn kein weiteres eigenes Feld kommt, wird als Reihenfolge der nächste um mindestens 1 höhere ganzzahlige Wert gesetzt
		function setzeReihenfolgeMitVorgänger(FeldNameVorgaenger) {
			$db = $.couch.db("evab");
			var viewname = 'evab/FeldListeFeldName?key="' + FeldNameVorgaenger + '"';
			$db.view(viewname, {
				success: function(data) {
					var ReihenfolgeVorgaenger = data.rows[0].value.Reihenfolge;
					$("#Reihenfolge").val(Math.floor(ReihenfolgeVorgaenger + 1));
					speichereFeldeigenschaften();
				}
			});
		}

		function erstelleSelectFeldFolgtNach() {
			//generiert den html-Inhalt für Selectmenus
			//wird von erstelle_hArtEdit aufgerufen
			//Nur bei eigenen Feldern anzeigen
			if ("{{User}}" !== "ZentrenBdKt") {
				$db = $.couch.db("evab");
				$db.view("evab/FeldListe", {
					success: function(data) {
						var i;
						var Feld; 
						var Optionen = [];
						Optionen.push("");
						for(i in data.rows) {                 
							Feld = data.rows[i].value;
							//Liste aufbauen
							//Nur eigene Felder und offizielle
							if (Feld.User == User || Feld.User == "ZentrenBdKt") {
								Optionen.push(Feld.FeldName);
							}
						}
						HtmlContainer = generiereHtmlFuerSelectmenu("FeldFolgtNach", "Feld folgt nach:", "", Optionen, "SingleSelect");
						$("#FeldFolgtNachDiv").html(HtmlContainer).trigger("create").trigger("refresh");
					}
				});
			}
		}

		function geheZurück() {
			var zurueck = get_url_param("zurueck");
			if (zurueck.slice(0, 6) == "Felder") {
				//direkt zurück, Feldliste auslassen
				window.open("../../" + zurueck, target="_self");
				
			} else {
				window.open("../../FeldListe.html?zurueck=" + zurueck, target="_self");
			}
		}

		function speichereStandardwert(User) {
			$db = $.couch.db("evab");
			$db.openDoc("{{id}}", {
				success: function(Feld) {
					//Standardwert managen
					//Standardwert ist Objekt, in dem die Werte für jeden User gespeichert werden
					//darum manuell für diesen User updaten
					var StandardwertUserImFormular = $("#Standardwert").val();
					if (Feld.Standardwert) {
						if (StandardwertUserImFormular != "") {
							//neuen Standardwert setzen
							Feld.Standardwert[User] = StandardwertUserImFormular;
						} else {
							//Standardwert ist leer
							if (eval("Feld.Standardwert." + User)) {
								//bisherigen Standardwert löschen
								delete Feld.Standardwert[User];
							}
						}
					} else {
						//Bisher gab es noch keinen Standardwert
						if (StandardwertUserImFormular != "") {
							//Objekt für Standardwert schaffen und neuen Wert setzen
							Feld.Standardwert = {};
							Feld.Standardwert[User] = StandardwertUserImFormular;
						}
					}
					$db.saveDoc(Feld, {
						success: function() {
							//melde("Feld gespeichert");
						},
						error: function() {
							melde("Fehler: Feld nicht gespeichert");
						}
					});
				},
				error: function() {
					melde("Fehler: Feld nicht gespeichert");
				}
			});
		}

		/*function speichereFeldeigenschaften(Feldname, Feldwert) {
			$db = $.couch.db("evab");
			//Bestehendes Dokument öffnen
			$db.openDoc("{{id}}", {
				success: function(Feld) {
					var Formularfelder = $("#FeldEditForm").serializeObjectNull();
					//Felder mit Arrays: Kommagetrennte Werte in Arrays verwandeln. Plötzlich nicht mehr nötig??!!
					if (Feldname === "Optionen") {
						Feldwert = Feldwert.split(",");
					}
					//Wenn Beschriftung fehlt und Name existiert: Beschriftung = Name
					if (!Formularfelder.FeldBeschriftung && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
						Formularfelder.FeldBeschriftung = Formularfelder.FeldName;
					}
					//Es braucht eine Reihenfolge
					if (!Formularfelder.Reihenfolge && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
						Formularfelder.Reihenfolge = 1;
					}
					//Es braucht einen Feldtyp
					if (!Formularfelder.Formularelement && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
						Formularfelder.Formularelement = "textinput";
						Formularfelder.InputTyp = "text";
					}
					//Wenn Feldtyp von textinput weg geändert wurde, sollte InputTyp entfernt werden
					if (Formularfelder.Formularelement !== "textinput" && Formularfelder.InputTyp) {
						delete Formularfelder.InputTyp;
						$("#{{InputTyp}}").prop("checked",false).checkboxradio("refresh");
					}
					//Wenn Feldtyp gesetzt wurde, muss ein InputTyp existieren. Wenn er nicht gesetzt wurde, text setzen
					if (Formularfelder.Formularelement === "textinput" && !Formularfelder.InputTyp) {
						Formularfelder.InputTyp = "text";
					}
					if (Feldwert) {
						Feld[Feldname] = Feldwert;
					} else if (Feld[Feldname]) {
						delete Feld[Feldname]
					}
					//alles speichern
					$db.saveDoc(Feld, {
						error: function() {
							melde("Fehler: Feld nicht gespeichert");
						}
					});
				}
			});
		}*/

		function speichereFeldeigenschaften() {
			$db = $.couch.db("evab");
			$db.openDoc("{{id}}", {
				success: function(Feld) {
					var Formularfelder = $("#FeldEditForm").serializeObjectNull();
					//Felder mit Arrays: Kommagetrennte Werte in Arrays verwandeln. Plötzlich nicht mehr nötig??!!
					if (Formularfelder.Optionen) {
						Formularfelder.Optionen = Formularfelder.Optionen.split(",");
					}
					/*if (Feld.ArtGruppe) {
						Feld.ArtGruppe = Feld.ArtGruppe.split(", ");
					}*/
					//Wenn Beschriftung fehlt und Name existiert: Beschriftung = Name
					if (!Formularfelder.FeldBeschriftung && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
						Formularfelder.FeldBeschriftung = Formularfelder.FeldName;
					}
					//Es braucht eine Reihenfolge
					if (!Formularfelder.Reihenfolge && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
						Formularfelder.Reihenfolge = 1;
					}
					//Es braucht einen Feldtyp
					if (!Formularfelder.Formularelement && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
						Formularfelder.Formularelement = "textinput";
						Formularfelder.InputTyp = "text";
					}
					//Wenn Feldtyp von textinput weg geändert wurde, sollte InputTyp entfernt werden
					if (Formularfelder.Formularelement !== "textinput" && Formularfelder.InputTyp) {
						delete Formularfelder.InputTyp;
						$("#{{InputTyp}}").prop("checked",false).checkboxradio("refresh");
					}
					//Wenn Feldtyp gesetzt wurde, muss ein InputTyp existieren. Wenn er nicht gesetzt wurde, text setzen
					if (Formularfelder.Formularelement === "textinput" && !Formularfelder.InputTyp) {
						Formularfelder.InputTyp = "text";
					}
					//Formularfelder in Dokument schreiben
					for (i in Formularfelder) {
						if (Formularfelder[i]) {	
							Feld[i] = Formularfelder[i];
						} else {
							//leere Felder entfernen, damit werden auch soeben gelöschte Felder entfernt
							delete Feld[i];
						}
					}
					$db.saveDoc(Feld, {
						error: function() {
							melde("Fehler: Feld nicht gespeichert");
						}
					});
				},
				error: function() {
					melde("Fehler: Feld nicht gespeichert");
				}
			});
		}

		
		</script>
  		<div data-role="header" data-position="fixed" data-tap-toggle="false" id="FeldEditHeader">
  			<a href="#" id="BackButton" name="BackButton" data-role="button" data-icon="arrow-l" data-iconpos="notext">abbrechen</a>
  			<h2 class="FeldEditHeaderTitel">Datenfelder</h2>
  			<a href='#' id='Menu' name='Menu' data-role='button' data-icon="gear" data-iconpos="notext" class="r ui-btn-right">Menu</a>
  		</div>
		<div id="FeldContent" data-role="content" style="padding:0em;">
			<form id="UserFeldForm" action="#" method="get" autocomplete="off">
				<h2>meine Einstellungen</h2>
				<div data-role="fieldcontain">
					<label for="SichtbarImModusEinfach">Sichtbar im einfachen Modus?</label>
					<select name="SichtbarImModusEinfach" id="SichtbarImModusEinfach" data-role="slider">
						<option value="nein">nein</option>
						<option value="ja">ja</option>
					</select> 
				</div>
				<div data-role="fieldcontain">
					<label for="SichtbarImModusHierarchisch">Sichtbar im hierarchischen Modus?</label>
					<select name="SichtbarImModusHierarchisch" id="SichtbarImModusHierarchisch" data-role="slider">
						<option value="nein">nein</option>
						<option value="ja">ja</option>
					</select> 
				</div>
				<div data-role="fieldcontain">
					<label for="Standardwert">Standardwert:</label>
					<input id="Standardwert" name="Standardwert" type="text"  placeholder="dieser Wert wird bei neuen Beobachtungen in diesem Feld eingefügt"/>
				</div>
			</form>
				<hr>
				<h2>Feldeigenschaften</h2>
			<form id="FeldEditForm" action="#" method="get" data-identity="{{document}}">
				<div data-role="fieldcontain">
					<fieldset data-role="controlgroup">
						<legend>Hierarchiestufe (erforderlich):</legend>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Projekt" value="Projekt"/>
	         				<label for="Projekt">Projekt</label>
	         				<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Raum" value="Raum"/>
	         				<label for="Raum">Raum</label>
	         				<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Ort" value="Ort"/>
	         				<label for="Ort">Ort</label>
	         				<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Zeit" value="Zeit"/>
	         				<label for="Zeit">Zeit</label>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Art" value="Art"/>
	         				<label for="Art">Art</label>
	         		</fieldset>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldName">Name:</label>
					<input class="Feldeigenschaften required" id="FeldName" name="FeldName" type="text" value="{{FeldName}}" placeholder="erforderlich"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschriftung">Beschriftung:</label>
					<input class="Feldeigenschaften required" id="FeldBeschriftung" name="FeldBeschriftung" type="text" value="{{FeldBeschriftung}}" placeholder="erforderlich"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschreibung">Beschreibung:</label>
					<textarea class="Feldeigenschaften" id="FeldBeschreibung" name="FeldBeschreibung">{{FeldBeschreibung}}</textarea>
				</div>
				<div data-role="fieldcontain">
					<label for="Reihenfolge">Reihenfolge:</label>
					<input class="Feldeigenschaften required" id="Reihenfolge" name="Reihenfolge" type="number" value="{{Reihenfolge}}" placeholder="erforderlich"/>
				</div>
				<div id="FeldFolgtNachDiv"></div>
				<div data-role="fieldcontain">
					<label for="FeldNameEvab">Name in EvAB:</label>
					<input class="Feldeigenschaften" id="FeldNameEvab" name="FeldNameEvab" type="text" value="{{FeldNameEvab}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameZdsf">Name beim ZDSF:</label>
					<input class="Feldeigenschaften" id="FeldNameZdsf" name="FeldNameZdsf" type="text" value="{{FeldNameZdsf}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameCscf">Name beim CSCF:</label>
					<input class="Feldeigenschaften" id="FeldNameCscf" name="FeldNameCscf" type="text" value="{{FeldNameCscf}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameNism">Name beim NISM:</label>
					<input class="Feldeigenschaften" id="FeldNameNism" name="FeldNameNism" type="text" value="{{FeldNameNism}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameWslFlechten">Name bei WSL Flechten:</label>
					<input class="Feldeigenschaften" id="FeldNameWslFlechten" name="FeldNameWslFlechten" type="text" value="{{FeldNameWslFlechten}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameWslPilze">Name bei WSL Pilze:</label>
					<input class="Feldeigenschaften" id="FeldNameWslPilze" name="FeldNameWslPilze" type="text" value="{{FeldNameWslPilze}}" />
				</div>
				<div data-role="fieldcontain">
					<fieldset data-role="controlgroup">
						<legend>Feldtyp:</legend>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="textinput" value="textinput"/>
	         				<label for="textinput">einfaches Feld (textinput)</label>
	         				<input type="radio" name="Formularelement" class="Feldeigenschaften" id="textarea" value="textarea"/>
	         				<label for="textarea">einfaches Feld, wächst mit Inhalt (textarea)</label>
	         				<input type="radio" name="Formularelement" class="Feldeigenschaften" id="toggleswitch" value="toggleswitch"/>
	         				<label for="toggleswitch">ja/nein (toggleswitch)</label>
	         				<input type="radio" name="Formularelement" class="Feldeigenschaften" id="slider" value="slider"/>
	         				<label for="slider">Schieber: Zahlen von min. Wert bis max. Wert (slider)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="selectmenu" value="selectmenu"/>
	         				<label for="selectmenu">Auswahlliste geschlossen, ein Wert möglich (selectmenu)</label>
	         				<input type="radio" name="Formularelement" class="Feldeigenschaften" id="multipleselect" value="multipleselect"/>
	         				<label for="multipleselect">Auswahlliste geschlossen, mehrere Werte möglich (multipleselect)</label>
	         				<input type="radio" name="Formularelement" class="Feldeigenschaften" id="radio" value="radio"/>
	         				<label for="radio">Auswahlliste offen, ein Wert möglich (radio)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="checkbox" value="checkbox"/>
	         				<label for="checkbox">Auswahlliste offen, mehrere Werte möglich (checkbox)</label>
	         		</fieldset>
				</div>
				<div data-role="fieldcontain">
					<fieldset data-role="controlgroup">
						<legend>Datentyp eines einfachen Feldes:</legend>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="text" value="text"/>
	         				<label for="text">Text</label>
	         				<input type="radio" name="InputTyp" class="Feldeigenschaften" id="number" value="number"/>
	         				<label for="number">Zahl</label>
	         				<input type="radio" name="InputTyp" class="Feldeigenschaften" id="date" value="date"/>
	         				<label for="date">Datum</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="time" value="time"/>
	         				<label for="time">Zeit</label>
	         				<input type="radio" name="InputTyp" class="Feldeigenschaften" id="datetime" value="datetime"/>
	         				<label for="datetime">Datum und Zeit</label>
	         				<input type="radio" name="InputTyp" class="Feldeigenschaften" id="email" value="email"/>
	         				<label for="email">email</label>
	         				<input type="radio" name="InputTyp" class="Feldeigenschaften" id="url" value="url"/>
	         				<label for="url">url</label>
	         		</fieldset>
				</div>
				<div data-role="fieldcontain" id="Artgruppenliste">
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschreibung">Optionen in Auswahllisten:</label>
					<textarea class="Feldeigenschaften" id="Optionen" name="Optionen" placeholder="Werte,mit,Komma,und,ohne,Leerzeichen,trennen. Erforderlich für Auswahllisten">{{Optionen}}</textarea>
				</div>
				<div data-role="fieldcontain">
					<label for="SliderMinimum">Kleinster Wert für Schieber:</label>
					<input class="Feldeigenschaften" id="SliderMinimum" name="SliderMinimum" type="text" value="{{SliderMinimum}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="SliderMaximum">Höchster Wert für Schieber:</label>
					<input class="Feldeigenschaften" id="SliderMaximum" name="SliderMaximum" type="text" value="{{SliderMaximum}}" />
				</div>
			</form>
		</div>
		<div data-role="footer" data-position="fixed" data-tap-toggle="false" id="FeldEditFooter">
			<div data-role="navbar">
				<ul>
					<li><a href="#" onClick="Javascript:neuesFeld(User, '../');" data-icon="plus" class="ui-btn-active">neu</a></li>			
					<li><a href="#" data-role="button" id="LöschenDialogLink" data-icon="minus" forceInput="false">l&ouml;schen</a></li>
				</ul>
			</div><!-- /navbar -->
		</div><!-- /footer -->
	</div>
  </body>
</html>
