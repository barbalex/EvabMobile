<!DOCTYPE html>
<html>
  <head>
  	<link rel="SHORTCUT ICON" href="../../Bilder/favicon.ico">
  	<meta http-equiv=Content-Type content="text/html; charset=UTF-8"/>
  	<meta name="viewport" content="width=device-width, initial-scale=1"/>
  	<title>EvAB</title>
  	<link rel="stylesheet" href="../../style/jquery.mobile.css" type="text/css"/>
  	<link rel="stylesheet" href="../../style/evab.css" type="text/css"/>
  	<link rel="stylesheet" href="../../style/jquery.mobile.simpledialog.css" type="text/css"/>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.js"></script>
	<script type="text/javascript">			
		$(document).bind("mobileinit", function(){
			$.mobile.loadingMessage = 'chrampfe!'; 
			$.mobile.defaultPageTransition  = 'none';
		});
    </script>	
	<script type="text/javascript" src="../../vendor/couchapp/jquery.couch.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.couch.app.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.couch.app.util.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.mustache.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.mobile.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/phonegap.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/evab.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.mobile.simpledialog.js"></script>
    <script type="text/javascript">
		$(document).ready(function(){
			$db = $.couch.db("evab");
			
			var Pfad = "../../";
			User = "";
		
			prüfeAnmeldung(Pfad);
			
			var UserFeldDocId;
			
			//User-Felder setzen
			var viewname = 'evab/UserFeld?startkey=["' + User + '"]&endkey=["' + User + '",{}]';
			$db.view(viewname, {
				success: function(data) {
					var i;
					var key;
					var row;
					var Feld = "{{FeldName}}";
					for(i in data.rows) {
						key = data.rows[i].key;
						row = data.rows[i].value;
						if(key[1] == Feld){
							UserFeldDocId = row._id;
							$("select#SichtbarModusEinfach").val(row.SichtbarModusEinfach);
							$("select#SichtbarModusHierarchisch").val(row.SichtbarModusHierarchisch);
							$("input#Standardwert").val(row.Standardwert);
						}
					}
					$("select#SichtbarModusEinfach").slider();
					$("select#SichtbarModusEinfach").slider("refresh");
					$("select#SichtbarModusHierarchisch").slider();
					$("select#SichtbarModusHierarchisch").slider("refresh");
				}
			});
			
			//ArtGruppe managen
			ArtGruppeAufbauen();
			ArtGruppenWerte = "{{ArtGruppe}}";
			$("input[name='ArtGruppe']").checkboxradio();
			$("input[name='ArtGruppe']").attr("checked",true).checkboxradio("refresh");
			
			$("select#Tabelle").val("{{Tabelle}}");
			$("select#Tabelle").selectmenu();
			$("select#Tabelle").selectmenu("refresh");
			
			$("select#RolleModusEinfach").val("{{RolleModusEinfach}}");
			$("select#RolleModusEinfach").selectmenu();
			$("select#RolleModusEinfach").selectmenu("refresh");
			
			$("select#Formularelement").val("{{Formularelement}}");
			$("select#Formularelement").selectmenu();
			$("select#Formularelement").selectmenu("refresh");
			
			$("select#FormElementTyp").val("{{FormElementTyp}}");
			$("select#FormElementTyp").selectmenu();
			$("select#FormElementTyp").selectmenu("refresh");
			
			
			

			$("#submitButton").tap(function(event) {
				speichereFeld();
			});
			$("input[name='ArtGruppe']").change(function() {
				ArtGruppenWerte = $(this).attr("id");
				speichereFeld();
			});
			
			$("#submitUserFeldButton").tap(function(event) {
				alert("submitUserFeldButton ausgelöst");
				if (UserFeldDocId) {
					$db.openDoc(UserFeldDocId, {
						success: function(document) {
							document.Typ = "UserFeld";
							document.User = User;
							document.FeldName = "{{FeldName}}";
							document.SichtbarModusEinfach = $("select#SichtbarModusEinfach").val();
							document.SichtbarModusHierarchisch = $("select#SichtbarModusHierarchisch").val();
							document.Standardwert = $("input#Standardwert").val();
							saveUserFeld(document);
						},
						error: function() {
							melde("Fehler beim Speichern");
						}
					});
				} else {
					var document = {};
					document.Typ = "UserFeld";
					document.User = User;
					document.FeldName = "{{FeldName}}";
					document.SichtbarModusEinfach = $("select#SichtbarModusEinfach").val();
					document.SichtbarModusHierarchisch = $("select#SichtbarModusHierarchisch").val();
					document.Standardwert = $("input#Standardwert").val();
					saveUserFeld(document);
				}
			});

			//Code für den Feld-Löschen-Dialog
			$('#LöschenDialogLink').live('click', function() {
				$(this).simpledialog({
					'mode' : 'bool',
			    	'prompt' : 'Dieses Feld löschen?',
			    	'forceInput': 'false',
			    	'buttons' : {
					 	'ja': {
					      	click: function () {
					        	$('#dialogoutput').text('ja');
					        	löscheFeld();
			        		},
			        		icon: "delete",
			        		theme: "c"
			      		},
			      		'nein': {
			        		click: function () {
			          			$('#dialogoutput').text('nein');
			        		}
			      		}
			    	}
			  	})
			});

			//UserId ermitteln, um Link zum UserEdit im Menü zu setzen
			UserId = holeUserId(User);

			//Menu aufbauen
			$("[name='Menu']").live('click', function(){
				erstelleMenuFürFelder(this, "../../");
			});
		});
	</script>
	<script type="text/javascript">
		function speichereFeld() {
			var docId = "{{id}}";
				$db.openDoc(docId, {
					success: function(document) {
						document.Typ = "Feld";
						document.User = User;
						document.Tabelle = $("select#Tabelle").val();
						document.FeldName = $("input#FeldName").val();
						document.FeldBeschriftung = $("input#FeldBeschriftung").val();
						document.FeldBeschreibung = $("[id$='FeldBeschreibung']").val();						
						document.Reihenfolge = parseInt($("input#Reihenfolge").val());
						document.FeldNameEvab = $("input#FeldNameEvab").val();
						document.FeldNameZdsf = $("input#FeldNameZdsf").val();
						document.FeldNameCscf = $("input#FeldNameCscf").val();
						document.RolleModusEinfach = $("select#RolleModusEinfach").val();
						document.Formularelement = $("select#Formularelement").val();
						document.FormElementTyp = $("select#FormElementTyp").val();
						document.ArtGruppe = ArtGruppenWerte;
						saveDocument(document);
					},
					error: function() {
						melde("Fehler: Feld nicht gespeichert");
					}
				});
		}

		function saveDocument(document) {
			$db.saveDoc(document, {
				success: function() {
					melde("Feld gespeichert");
				},
				error: function() {
					melde("Fehler: Feld nicht gespeichert");
				}
			});
		}
		
		function saveUserFeld(document) {
			$db.saveDoc(document, {
				success: function() {
					melde("Einstellungen gespeichert");
				},
				error: function() {
					melde("Fehler: Einstellungen nicht gespeichert");
				}
			});
		}
		
		function ArtGruppeAufbauen() {
			$("select#ArtGruppe").empty();
			var viewname = "evab/Artgruppen";
			$db.view(viewname, {
				success: function(data) {
					var i;
					var ArtGruppe;
					var ArtGruppenWerte = [];
					ArtGruppenWerte = '{{ArtGruppe}}';
					var ListItemContainer = "<fieldset data-role='controlgroup'>\n\t<legend>Artgruppen:</legend>";
					var listItem;
					for(i in data.rows) {
						ArtGruppe = data.rows[i].key;
						listItem = "<input type='checkbox' name='ArtGruppe' id='";
						listItem += ArtGruppe;
						listItem += "' class='custom'";
						if(ArtGruppe.indexOf(ArtGruppenWerte)>=0){
							listItem += " checked='checked'";
						}
						listItem += "/>\n<label for='";
						listItem += ArtGruppe;
						listItem += "'>";
						listItem += ArtGruppe;
						listItem += "</label>";
						ListItemContainer += listItem;
					}
					ListItemContainer += "\n</fieldset>"
					$("#Artgruppenliste").html(ListItemContainer).trigger("create").trigger("refresh");
				}
			});
			
		}

		function löscheFeld(event) {
			var docId = "{{id}}";
			// First open doc based on ID in order to get full document
			$db.openDoc(docId, {
				success: function(document) {
					// Then use the opened doc as reference to remove
					$db.removeDoc(document, {
						success: function() {
							window.open(Pfad + "FeldListe.html", target = '_self');
						},
						error: function() {
							melde("Fehler: Löschen gescheitert");
						}
					});
				},
				error: function() {
					melde("Fehler: Löschen gescheitert");
				}
			});
			return false;
		}

	function prüfeAnmeldung(Pfad) {		
		//User Anmeldung überprüfen
		//Wenn angemeldet, globale Variable User aktualisieren
		//Wenn nicht angemeldet, Anmeldedialog öffnen
		$.ajax({
		    url: '/_session?callback=',
		    dataType: 'json',
		    async: false,
		    success: function(session){
		    	if(User != undefined || null) {
		        	User = session.userCtx.name;
		        } else {
					window.open(Pfad + "index.html", target="_self");
				}
		    }
		});
	}
	</script>
  </head>
  <body>
  	<div data-role="page" id="FeldEditPage">
  		<div data-role="header" data-position="fixed">
  			<a href="../../FeldListe.html" data-role="button" data-icon="arrow-l" data-rel="back" rel="external" data-iconpos="notext">abbrechen</a>
  			<h2>Datenfelder</h2>
  			<a href='#' id='Menu' name='Menu' data-role='button' data-icon="gear" data-iconpos="notext" class="r ui-btn-right">Menu</a>
  		</div>
		<div id="FeldContent" data-role="content" data-theme="c" style="padding:0em;">
			<form id="UserFeldForm" action="#" method="get" autocomplete="off">
				<h2>meine Einstellungen</h2>
				<div data-role="fieldcontain">
					<label for="SichtbarModusEinfach">Sichtbar im einfachen Modus?</label>
					<select name="SichtbarModusEinfach" id="SichtbarModusEinfach" data-role="slider">
						<option value="nein">nein</option>
						<option value="ja">ja</option>
					</select> 
				</div>
				<div data-role="fieldcontain">
					<label for="SichtbarModusHierarchisch">Sichtbar im hierarchischen Modus?</label>
					<select name="SichtbarModusHierarchisch" id="SichtbarModusHierarchisch" data-role="slider">
						<option value="nein">nein</option>
						<option value="ja">ja</option>
					</select> 
				</div>
				<div data-role="fieldcontain">
					<label for="Standardwert">Standardwert:</label>
					<input id="Standardwert" name="Standardwert" type="text" />
				</div>
				<a href="#" data-role="button" data-icon="check" id="submitUserFeldButton">speichern</a>
			</form>
				<hr>
				<h2>Feldeigenschaften</h2>
			<form id="FeldEditForm" action="#" method="get" data-identity="{{document}}" >
				<div data-role="fieldcontain">
					<label for="Tabelle" class="select">Tabelle:</label>
					<select id="Tabelle" name="Tabelle">
						<option value="Art">Art</option>
						<option value="Zeit">Zeit</option>
						<option value="Ort">Ort</option>
						<option value="Raum">Raum</option>
						<option value="Projekt">Projekt</option>
					</select>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldName">Feld-Name:</label>
					<input id="FeldName" name="FeldName" type="text" value="{{FeldName}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschriftung">Beschriftung:</label>
					<input id="FeldBeschriftung" name="FeldBeschriftung" type="text" value="{{FeldBeschriftung}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschreibung">Beschreibung:</label>
					<textarea id="FeldBeschreibung" name="FeldBeschreibung">{{FeldBeschreibung}}</textarea>
				</div>
				<div data-role="fieldcontain">
					<label for="Reihenfolge">Reihenfolge:</label>
					<input id="Reihenfolge" name="Reihenfolge" type="number" value="{{Reihenfolge}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameEvab">Feldname in EvAB:</label>
					<input id="FeldNameEvab" name="FeldNameEvab" type="text" value="{{FeldNameEvab}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameZdsf">Feldname beim ZDSF:</label>
					<input id="FeldNameZdsf" name="FeldNameZdsf" type="text" value="{{FeldNameZdsf}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameCscf">Feldname beim CSCF:</label>
					<input id="FeldNameCscf" name="FeldNameCscf" type="text" value="{{FeldNameCscf}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="RolleModusEinfach" class="select">Rolle im Modus "einfach":</label>
					<select id="RolleModusEinfach" name="RolleModusEinfach" value="{{RolleModusEinfach}}" data-native-menu="true">
						<option value="EingabeErforderlich">EingabeErforderlich</option>
						<option value="EingabeMöglich">EingabeMöglich</option>
						<option value="EingabeNichtVorgesehen">EingabeNichtVorgesehen</option>
					</select>
				</div>
				<div data-role="fieldcontain">
					<label for="Formularelement" class="select">Formularelement:</label>
					<select id="Formularelement" name="Formularelement" value="{{Formularelement}}" data-native-menu="true">
						<option value="textinput">textinput</option>
						<option value="textarea">textarea</option>
						<option value="toggleswitch">toggleswitch</option>
						<option value="toggleswitch">checkbox</option>
						<option value="selectmenu">selectmenu</option>
						<option value="multipleselect">slider</option>
						<option value="multipleselect">radio</option>
					</select>
				</div>
				<div data-role="fieldcontain">
					<label for="FormElementTyp" class="select">Formularelement-Typ:</label>
					<select id="FormElementTyp" name="FormElementTyp" value="{{FormElementTyp}}" data-native-menu="true">
						<optio value=""></option>
						<option value="text">text</option>
						<option value="date">date</option>
					</select>
				</div>
				<div data-role="fieldcontain" id="Artgruppenliste">
				</div>
				<button type="submit" id="submitButton" data-icon="check" data-theme="b">speichern</button>
				<a href="#" data-role="button" id="LöschenDialogLink" data-icon="minus" forceInput="false">l&ouml;schen</a>
			</form>
		</div>
	</div>
  </body>
</html>
