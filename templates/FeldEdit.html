<!DOCTYPE html>
<html>
  <head>
  	<link rel="SHORTCUT ICON" href="../../Bilder/favicon.ico">
  	<meta http-equiv=Content-Type content="text/html; charset=UTF-8"/>
  	<meta name="viewport" content="width=device-width, initial-scale=1"/>
  	<title>EvAB</title>
  	<link rel="stylesheet" href="../../style/main.css" type="text/css">
  	<link rel="stylesheet" href="../../style/jquery.mobile.css" type="text/css"/>
  	<link rel="stylesheet" href="../../style/evab.css" type="text/css"/>
  	<link rel="stylesheet" href="../../style/jquery.mobile.simpledialog.css" type="text/css"/>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.couch.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.couch.app.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.couch.app.util.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.mustache.js"></script>
	<script type="text/javascript">
	//customize jQuery Mobile to let IE7+ in (Mobile IE)
	//run this script after jQuery loads, but before jQuery Mobile loads				
		$(document).bind("mobileinit", function(){
			$.extend(  $.mobile , {	
			//extend gradeA qualifier to include IE7+
				gradeA: function(){    	
			    	//IE version check by James Padolsey, modified by jdalton - from http://gist.github.com/527683
					var ie = (function() {
					    var v = 3, div = document.createElement('div'), a = div.all || [];
					    while (div.innerHTML = '<!--[if gt IE '+(++v)+']><br><![endif]-->', a[0]); 
					    return v > 4 ? v : !v;
					}());
			    	
			    	//must either support media queries or be IE7+
			    	return $.support.mediaquery || (ie && ie >= 7);
			    }
			});
		});
	</script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.mobile.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/phonegap.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/evab.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.mobile.simpledialog.js"></script>
    <script type="text/javascript">
		$(document).ready(function(){
			$db = $.couch.db("evab-ch_barbalex_evab");
			userCtx = null;
			$.couch.session({
			success : function(r) {
				var userCtx = r.userCtx;
				User = userCtx.name;
				}
			});
			
			var UserFeldDocId;
			
			//User-Felder setzen
			var viewname = "evab/UserFeld";
			$db.view(viewname, {
				success: function(data) {
					var i;
					var Feld = "{{FeldName}}";
					var UserFeld = User + Feld;
					var UserFeldVonView;
					for(i in data.rows)
					{
						UserFeldVonView = data.rows[i].key;
						var row = data.rows[i].value;
						if(UserFeldVonView == UserFeld){
							UserFeldDocId = row._id;
							$("select#SichtbarModusEinfach").val(row.SichtbarModusEinfach);
							$("select#SichtbarModusHierarchisch").val(row.SichtbarModusHierarchisch);
							$("input#Standardwert").val(row.Standardwert);
						}
					}
					$("select#SichtbarModusEinfach").slider();
					$("select#SichtbarModusEinfach").slider("refresh");
					$("select#SichtbarModusHierarchisch").slider();
					$("select#SichtbarModusHierarchisch").slider("refresh");
				}
			});
			
			ArtGruppeAufbauen();
			$("select#ArtGruppe").val('{{ArtGruppe}}');
			$("select#ArtGruppe").selectmenu();
			$("select#ArtGruppe").selectmenu("refresh");
			
			$("select#Tabelle").val("{{Tabelle}}");
			$("select#Tabelle").selectmenu();
			$("select#Tabelle").selectmenu("refresh");
			
			$("select#RolleModusEinfach").val("{{RolleModusEinfach}}");
			$("select#RolleModusEinfach").selectmenu();
			$("select#RolleModusEinfach").selectmenu("refresh");
			
			$("select#Formularelement").val("{{Formularelement}}");
			$("select#Formularelement").selectmenu();
			$("select#Formularelement").selectmenu("refresh");
			
			$("select#FormElementTyp").val("{{FormElementTyp}}");
			$("select#FormElementTyp").selectmenu();
			$("select#FormElementTyp").selectmenu("refresh");
			
			var docId = "{{id}}";
			$("#submitButton").tap(function(event) {
				var docId = "{{id}}";
				$db.openDoc(docId, {
					success: function(document) {
						document.Typ = "Feld";
						document.User = User;
						document.Tabelle = $("select#Tabelle").val();
						document.FeldName = $("input#FeldName").val();
						document.FeldBeschriftung = $("input#FeldBeschriftung").val();
						document.FeldBeschreibung = $("[id$='FeldBeschreibung']").val();						
						document.Reihenfolge = parseInt($("input#Reihenfolge").val());
						document.FeldNameEvab = $("input#FeldNameEvab").val();
						document.FeldNameZdsf = $("input#FeldNameZdsf").val();
						document.FeldNameCscf = $("input#FeldNameCscf").val();
						document.RolleModusEinfach = $("select#RolleModusEinfach").val();
						document.Formularelement = $("select#Formularelement").val();
						document.FormElementTyp = $("select#FormElementTyp").val();
						document.ArtGruppe = $("select#ArtGruppe").val();
						saveDocument(document);
					},
					error: function() {
						MeldungEinzeilig("Dieses Dokument kann nicht geöffnet werden: " + docId);
					}
				});
			});
			
			$("#submitUserFeldButton").tap(function(event) {
				alert("submitUserFeldButton ausgelöst");
				if (UserFeldDocId) {
					$db.openDoc(UserFeldDocId, {
						success: function(document) {
							document.Typ = "UserFeld";
							document.User = User;
							document.FeldName = "{{FeldName}}";
							document.SichtbarModusEinfach = $("select#SichtbarModusEinfach").val();
							document.SichtbarModusHierarchisch = $("select#SichtbarModusHierarchisch").val();
							document.Standardwert = $("input#Standardwert").val();
							saveUserFeld(document);
						},
						error: function() {
							MeldungEinzeilig("Fehler beim Speichern");
						}
					});
				} else {
					var document = {};
					document.Typ = "UserFeld";
					document.User = User;
					document.FeldName = "{{FeldName}}";
					document.SichtbarModusEinfach = $("select#SichtbarModusEinfach").val();
					document.SichtbarModusHierarchisch = $("select#SichtbarModusHierarchisch").val();
					document.Standardwert = $("input#Standardwert").val();
					saveUserFeld(document);
				}
			});

			//Code für den Art-Löschen-Dialog
		$('#LöschenDialogLink').live('click', function() {
			$(this).simpledialog({
				'mode' : 'bool',
		    	'prompt' : 'Dieses Feld löschen?',
		    	'forceInput': 'false',
		    	'buttons' : {
				 	'ja': {
				      	click: function () {
				        	$('#dialogoutput').text('ja');
				        	handleDelete();
		        		},
		        		icon: "delete",
		        		theme: "c"
		      		},
		      		'nein': {
		        		click: function () {
		          			$('#dialogoutput').text('nein');
		        		}
		      		}
		    	}
		  	})
		});

			//UserId ermitteln, um Link zum UserEdit im Menü zu setzen
			var UserId;
			$db.view("evab/User",
				{success: function(data) {
					var i;
					var doc;
					for(i in data.rows) {
						key = data.rows[i].key;
						doc = data.rows[i].value;
						if (key == User) {
							UserId = doc._id;
						}
					}
				}
			});

			//Menu aufbauen
			$("[name='Menu']").live('click', function(){
				MenuAufbauenAusArtListe(this, User, UserId, "../../");
			});

			//transitions ausschalten, weil das auf Android nativ miserabel funktioniert
			$(document).bind("mobileinit", function(){
				defaultDialogTransition = none;
			});
		});
	</script>
	<script type="text/javascript">
		function saveDocument(document)
		{
			$db.saveDoc(document, {
				success: function() {
					MeldungEinzeilig("gespeichert");
				},
				error: function() {
					MeldungEinzeilig("Diese Beobachtung kann nicht gespeichert werden: " + document._id + ", " + document.bArtName);
				}
			});
		}
		
		function saveUserFeld(document)
		{
			$db.saveDoc(document, {
				success: function() {
					MeldungEinzeilig("gespeichert");
				},
				error: function() {
					MeldungEinzeilig("Speichern misslungen");
				}
			});
		}
		
		function ArtGruppeAufbauen()
		{
			$("select#ArtGruppe").empty();
			var viewname = "evab/Artgruppen";
			$db.view(viewname, {
				success: function( data ) {
					var i;
					var ArtGruppe;
					var ArtGruppenWerte;
					ArtGruppenWerte = '{{ArtGruppe}}';
					var listItem;
					var ListItemContainer = "<option value=''>Artgruppen w&auml;hlen</option>";
					for(i in data.rows)
					{
						ArtGruppe = data.rows[i].key;
						if(ArtGruppenWerte.indexOf(ArtGruppe)!=-1){      //Was passiert, wenn ArtGruppenWerte nicht existiert?
							listItem = "<option value='" + ArtGruppe + "' selected='selected'>" + ArtGruppe + "</option>";
						} else {
							listItem = "<option value='" + ArtGruppe + "'>" + ArtGruppe + "</option>";
						}
						ListItemContainer = ListItemContainer + listItem;
					}
					$("select#ArtGruppe").append(ListItemContainer);
					$("select#ArtGruppe").val('{{ArtGruppe}}');
					$("select#ArtGruppe").selectmenu();
					$("select#ArtGruppe").selectmenu("refresh");
				}
			});
			
		}

		function handleDelete(event)
		{
			var docId = "{{id}}";
			// First open doc based on ID in order to get full document
			$db.openDoc(docId, {
				success: function(document) {
					// Then use the opened doc as reference to remove
					$db.removeDoc(document, {
						success: function() {
							window.open("../../../../../evab-ch_barbalex_evab/_design/evab/FeldListe.html", target = '_self');
						},
						error: function() {
							MeldungEinzeilig("Das Feld mit der ID: " + docId + " konnte nicht gelöscht werden");
						}
					});
				},
				error: function() {
					MeldungEinzeilig("Ein Feld mit der ID: " + docId + " wurde nicht gefunden");
				}
			});
			return false;
		}
	</script>
  </head>
  <body>
  	<div data-role="page" id="FeldEditPage">
  		<div data-role="header" data-position="fixed">
  			<a href="../../FeldListe.html" data-role="button" data-icon="arrow-l" data-rel="back" rel="external" data-iconpos="notext">abbrechen</a>
  			<h2>Datenfelder</h2>
  			<a href='#' id='Menu' name='Menu' data-role='button' data-icon="gear" data-iconpos="notext" class="r ui-btn-right">Menu</a>
  		</div>
		<div id="FeldContent" data-role="content" data-theme="c" style="padding:0em;">
			<form id="UserFeldForm" action="#" method="get" autocomplete="off">
				<h2>meine Einstellungen</h2>
				<div data-role="fieldcontain">
					<label for="SichtbarModusEinfach">Sichtbar im einfachen Modus?</label>
					<select name="SichtbarModusEinfach" id="SichtbarModusEinfach" data-role="slider">
						<option value="nein">nein</option>
						<option value="ja">ja</option>
					</select> 
				</div>
				<div data-role="fieldcontain">
					<label for="SichtbarModusHierarchisch">Sichtbar im hierarchischen Modus?</label>
					<select name="SichtbarModusHierarchisch" id="SichtbarModusHierarchisch" data-role="slider">
						<option value="nein">nein</option>
						<option value="ja">ja</option>
					</select> 
				</div>
				<div data-role="fieldcontain">
					<label for="Standardwert">Standardwert:</label>
					<input id="Standardwert" name="Standardwert" type="text" />
				</div>
				<a href="#" data-role="button" data-icon="check" id="submitUserFeldButton">speichern</a>
			</form>
				<hr>
				<h2>Feldeigenschaften</h2>
			<form id="FeldEditForm" action="#" method="get" data-identity="{{document}}" >
				<div data-role="fieldcontain">
					<label for="Tabelle" class="select">Tabelle:</label>
					<select id="Tabelle" name="Tabelle" value="{{Tabelle}}" data-native-menu="true">
						<option value="Art">Art</option>
						<option value="Zeit">Zeit</option>
						<option value="Ort">Ort</option>
						<option value="Raum">Raum</option>
						<option value="Projekt">Projekt</option>
					</select>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldName">Feld-Name:</label>
					<input id="FeldName" name="FeldName" type="text" value="{{FeldName}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschriftung">Beschriftung:</label>
					<input id="FeldBeschriftung" name="FeldBeschriftung" type="text" value="{{FeldBeschriftung}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschreibung">Beschreibung:</label>
					<textarea id="FeldBeschreibung" name="FeldBeschreibung">{{FeldBeschreibung}}</textarea>
				</div>
				<div data-role="fieldcontain">
					<label for="Reihenfolge">Reihenfolge:</label>
					<input id="Reihenfolge" name="Reihenfolge" type="number" value="{{Reihenfolge}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameEvab">Feldname in EvAB:</label>
					<input id="FeldNameEvab" name="FeldNameEvab" type="text" value="{{FeldNameEvab}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameZdsf">Feldname beim ZDSF:</label>
					<input id="FeldNameZdsf" name="FeldNameZdsf" type="text" value="{{FeldNameZdsf}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameCscf">Feldname beim CSCF:</label>
					<input id="FeldNameCscf" name="FeldNameCscf" type="text" value="{{FeldNameCscf}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="RolleModusEinfach" class="select">Rolle im Modus "einfach":</label>
					<select id="RolleModusEinfach" name="RolleModusEinfach" value="{{RolleModusEinfach}}" data-native-menu="true">
						<option value="EingabeErforderlich">EingabeErforderlich</option>
						<option value="EingabeMöglich">EingabeMöglich</option>
						<option value="EingabeNichtVorgesehen">EingabeNichtVorgesehen</option>
					</select>
				</div>
				<div data-role="fieldcontain">
					<label for="Formularelement" class="select">Formularelement:</label>
					<select id="Formularelement" name="Formularelement" value="{{Formularelement}}" data-native-menu="true">
						<option value="textinput">textinput</option>
						<option value="textarea">textarea</option>
						<option value="toggleswitch">toggleswitch</option>
						<option value="selectmenu">selectmenu</option>
						<option value="multipleselect">multipleselect</option>
					</select>
				</div>
				<div data-role="fieldcontain">
					<label for="FormElementTyp" class="select">Formularelement-Typ:</label>
					<select id="FormElementTyp" name="FormElementTyp" value="{{FormElementTyp}}" data-native-menu="true">
						<optio value=""></option>
						<option value="text">text</option>
						<option value="date">date</option>
					</select>
				</div>
				<div data-role="fieldcontain">
					<label for="ArtGruppe" class="select">Art-Gruppen:</label>
					<select id="ArtGruppe" name="ArtGruppe" value='{{ArtGruppe}}' multiple="multiple" data-native-menu="true">
					</select>
				</div>
				<button type="submit" id="submitButton" data-icon="check" data-theme="b">speichern</button>
				<li><a href="#" id="LöschenDialogLink" data-role="button" data-icon="minus" forceInput="false">l&ouml;schen</a></li>
			</form>
		</div>
	</div>
  </body>
</html>
