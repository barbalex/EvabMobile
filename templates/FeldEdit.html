<!DOCTYPE html>
<html>
  <head>
  	<link rel="SHORTCUT ICON" href="../../Bilder/favicon.ico">
  	<meta http-equiv=Content-Type content="text/html; charset=UTF-8"/>
  	<meta name="viewport" content="width=device-width, initial-scale=1"/>
  	<title>EvAB</title>
  	<link rel="stylesheet" href="../../style/jquery.mobile.css" type="text/css"/>
  	<link rel="stylesheet" href="../../style/jquery.mobile.datebox.css" type="text/css"/>
  	<link rel="stylesheet" href="../../style/jquery.mobile.simpledialog.css" type="text/css"/>
  	<link rel="stylesheet" href="../../style/evab.css" type="text/css"/>
  	<style type="text/css">.ui-icon-evab-location {background-image:url('../../Bilder/evab-location.png');}</style>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.js"></script>
	<script type="text/javascript">			
		$(document).on("mobileinit", function () {
			$.mobile.page.prototype.options.degradeInputs.date = 'text';
			$.mobile.page.prototype.options.degradeInputs.time = 'text';
			$.mobile.selectmenu.prototype.options.nativeMenu = false;
			$.event.special.swipe.horizontalDistanceThreshold = 250;
			$.mobile.buttonMarkup.hoverDelay = 0;
		});
    </script>	
	<script type="text/javascript" src="../../vendor/couchapp/jquery.couch.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.couch.app.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.form.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.mustache.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.mobile.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/phonegap.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/evab.js"></script>
	<script type="text/javascript" src="../../vendor/couchapp/jquery.mobile.simpledialog.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" src="../../vendor/couchapp/markerclusterer.js"></script>
  	<script type="text/javascript" src="../../vendor/couchapp/markerwithlabel.js"></script>
  </head>
  <body>
  	<div data-role="page" id="FeldEditPage">
  		<div data-role="header" data-position="fixed" data-tap-toggle="false" id="FeldEditHeader">
  			<a href="#" id="BackButton" data-role="button" data-icon="arrow-l" data-iconpos="notext">abbrechen</a>
  			<h2 class="FeldEditHeaderTitel">Datenfelder</h2>
  			<a href='#' id='MenuFeldEdit' data-role='button' data-icon="wrench" data-iconpos="notext" class="r ui-btn-right">Menu</a>
  		</div>
		<div id="FeldContent" data-role="content" style="padding:0em;">
			<form id="UserFeldForm" action="#" method="get" autocomplete="off">
				<h2>meine Einstellungen</h2>
				<div data-role="fieldcontain">
					<label for="SichtbarImModusEinfach">Sichtbar im einfachen Modus?</label>
					<select name="SichtbarImModusEinfach" id="SichtbarImModusEinfach" data-role="slider">
						<option value="nein">nein</option>
						<option value="ja">ja</option>
					</select> 
				</div>
				<div data-role="fieldcontain">
					<label for="SichtbarImModusHierarchisch">Sichtbar im hierarchischen Modus?</label>
					<select name="SichtbarImModusHierarchisch" id="SichtbarImModusHierarchisch" data-role="slider">
						<option value="nein">nein</option>
						<option value="ja">ja</option>
					</select> 
				</div>
				<div data-role="fieldcontain">
					<label for="Standardwert">Standardwert:</label>
					<input id="Standardwert" name="Standardwert" type="text"  placeholder="dieser Wert wird bei neuen Beobachtungen in diesem Feld eingefügt"/>
				</div>
			</form>
				<hr>
				<h2>Feldeigenschaften</h2>
			<form id="FeldEditForm" action="#" method="get" data-identity="{{document}}">
				<div data-role="fieldcontain">
					<fieldset data-role="controlgroup">
						<legend>Hierarchiestufe (erforderlich):</legend>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Projekt" value="Projekt"/>
	         				<label for="Projekt">Projekt</label>
	         				<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Raum" value="Raum"/>
	         				<label for="Raum">Raum</label>
	         				<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Ort" value="Ort"/>
	         				<label for="Ort">Ort</label>
	         				<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Zeit" value="Zeit"/>
	         				<label for="Zeit">Zeit</label>
							<input type="radio" name="Hierarchiestufe" class="Feldeigenschaften" id="Art" value="Art"/>
	         				<label for="Art">Art</label>
	         		</fieldset>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldName">Name:</label>
					<input class="Feldeigenschaften required" id="FeldName" name="FeldName" type="text" value="{{FeldName}}" placeholder="erforderlich"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschriftung">Beschriftung:</label>
					<input class="Feldeigenschaften required" id="FeldBeschriftung" name="FeldBeschriftung" type="text" value="{{FeldBeschriftung}}" placeholder="erforderlich"/>
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschreibung">Beschreibung:</label>
					<textarea class="Feldeigenschaften" id="FeldBeschreibung" name="FeldBeschreibung">{{FeldBeschreibung}}</textarea>
				</div>
				<div data-role="fieldcontain">
					<label for="Reihenfolge">Reihenfolge:</label>
					<input class="Feldeigenschaften required" id="Reihenfolge" name="Reihenfolge" type="number" value="{{Reihenfolge}}" placeholder="erforderlich"/>
				</div>
				<div id="FeldFolgtNachDiv"></div>
				<div data-role="fieldcontain">
					<label for="FeldNameEvab">Name in EvAB:</label>
					<input class="Feldeigenschaften" id="FeldNameEvab" name="FeldNameEvab" type="text" value="{{FeldNameEvab}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameZdsf">Name beim ZDSF:</label>
					<input class="Feldeigenschaften" id="FeldNameZdsf" name="FeldNameZdsf" type="text" value="{{FeldNameZdsf}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameCscf">Name beim CSCF:</label>
					<input class="Feldeigenschaften" id="FeldNameCscf" name="FeldNameCscf" type="text" value="{{FeldNameCscf}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameNism">Name beim NISM:</label>
					<input class="Feldeigenschaften" id="FeldNameNism" name="FeldNameNism" type="text" value="{{FeldNameNism}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameWslFlechten">Name bei WSL Flechten:</label>
					<input class="Feldeigenschaften" id="FeldNameWslFlechten" name="FeldNameWslFlechten" type="text" value="{{FeldNameWslFlechten}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="FeldNameWslPilze">Name bei WSL Pilze:</label>
					<input class="Feldeigenschaften" id="FeldNameWslPilze" name="FeldNameWslPilze" type="text" value="{{FeldNameWslPilze}}" />
				</div>
				<div data-role="fieldcontain">
					<fieldset data-role="controlgroup">
						<legend>Feldtyp:</legend>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="textinput" value="textinput"/>
	         				<label for="textinput">einfaches Feld (textinput)</label>
	         				<input type="radio" name="Formularelement" class="Feldeigenschaften" id="textarea" value="textarea"/>
	         				<label for="textarea">einfaches Feld, wächst mit Inhalt (textarea)</label>
	         				<input type="radio" name="Formularelement" class="Feldeigenschaften" id="toggleswitch" value="toggleswitch"/>
	         				<label for="toggleswitch">ja/nein (toggleswitch)</label>
	         				<input type="radio" name="Formularelement" class="Feldeigenschaften" id="slider" value="slider"/>
	         				<label for="slider">Schieber: Zahlen von min. Wert bis max. Wert (slider)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="selectmenu" value="selectmenu"/>
	         				<label for="selectmenu">Auswahlliste geschlossen, ein Wert möglich (selectmenu)</label>
	         				<input type="radio" name="Formularelement" class="Feldeigenschaften" id="multipleselect" value="multipleselect"/>
	         				<label for="multipleselect">Auswahlliste geschlossen, mehrere Werte möglich (multipleselect)</label>
	         				<input type="radio" name="Formularelement" class="Feldeigenschaften" id="radio" value="radio"/>
	         				<label for="radio">Auswahlliste offen, ein Wert möglich (radio)</label>
							<input type="radio" name="Formularelement" class="Feldeigenschaften" id="checkbox" value="checkbox"/>
	         				<label for="checkbox">Auswahlliste offen, mehrere Werte möglich (checkbox)</label>
	         		</fieldset>
				</div>
				<div data-role="fieldcontain">
					<fieldset data-role="controlgroup">
						<legend>Datentyp eines einfachen Feldes:</legend>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="text" value="text"/>
	         				<label for="text">Text</label>
	         				<input type="radio" name="InputTyp" class="Feldeigenschaften" id="number" value="number"/>
	         				<label for="number">Zahl</label>
	         				<input type="radio" name="InputTyp" class="Feldeigenschaften" id="date" value="date"/>
	         				<label for="date">Datum</label>
							<input type="radio" name="InputTyp" class="Feldeigenschaften" id="time" value="time"/>
	         				<label for="time">Zeit</label>
	         				<input type="radio" name="InputTyp" class="Feldeigenschaften" id="datetime" value="datetime"/>
	         				<label for="datetime">Datum und Zeit</label>
	         				<input type="radio" name="InputTyp" class="Feldeigenschaften" id="email" value="email"/>
	         				<label for="email">email</label>
	         				<input type="radio" name="InputTyp" class="Feldeigenschaften" id="url" value="url"/>
	         				<label for="url">url</label>
	         		</fieldset>
				</div>
				<div data-role="fieldcontain" id="Artgruppenliste">
				</div>
				<div data-role="fieldcontain">
					<label for="FeldBeschreibung">Optionen in Auswahllisten:</label>
					<textarea class="Feldeigenschaften" id="Optionen" name="Optionen" placeholder="Werte,mit,Komma,und,ohne,Leerzeichen,trennen. Erforderlich für Auswahllisten">{{Optionen}}</textarea>
				</div>
				<div data-role="fieldcontain">
					<label for="SliderMinimum">Kleinster Wert für Schieber:</label>
					<input class="Feldeigenschaften" id="SliderMinimum" name="SliderMinimum" type="text" value="{{SliderMinimum}}" />
				</div>
				<div data-role="fieldcontain">
					<label for="SliderMaximum">Höchster Wert für Schieber:</label>
					<input class="Feldeigenschaften" id="SliderMaximum" name="SliderMaximum" type="text" value="{{SliderMaximum}}" />
				</div>
			</form>
		</div>
		<div data-role="footer" data-position="fixed" data-tap-toggle="false" id="FeldEditFooter">
			<div data-role="navbar">
				<ul>
					<li><a href="#" onClick="Javascript:neuesFeld('../');" data-icon="plus" class="ui-btn-active">neu</a></li>			
					<li><a href="#" data-role="button" id="LöschenDialogLink" data-icon="minus" forceInput="false">l&ouml;schen</a></li>
				</ul>
			</div><!-- /navbar -->
		</div><!-- /footer -->
		<script type="text/javascript">
			//Code, der bei Verwendung von ajax bei jedem Aufruf laufen soll (swipen)
			$("#FeldEditPage").on("pageshow", function () {

				speichereLetzteUrl();
				
				//Sichtbarkeit in Modi Hierarchisch und einfach setzen
				//Artgruppe Aufbauen, wenn Hierarchiestufe == Art
				//und allfälligen Standardwert anzeigen
				//in einer Funktion zusammengefasst, weil dasselbe Dokument abgefragt werden muss
				setzeSichtbarInModiUndArtgruppeUndStandardwert();

				if ("{{FeldName}}") {
					//fix in Formulare eingebaute Felder: Standardwerte ausblenden und erklären
					if (["aArtGruppe", "aArtName"].indexOf("{{FeldName}}") > -1) {
						$("#Standardwert").attr("placeholder", "Keine Voreinstellung möglich");
						$("#Standardwert").attr("disabled", true);
					} else if ("{{FeldName}}" === "aAutor") {
						$("#Standardwert").attr("placeholder", 'Bitte im Menü "meine Einstellungen" voreinstellen');
						$("#Standardwert").attr("disabled", true);
					} else if (["oXKoord", "oYKoord", "oLatitudeDecDeg", "oLongitudeDecDeg", "oLagegenauigkeit"].indexOf("{{FeldName}}") > -1) {
						$("#Standardwert").attr("placeholder", 'Lokalisierung erfolgt automatisch, keine Voreinstellung möglich');
						$("#Standardwert").attr("disabled", true);
					} else if (["zDatum", "zUhrzeit"].indexOf("{{FeldName}}") > -1) {
						$("#Standardwert").attr("placeholder", 'Standardwert ist "jetzt", keine Voreinstellung möglich');
						$("#Standardwert").attr("disabled", true);
					}
				}
				$(".FeldEditHeaderTitel").text("{{Hierarchiestufe}}" + ": " + "{{FeldBeschriftung}}");
				
				//Radio Felder initiieren (ausser ArtGruppe, das wird dynamisch erzeugt)
				$("input[name='Hierarchiestufe']").checkboxradio();
				$("#{{Hierarchiestufe}}").prop("checked",true).checkboxradio("refresh");
				$("input[name='Formularelement']").checkboxradio();
				$("#{{Formularelement}}").prop("checked",true).checkboxradio("refresh");
				$("input[name='InputTyp']").checkboxradio();
				$("#{{InputTyp}}").prop("checked",true).checkboxradio("refresh");

				function setzeSichtbarInModiUndArtgruppeUndStandardwert() {
					if (!localStorage.Username) {
						pruefeAnmeldung();
					}
					//wenn mit den von Mustache übergebenen Arrays vernünftig gearbeitet werden könnte,
					//könnte man sich diese Abfrage ersparen!
					//in einer Funktion zusammengefasst, weil dasselbe Dokument abgefragt werden muss
					$db = $.couch.db("evab");
					$db.openDoc("{{id}}", {
						success: function (Feld) {
							var SichtbarImModusHierarchisch, SichtbarImModusEinfach, Standardwert;
							//korrekte Werte in Felder SichtbarImModusEinfach und -Hierarchisch setzen
							SichtbarImModusHierarchisch = Feld.SichtbarImModusHierarchisch;
							SichtbarImModusEinfach = Feld.SichtbarImModusEinfach;
							//Vorsicht: Bei neuen Feldern gibt es Feld.SichtbarImModusHierarchisch noch nicht
							if (SichtbarImModusHierarchisch && SichtbarImModusHierarchisch.indexOf(localStorage.Username) !== -1) {
								$("select#SichtbarImModusHierarchisch").val("ja");
							} else {
								$("select#SichtbarImModusHierarchisch").val("nein");
							}
							$("select#SichtbarImModusHierarchisch").slider();
							$("select#SichtbarImModusHierarchisch").slider("refresh");
							//Vorsicht: Bei neuen Feldern gibt es Feld.SichtbarImModusEinfach noch nicht
							if (SichtbarImModusEinfach && SichtbarImModusEinfach.indexOf(localStorage.Username) !== -1) {
								$("select#SichtbarImModusEinfach").val("ja");
							} else {
								$("select#SichtbarImModusEinfach").val("nein");
							}
							$("select#SichtbarImModusEinfach").slider();
							$("select#SichtbarImModusEinfach").slider("refresh");
							
							//Artgruppe Aufbauen, wenn Hierarchiestufe == Art
							if ("{{Hierarchiestufe}}" === "Art") {
								ArtGruppeAufbauen(Feld.ArtGruppe);
							}
							
							//allfälligen Standardwert anzeigen
							//Standardwert ist Objekt, darin werden die Standardwerte aller Benutzer gespeichert
							//darum hier auslesen und setzen
							if (Feld.Standardwert) {
								Standardwert = Feld.Standardwert[localStorage.Username];
								if (Standardwert) {
									$("#Standardwert").val(Standardwert);
								}
							}
						}
					});
				}
			});

			//Code, der bei Verwendung von ajax nur beim ersten Aufruf der Seite laufen soll
			$(":jqmData(role='page')").on("pageinit", function () {
			
				erstelleSelectFeldFolgtNach();

				//jedes Feld aus Feldeigenschaften bei Änderung speichern
				$("#FeldEditForm").on("change", ".Feldeigenschaften", function () {
					var FeldWert, FeldName, AlterFeldWert;
					if (typeof localStorage.Username === "undefined" && !localStorage.Username) {
						pruefeAnmeldung();
					}
					FeldWert = this.value;
					FeldName = this.name;
					sessionStorage.FeldName = FeldName;
					AlterFeldWert = this.defaultValue;
					if ("{{User}}" === "ZentrenBdKt") {
						//Felder der Datenzentren dürfen nicht verändert werden
						//ausser Standardwert, dessen Änderung wird aber spezifisch abgehört
						$("#" + FeldName).val(AlterFeldWert);
						delete sessionStorage.FeldName;
						melde("Dies ist ein geschütztes Feld eines öffentlichen Datenzentrums<br><br>Sie können ein neues Feld erstellen");
					} else if (FeldName === "FeldName") {
						//Wenn eigener Feldname verändert wird, kontrollieren, dass er nicht schon verwendet wurde
						if ("{{FeldName}}") {
							//wenn ein alter Feldname existiert,
							//zählen, in wievielen Datensätzen das Feld verwendet wird
							$db = $.couch.db("evab");
							$db.view('evab/FeldSuche?key="' + localStorage.Username + '"&include_docs=true', {
								success: function (data) {
									var i, anzVorkommen, Datensatz, Feld, ds;
									anzVorkommen = 0;
									for (i in data.rows) {
										Datensatz = data.rows[i].doc; 
										Feld = Datensatz["{{FeldName}}"];
										if (Feld) {
											anzVorkommen += 1;
										}
									}
									if (anzVorkommen === 0) {
										//prüfen, ob der Feldname schon existiert
										//wenn ja: melden, zurückstellen
										//wenn nein: In SichtbareFelder nachführen und speichern
										prüfeFeldNamen();
									} else {
										ds = "Datensätzen";
										if (anzVorkommen === 1) {
											ds = "Datensatz";
										}
										$("#FeldName").val("{{FeldName}}");
										delete sessionStorage.FeldName;
										melde("Ändern abgebrochen:<br>Dieses Feld wird in " + anzVorkommen + " " + ds + " verwendet<br>Bereinigen Sie zuerst die Daten");
									}
								}
							});
						} else {
							//Wenn dies ein neues Feld ist
							//prüfen, ob der Feldname schon existiert
							//wenn ja: melden, zurückstellen
							//wenn nein: In SichtbareFelder nachführen und speichern
							prüfeFeldNamen();
						}
					} else if (FeldName === "Hierarchiestufe" && FeldWert === "Art") {
						speichereFeldeigenschaften();
						//Wenn die Hierarchiestufe zu Art geändert wird, muss das Feld für die Artgruppe aufgebaut werden
						ArtGruppeAufbauen();
					} else if (FeldName === "Hierarchiestufe" && FeldWert !== "Art") {
						speichereFeldeigenschaften();
						$db = $.couch.db("evab");
						$db.openDoc("{{id}}", {
							success: function (doc) {
								var letzteHierarchiestufe;
								letzteHierarchiestufe = doc.Hierarchiestufe;
								if (letzteHierarchiestufe === "Art") {
									//Wenn die Hierarchiestufe Art war und geändert wird, muss das Feld für die Artgruppe entfernt werden
									$("#Artgruppenliste").empty();
								}
							}
						});
					} else {
						speichereFeldeigenschaften();
					}
				});

				$("#FeldEditForm").on("change", "#FeldFolgtNach", function () {
					setzeReihenfolgeMitVorgänger(this.value);
					//Feldliste soll neu aufgebaut werden
					delete window.Feldliste;
					delete sessionStorage.Feldliste;
				});

				$("#UserFeldForm").on("change", "#Standardwert", function () {
					var Optionen, Feldwert;
					if (typeof localStorage.Username === "undefined" && !localStorage.Username) {
						pruefeAnmeldung();
					}
					Optionen = $("#Optionen").val();
					Feldwert = this.value;
					if (Optionen) {
						$db = $.couch.db("evab");
						$db.openDoc("{{id}}", {
							success: function (doc) {
								var LetzterFeldwert, Formularelement;
								if (doc.Standardwert) {
									if (doc.Standardwert[localStorage.Username]) {
										LetzterFeldwert = doc.Standardwert[localStorage.Username];
									} else {
										LetzterFeldwert = "";
									}
								} else {
									LetzterFeldwert = "";
								}
								Formularelement = doc.Formularelement;
								//Standardwert in Array verwandeln
								StandardwertOptionen = Feldwert.split(",");
								//Es sind Optionen erfasst. Standardwert muss eine oder mehrere dieser Optionen sein
								if (["multipleselect", "checkbox"].indexOf(Formularelement) > -1) {
									//alle Werte des Arrays müssen Optionen sein
									for (i in StandardwertOptionen) {
										if (Optionen.indexOf(StandardwertOptionen[i]) === -1) {
											//ein Wert ist keine Option, abbrechen
											$("#Standardwert").val(LetzterFeldwert);
											melde("Ändern abgebrochen:<br>Wählen Sie eine oder mehrere der Optionen");
											return;
										}
									}
									//alle Werte sind Optionen
									speichereStandardwert();
								} else if (["toggleswitch", "selectmenu", "radio"].indexOf(Formularelement) > -1) {
									//Array darf nur ein Element enthalten
									if (StandardwertOptionen.length > 1) {
										//Array enthält mehrere Optionen, nicht zulässig
										$("#Standardwert").val(LetzterFeldwert);
										melde("Ändern abgebrochen:<br>Wählen Sie eine einzige der Optionen");
									} else {
										//Array enthält eine einzige Option
										for (i in StandardwertOptionen) {
											if (Optionen.indexOf(StandardwertOptionen[i]) === -1) {
												//der Wert ist keine Option, abbrechen
												$("#Standardwert").val(LetzterFeldwert);
												melde("Ändern abgebrochen:<br>Wählen Sie eine oder mehrere der Optionen");
												return;
											}
										}
										//alle Werte sind Optionen
										speichereStandardwert();
									}
								} else {
									//Optionen sind erfasst, Feld braucht aber keine. Alle Werte akzeptieren
									speichereStandardwert();
								}
							}
						});
					} else {
						//Feld Optionen ist leer. Alle Werte akzeptieren
						speichereStandardwert();
					}
				});

				//Sichtbarkeit Modus hierarchisch speichern
				$("#SichtbarImModusHierarchisch").change(function () {
					speichereSichtbarModusHierarchisch(this.value);
				});

				//Sichtbarkeit Modus einfach speichern
				$("#SichtbarImModusEinfach").change(function () {
					speichereSichtbarModusEinfach(this.value);
				});

				//Code für den Feld-Löschen-Dialog
				$('#FeldEditFooter').on('click', '#LöschenDialogLink', function (event) {
					event.preventDefault();
					if (typeof localStorage.Username === "undefined" && !localStorage.Username) {
						pruefeAnmeldung();
					}
					if ("{{User}}" === "ZentrenBdKt") {
						melde("Dies ist ein Feld eines nationalen Datenzentrums<br><br>Es kann nicht gelöscht werden<br><br>Sie können es ausblenden");
					} else {
						$(this).simpledialog({
							'mode' : 'bool',
					    	'prompt' : 'Dieses Feld löschen?',
					    	'forceInput': 'false',
					    	'buttons' : {
							 	'ja': {
							      	click: function () {
							        	$('#dialogoutput').text('ja');
							        	if (!"{{FeldName}}") {
							        		//Ohne Feldname kann nicht kontrolliert werden, in wievielen Datensätzen das Feld vorkommt
							        		löscheFeld();
							        	} else {
											$db = $.couch.db("evab");
											//zählen, in wievielen Datensätzen das Feld verwendet wird
											$db.view('evab/FeldSuche?key="' + localStorage.Username + '"&include_docs=true', {
												success: function (data) {
													var i, anzVorkommen, Datensatz, Feld, ds;
													anzVorkommen = 0;
													for (i in data.rows) {
														Datensatz = data.rows[i].doc;
														Feld = Datensatz["{{FeldName}}"];
														if (Feld) {
															anzVorkommen += 1;
														}
													}
													if (anzVorkommen === 0) {
														löscheFeld();
													} else {
														ds = "Datensätzen";
														if (anzVorkommen === 1) {
															ds = "Datensatz";
														}
														melde("Löschen abgebrochen:<br>Dieses Feld wird in " + anzVorkommen + " " + ds + " verwendet<br>Bereinigen Sie zuerst die Daten");
													}
												}
											});
										}
					        		},
					        		icon: "delete",
					        		theme: "c"
					      		},
					      		'nein': {
					        		click: function () {
					          			$('#dialogoutput').text('nein');
					        		}
					      		}
					    	}
					  	})
					}
				});

				//Menu aufbauen
				$("#FeldEditHeader").on('click', "#MenuFeldEdit", function (event) {
					event.preventDefault();
					erstelleMenuFürFelder(this, "../../");
				});

				//BackButton steuern
				$("#FeldEditHeader").on('click', '#BackButton', function (event) {
					event.preventDefault();
					geheZurück();
				});

				//swipen steuern
				$("div:jqmData(role='page'):last").on("swipeleft", "#FeldContent", function () {
					geheZumNächstenFeld("{{id}}");
				});

				$("div:jqmData(role='page'):last").on("swiperight", "#FeldContent", function () {
					geheZumVorigenFeld("{{id}}");
				});

				/*$("body").on("swipeleft", "#FeldContent", function () {
					geheZumNächstenFeld("{{id}}");
				});

				$("body").on("swiperight", "#FeldContent", function () {
					geheZumVorigenFeld("{{id}}");
				});*/

				function prüfeFeldNamen() {
					var FeldNameAlt, FeldNameNeu, viewname;
					if (!localStorage.Username) {
						pruefeAnmeldung();
					}
					FeldNameAlt = "{{FeldName}}" || "";
					FeldNameNeu = $("#FeldName").val();
					viewname = 'evab/FeldNamen?key="' + FeldNameNeu + '"';
					$db = $.couch.db("evab");
					$db.view(viewname, {
						success: function (data) {
							var i, key, Feld;
							for (i in data.rows) {
								//kommt ein Feld mit diesem Namen schon vor?
								if (data.rows[i].value) {
									Feld = data.rows[i].value;
									//ist es ein eigenes oder ein offizielles?
									if (Feld.User === localStorage.Username || Feld.User === "ZentrenBdKt") {
										//ja > dieser Name ist nicht zulässig
										$("#FeldName").val(FeldNameAlt);
										delete sessionStorage.FeldName;
										setTimeout(function () { 
											$('#FeldName').focus(); 
										}, 50);  //need to use a timer so that .blur() can finish before you do .focus()
										melde("Dieser Feldname existiert schon<br>Wählen Sie einen anderen");
									} else {
										//Feldname ist bei diesem User neu, somit zulässig > speichern
										//und alten FeldNamen aus der Liste der anzuzeigenden Felder entfernen
										speichereSichtbarModusHierarchisch("ja"); 
										speichereFeldeigenschaften();
									}
								} else {
									//Feldname ist neu, somit zulässig > speichern
									//und alten FeldNamen aus der Liste der anzuzeigenden Felder entfernen
									speichereSichtbarModusHierarchisch("ja");
									speichereFeldeigenschaften();
								}
							}
						}
					});
				}

				function speichereSichtbarModusHierarchisch(SichtbarImModusHierarchisch) {
					var FeldName;
					if (!localStorage.Username) {
						pruefeAnmeldung();
					}
					FeldName = $("#FeldName").val();
					$db = $.couch.db("evab");
					$db.openDoc("{{id}}", {
						success: function (Feld) {
							var idx;
							if (SichtbarImModusHierarchisch === "ja") {
								Feld.SichtbarImModusHierarchisch.push(localStorage.Username);
							} else {
								idx = Feld.SichtbarImModusHierarchisch.indexOf(localStorage.Username);
								if (idx !== -1) {
									Feld.SichtbarImModusHierarchisch.splice(idx, 1);
								}
							}
							$db.saveDoc(Feld, {
								error: function () {
									melde("Fehler: nicht gespeichert");
								}
							});
						},
						error: function () {
							melde("Fehler: nicht gespeichert");
						}
					});
				}

				function speichereSichtbarModusEinfach(SichtbarImModusEinfach) {
					var FeldName;
					if (!localStorage.Username) {
						pruefeAnmeldung();
					}
					FeldName = $("#FeldName").val();
					$db = $.couch.db("evab");
					$db.openDoc("{{id}}", {
						success: function (Feld) {
							var idx;
							if (SichtbarImModusEinfach === "ja") {
								Feld.SichtbarImModusEinfach.push(localStorage.Username);
							} else {
								idx = Feld.SichtbarImModusEinfach.indexOf(localStorage.Username);
								if (idx !== -1) {
									Feld.SichtbarImModusEinfach.splice(idx, 1);
								}
							}
							$db.saveDoc(Feld, {
								error: function () {
									melde("Fehler: nicht gespeichert");
								}
							});
						},
						error: function () {
							melde("Fehler: nicht gespeichert");
						}
					});
				}
				
				function ArtGruppeAufbauen(ArtGruppenArrayIn) {
					var viewname;
					$db = $.couch.db("evab");
					$("select#ArtGruppe").empty();
					viewname = "evab/Artgruppen";
					$db.view(viewname, {
						success: function (data) {
							var i, ArtGruppe, ListItemContainer, listItem, ArtGruppenArray;
							ListItemContainer = "<fieldset data-role='controlgroup'>\n\t<legend>Artgruppen:</legend>";
							ArtGruppenArray = ArtGruppenArrayIn || [];
							for (i in data.rows) {
								ArtGruppe = data.rows[i].key;
								listItem = "<input type='checkbox' class='custom Feldeigenschaften' name='ArtGruppe' id='";
								listItem += ArtGruppe;
								listItem += "' value='";
								listItem += ArtGruppe;
								if (ArtGruppenArray.indexOf(ArtGruppe) !== -1) {
									listItem += "' checked='checked";
								}
								listItem += "'/>\n<label for='";
								listItem += ArtGruppe;
								listItem += "'>";
								listItem += ArtGruppe;
								listItem += "</label>";
								ListItemContainer += listItem;
							}
							ListItemContainer += "\n</fieldset>"
							$("#Artgruppenliste").html(ListItemContainer).trigger("create").trigger("refresh");
						}
					});
				}

				function löscheFeld() {
					var docId;
					docId = "{{id}}";
					$db = $.couch.db("evab");
					$db.openDoc(docId, {
						success: function (document) {
							$db.removeDoc(document, {
								success: function () {
									delete window.Feldliste;
									delete sessionStorage.Feldliste;
									window.open("../../FeldListe.html", target = '_self');
								},
								error: function () {
									melde("Fehler: nicht gelöscht");
								}
							});
						},
						error: function () {
							melde("Fehler: nicht gelöscht");
						}
					});
					return false;
				}


				//Öffnet das nächste Feld
				//nächstes des letzten => melden
				//erwartet die ID des aktuellen Datensatzes
				function geheZumNächstenFeld(IdAktuell) {
					if (window.Feldliste) {
						//Feldliste aus globaler Variable verwenden - muss nicht geparst werden
						geheZumNächstenFeld_2(IdAktuell);
					} else if (sessionStorage.Feldliste) {
						//sessionStorage verwenden
						Feldliste = JSON.parse(sessionStorage.Feldliste);
						geheZumNächstenFeld_2(IdAktuell);
					} else {
						if (!localStorage.Username) {
							pruefeAnmeldung();
						}
						$db = $.couch.db("evab");
						$db.view('evab/FeldListe', {
							success: function (data) {
								Feldliste = data;
								sessionStorage.Feldliste = data;
								geheZumNächstenFeld_2(IdAktuell);
							}
						});
					}
				}

				function geheZumNächstenFeld_2(IdAktuell) {
					var i, y, FeldIdAktuell, FeldIdNächstes, AnzFelder;
							AnzFelder = Feldliste.rows.length -1;  
							for (i in Feldliste.rows) {
								//alle Felder durchlaufen, aktuelles eigenes oder offizielles suchen
								Feld = Feldliste.rows[i].value;
								//vorsicht: Objekte zählen Elemente ab 1, Arrays ab 0!
								if (Feld.User === localStorage.Username || Feld.User === "ZentrenBdKt") {
									//Nur eigene und offizielle Felder berücksichtigen
									FeldIdAktuell = Feldliste.rows[i].value._id;
									if (FeldIdAktuell === IdAktuell) {
										//das ist das aktuelle Feld
										//von hier aus vorwärts das nächste eigene oder offizielle suchen
										if (i < AnzFelder) {
											//das aktuelle Feld ist nicht das letzte
											for (y = parseInt(i)+1; y <= AnzFelder; y++) {
												//alle verbleibenden Felder durchlaufen, eigenes suchen
												Feld = Feldliste.rows[y].value;
												//Nur eigene Felder und offizielle berücksichtigen
												if (Feld.User === localStorage.Username || Feld.User === "ZentrenBdKt") {
													//das ist das nächste eigene Feld > öffnen
													FeldIdNächstes = Feldliste.rows[parseInt(i)+1].value._id;
													window.open(FeldIdNächstes, target = "_self");
													//$.mobile.changePage(FeldIdNächstes);
												} else {
													if (y === AnzFelder) {
														//am letzten Feld angelangt und es ist kein eigenes
														melde("Das ist das letzte Feld");
													}
												}
											}
										} else {
											//das aktuelle Feld ist das letzte
											melde("Das ist das letzte Feld");
										}
									}
								}
							}
				}

				//Öffnet das vorige Feld
				//voriges des ersten => FeldListe
				//erwartet die ID des aktuellen Datensatzes
				function geheZumVorigenFeld(IdAktuell) {
					if (window.Feldliste) {
						//Feldliste aus globaler Variable verwenden - muss nicht geparst werden
						geheZumVorigenFeld_2(IdAktuell);
					} else if (sessionStorage.Feldliste) {
						//sessionStorage verwenden
						Feldliste = JSON.parse(sessionStorage.Feldliste);
						geheZumVorigenFeld_2(IdAktuell);
					} else {
						if (!localStorage.Username) {
							pruefeAnmeldung();
						}
						$db = $.couch.db("evab");
						$db.view('evab/FeldListe', {
							success: function (data) {
								Feldliste = data;
								sessionStorage.Feldliste = data;
								geheZumVorigenFeld_2(IdAktuell);
							}
						});
					}
				}

				function geheZumVorigenFeld_2(IdAktuell) {
					var i, y, FeldIdAktuell, FeldIdVoriges, AnzFelder;
					AnzFelder = Feldliste.rows.length -1;
					for (i in Feldliste.rows) {
						//alle Felder durchlaufen, aktuelles eigenes oder offizielles suchen
						Feld = Feldliste.rows[i].value;
						//vorsicht: Objekte zählen Elemente ab 1, Arrays ab 0!
						if (Feld.User === localStorage.Username || Feld.User === "ZentrenBdKt") {
							//Nur eigene und offizielle Felder berücksichtigen
							FeldIdAktuell = Feldliste.rows[i].value._id;
							if (FeldIdAktuell === IdAktuell) {
								//das ist das aktuelle Feld
								//von hier aus rückwärts das nächste eigene oder offizielle suchen
								if (i > 0) {
									//das aktuelle Feld ist nicht das erste 
									for (y = parseInt(i)-1; y >= 0; y--) {
										//alle vorhergehenden Felder durchlaufen, eigenes suchen
										Feld = Feldliste.rows[y].value;
										//Nur eigene Felder und offizielle berücksichtigen
										if (Feld.User === localStorage.Username || Feld.User === "ZentrenBdKt") {
											//das ist das nächstvorherige eigene Feld > öffnen
											FeldIdVoriges = Feldliste.rows[parseInt(i)-1].value._id;
											window.open(FeldIdVoriges, target = "_self");
											//$.mobile.changePage(FeldIdVoriges);
										} else {
											if (y === 1) {
												//am ersten Feld angelangt und es ist kein eigenes
												//wir gehen zur Feldliste
												geheZurück();
											}
										}
									}
								} else {
									//das aktuelle Feld ist das erste
									//wir gehen zur Feldliste
									geheZurück();	
								}
							}
						}
					}
				}

				//empfängt den Feldnamen des gewählten Vorgängers
				//ermittelt dessen Reihenfolge
				//sucht das nächste eigene Feld und setzt als Reihenfolge den Mittelwert der zwei Reihenfolgen
				//Wenn kein weiteres eigenes Feld kommt, wird als Reihenfolge der nächste um mindestens 1 höhere ganzzahlige Wert gesetzt
				function setzeReihenfolgeMitVorgänger(FeldNameVorgaenger) {
					var viewname;
					$db = $.couch.db("evab");
					viewname = 'evab/FeldListeFeldName?key="' + FeldNameVorgaenger + '"';
					$db.view(viewname, {
						success: function (data) {
							var ReihenfolgeVorgaenger;
							ReihenfolgeVorgaenger = data.rows[0].value.Reihenfolge;
							$("#Reihenfolge").val(Math.floor(ReihenfolgeVorgaenger + 1));
							speichereFeldeigenschaften();
						}
					});
				}

				function erstelleSelectFeldFolgtNach() {
					//generiert den html-Inhalt für Selectmenus
					//wird von erstelle_hArtEdit aufgerufen
					//Nur bei eigenen Feldern anzeigen
					if ("{{User}}" !== "ZentrenBdKt") {
						if (window.Feldliste) {
							//Feldliste aus globaler Variable verwenden - muss nicht geparst werden
							erstelleSelectFeldFolgtNach_2();
						} else if (sessionStorage.Feldliste) {
							//sessionStorage verwenden
							Feldliste = JSON.parse(sessionStorage.Feldliste);
							erstelleSelectFeldFolgtNach_2();
						} else {
							$db = $.couch.db("evab");
							$db.view("evab/FeldListe", {
								success: function (data) {
									Feldliste = data;
									sessionStorage.Feldliste = data;
									erstelleSelectFeldFolgtNach_2();
								}
							});
						}
					}
				}

				function erstelleSelectFeldFolgtNach_2() {
					var i, Feld, Optionen;
					Optionen = [];
					Optionen.push("");
					if (!localStorage.Username) {
						pruefeAnmeldung();
					}
					for (i in Feldliste.rows) {                 
						Feld = Feldliste.rows[i].value;
						//Liste aufbauen
						//Nur eigene Felder und offizielle
						if (Feld.User === localStorage.Username || Feld.User === "ZentrenBdKt") {
							Optionen.push(Feld.FeldName);
						}
					}
					HtmlContainer = generiereHtmlFuerSelectmenu("FeldFolgtNach", "Feld folgt nach:", "", Optionen, "SingleSelect");
					$("#FeldFolgtNachDiv").html(HtmlContainer).trigger("create").trigger("refresh");
				}

				function geheZurück() {
					if (sessionStorage.zurueck.slice(0, 6) === "Felder") {
						//direkt zurück, Feldliste auslassen
						window.open("../../" + sessionStorage.zurueck, target = "_self");
						
					} else {
						window.open("../../FeldListe.html", target = "_self");
					}
				}

				function speichereStandardwert() {
					if (!localStorage.Username) {
						pruefeAnmeldung();
					}
					$db = $.couch.db("evab");
					$db.openDoc("{{id}}", {
						success: function (Feld) {
							//Standardwert managen
							//Standardwert ist Objekt, in dem die Werte für jeden User gespeichert werden
							//darum manuell für diesen User updaten
							var StandardwertUserImFormular;
							StandardwertUserImFormular = $("#Standardwert").val();
							if (Feld.Standardwert) {
								if (StandardwertUserImFormular) {
									//neuen Standardwert setzen
									Feld.Standardwert[localStorage.Username] = StandardwertUserImFormular;
								} else {
									//Standardwert ist leer
									if (Feld.Standardwert[localStorage.Username]) {
										//bisherigen Standardwert löschen
										delete Feld.Standardwert[localStorage.Username];
									}
								}
							} else {
								//Bisher gab es noch keinen Standardwert
								if (StandardwertUserImFormular) {
									//Objekt für Standardwert schaffen und neuen Wert setzen
									Feld.Standardwert = {};
									Feld.Standardwert[localStorage.Username] = StandardwertUserImFormular;
								}
							}
							$db.saveDoc(Feld, {
								error: function () {
									melde("Fehler: Feld nicht gespeichert");
								}
							});
						},
						error: function () {
							melde("Fehler: Feld nicht gespeichert");
						}
					});
				}

				/*function speichereFeldeigenschaften(Feldname, Feldwert) {
					$db = $.couch.db("evab");
					//Bestehendes Dokument öffnen
					$db.openDoc("{{id}}", {
						success: function (Feld) {
							var Formularfelder = $("#FeldEditForm").serializeObjectNull();
							//Felder mit Arrays: Kommagetrennte Werte in Arrays verwandeln. Plötzlich nicht mehr nötig??!!
							if (Feldname === "Optionen") {
								Feldwert = Feldwert.split(",");
							}
							//Wenn Beschriftung fehlt und Name existiert: Beschriftung = Name
							if (!Formularfelder.FeldBeschriftung && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
								Formularfelder.FeldBeschriftung = Formularfelder.FeldName;
							}
							//Es braucht eine Reihenfolge
							if (!Formularfelder.Reihenfolge && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
								Formularfelder.Reihenfolge = 1;
							}
							//Es braucht einen Feldtyp
							if (!Formularfelder.Formularelement && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
								Formularfelder.Formularelement = "textinput";
								Formularfelder.InputTyp = "text";
							}
							//Wenn Feldtyp von textinput weg geändert wurde, sollte InputTyp entfernt werden
							if (Formularfelder.Formularelement !== "textinput" && Formularfelder.InputTyp) {
								delete Formularfelder.InputTyp;
								$("#{{InputTyp}}").prop("checked",false).checkboxradio("refresh");
							}
							//Wenn Feldtyp gesetzt wurde, muss ein InputTyp existieren. Wenn er nicht gesetzt wurde, text setzen
							if (Formularfelder.Formularelement === "textinput" && !Formularfelder.InputTyp) {
								Formularfelder.InputTyp = "text";
							}
							if (Feldwert) {
								Feld[Feldname] = Feldwert;
							} else if (Feld[Feldname]) {
								delete Feld[Feldname]
							}
							//alles speichern
							$db.saveDoc(Feld, {
								error: function () {
									melde("Fehler: Feld nicht gespeichert");
								}
							});
						}
					});
				}*/

				function speichereFeldeigenschaften() {
					$db = $.couch.db("evab");
					$db.openDoc("{{id}}", {
						success: function (Feld) {
							var Formularfelder;
							Formularfelder = $("#FeldEditForm").serializeObjectNull();
							//Felder mit Arrays: Kommagetrennte Werte in Arrays verwandeln. Plötzlich nicht mehr nötig??!!
							if (Formularfelder.Optionen) {
								Formularfelder.Optionen = Formularfelder.Optionen.split(",");
							}
							/*if (Feld.ArtGruppe) {
								Feld.ArtGruppe = Feld.ArtGruppe.split(", ");
							}*/
							//Wenn Beschriftung fehlt und Name existiert: Beschriftung = Name
							if (!Formularfelder.FeldBeschriftung && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
								Formularfelder.FeldBeschriftung = Formularfelder.FeldName;
								//Feldliste soll neu aufgebaut werden
								delete window.Feldliste;
								delete sessionStorage.Feldliste;
							}
							//Es braucht eine Reihenfolge
							if (!Formularfelder.Reihenfolge && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
								Formularfelder.Reihenfolge = 1;
								//Feldliste soll neu aufgebaut werden
								delete window.Feldliste;
								delete sessionStorage.Feldliste;
							}
							//Es braucht einen Feldtyp
							if (!Formularfelder.Formularelement && Formularfelder.Hierarchiestufe && Formularfelder.FeldName) {
								Formularfelder.Formularelement = "textinput";
								Formularfelder.InputTyp = "text";
							}
							//Wenn Feldtyp von textinput weg geändert wurde, sollte InputTyp entfernt werden
							if (Formularfelder.Formularelement !== "textinput" && Formularfelder.InputTyp) {
								delete Formularfelder.InputTyp;
								$("#{{InputTyp}}").prop("checked",false).checkboxradio("refresh");
							}
							//Wenn Feldtyp gesetzt wurde, muss ein InputTyp existieren. Wenn er nicht gesetzt wurde, text setzen
							if (Formularfelder.Formularelement === "textinput" && !Formularfelder.InputTyp) {
								Formularfelder.InputTyp = "text";
							}
							//Formularfelder in Dokument schreiben
							for (i in Formularfelder) {
								if (Formularfelder[i]) {
									if (i === "Reihenfolge") {
										//Zahl wird sonst in Text verwandelt und falsch sortiert
										Feld[i] = parseInt(Formularfelder[i]);
									} else {
										Feld[i] = Formularfelder[i];
									}
								} else {
									//leere Felder entfernen, damit werden auch soeben gelöschte Felder entfernt
									delete Feld[i];
								}
							}
							$db.saveDoc(Feld, {
								success: function () {
									//Wenn FeldName oder FeldBeschreibung geändert wird: Feldliste soll neu aufbauen
									if (sessionStorage.FeldName === "FeldName" || sessionStorage.FeldName === "FeldBeschreibung" || sessionStorage.FeldName === "Reihenfolge") {
										delete window.Feldliste;
										delete sessionStorage.Feldliste;
									}
									delete sessionStorage.FeldName;
								},
								error: function () {
									melde("Fehler: Feld nicht gespeichert");
								}
							});
						},
						error: function () {
							melde("Fehler: Feld nicht gespeichert");
						}
					});
				}
			});
		</script>
	</div>
  </body>
</html>
